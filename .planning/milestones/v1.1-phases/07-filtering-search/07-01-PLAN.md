---
phase: 07-filtering-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/templates/results.html
  - app/static/src/input.css
  - tailwind.config.js
  - app/static/dist/style.css
autonomous: true
requirements:
  - FILTER-01
  - FILTER-02
  - FILTER-03
  - FILTER-04

must_haves:
  truths:
    - "Clicking a verdict button in the filter bar shows only IOC cards with that verdict"
    - "IOC type pills only appear for types present in current results"
    - "Typing in the search box hides cards whose IOC value does not match the query"
    - "Filter bar sticks to top of viewport when scrolling"
    - "Dashboard verdict badges act as filter shortcuts — clicking one applies the verdict filter"
    - "All three filter axes (verdict, type, search) combine — a card must pass all three to be visible"
  artifacts:
    - path: "app/templates/results.html"
      provides: "Alpine x-data wrapper, filter bar HTML, x-show on cards, dashboard @click"
      contains: "x-data"
    - path: "app/static/src/input.css"
      provides: "Filter bar, filter button, filter pill, sticky, and search input styles"
      contains: "filter-bar-wrapper"
    - path: "tailwind.config.js"
      provides: "Safelist entries for dynamic filter CSS class names"
      contains: "filter-btn--active"
    - path: "app/static/dist/style.css"
      provides: "Regenerated CSS including filter styles"
  key_links:
    - from: "app/templates/results.html"
      to: "Alpine x-data state"
      via: "x-show=\"cardVisible($el)\" on each .ioc-card"
      pattern: "x-show.*cardVisible"
    - from: "app/templates/results.html"
      to: "Alpine x-data state"
      via: "@click on verdict buttons sets activeVerdict"
      pattern: "@click.*activeVerdict"
    - from: "app/templates/results.html"
      to: "Alpine x-data state"
      via: "x-model on search input binds searchQuery"
      pattern: "x-model.*searchQuery"
    - from: "app/templates/results.html"
      to: "app/static/src/input.css"
      via: "filter-bar-wrapper class for sticky positioning"
      pattern: "filter-bar-wrapper"
---

<objective>
Build the complete filter bar UI with Alpine.js reactive filtering on the results page.

Purpose: Enable analysts to instantly narrow down 50+ IOC results by verdict, IOC type, or text search — the core UX improvement of Phase 7.

Output: Results page with working Alpine filter bar (verdict buttons, type pills, search input), sticky positioning, dashboard badge click-to-filter, and all filter axes combining correctly.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-filtering-search/07-RESEARCH.md
@app/templates/results.html
@app/templates/base.html
@app/static/main.js
@app/static/src/input.css
@tailwind.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Alpine filter component and filter bar HTML to results.html</name>
  <files>app/templates/results.html, tailwind.config.js</files>
  <action>
Restructure results.html to wrap the verdict dashboard, filter bar, and cards grid in a single Alpine x-data component. This is the critical structural change that enables all filtering.

**Step 1: Add Alpine x-data wrapper**

Inside the `{% else %}` block (after the no-results check, line ~51), wrap everything from the verdict dashboard through the cards grid in a single div with Alpine state:

```html
<div x-data="{
  activeVerdict: 'all',
  activeType: 'all',
  searchQuery: '',
  cardVisible(card) {
    var v = this.activeVerdict === 'all' || card.dataset.verdict === this.activeVerdict;
    var t = this.activeType === 'all' || card.dataset.iocType === this.activeType;
    var s = this.searchQuery === '' || card.dataset.iocValue.toLowerCase().includes(this.searchQuery.toLowerCase());
    return v && t && s;
  }
}" id="filter-root">
```

Close this div after the `</div>` that closes `.ioc-cards-grid`. The Alpine component MUST encompass both the dashboard and the grid so that `activeVerdict` state is shared.

**Step 2: Make dashboard badges clickable filter shortcuts (FILTER-04)**

On each `.verdict-dashboard-badge` span, add Alpine click handler and cursor styles:

```html
<span class="verdict-dashboard-badge"
      data-verdict="malicious"
      @click="activeVerdict = activeVerdict === 'malicious' ? 'all' : 'malicious'"
      style="cursor: pointer;"
      role="button"
      tabindex="0"
>
```

Apply the same toggle pattern to all four badges (malicious, suspicious, clean, no_data). Clicking once activates the filter; clicking again resets to "all". Add `role="button"` and `tabindex="0"` for accessibility.

**Step 3: Add filter bar HTML (FILTER-01, FILTER-02, FILTER-03)**

Between the verdict dashboard (or the progress bar if no dashboard) and the cards grid, add the filter bar:

```html
<div class="filter-bar-wrapper">
  <div class="filter-bar">
    {# Verdict filter buttons (FILTER-01) #}
    <div class="filter-verdict-buttons">
      <button type="button" class="filter-btn" :class="{ 'filter-btn--active': activeVerdict === 'all' }" @click="activeVerdict = 'all'">All</button>
      <button type="button" class="filter-btn filter-btn--malicious" :class="{ 'filter-btn--active': activeVerdict === 'malicious' }" @click="activeVerdict = activeVerdict === 'malicious' ? 'all' : 'malicious'">Malicious</button>
      <button type="button" class="filter-btn filter-btn--suspicious" :class="{ 'filter-btn--active': activeVerdict === 'suspicious' }" @click="activeVerdict = activeVerdict === 'suspicious' ? 'all' : 'suspicious'">Suspicious</button>
      <button type="button" class="filter-btn filter-btn--clean" :class="{ 'filter-btn--active': activeVerdict === 'clean' }" @click="activeVerdict = activeVerdict === 'clean' ? 'all' : 'clean'">Clean</button>
      <button type="button" class="filter-btn filter-btn--no_data" :class="{ 'filter-btn--active': activeVerdict === 'no_data' }" @click="activeVerdict = activeVerdict === 'no_data' ? 'all' : 'no_data'">No Data</button>
    </div>

    {# IOC type pills — only rendered for types present in results (FILTER-02) #}
    <div class="filter-type-pills">
      <button type="button" class="filter-pill" :class="{ 'filter-pill--active': activeType === 'all' }" @click="activeType = 'all'">All Types</button>
      {% for ioc_type in grouped.keys() %}
      <button type="button" class="filter-pill filter-pill--{{ ioc_type }}" :class="{ 'filter-pill--active': activeType === '{{ ioc_type }}' }" @click="activeType = activeType === '{{ ioc_type }}' ? 'all' : '{{ ioc_type }}'">{{ ioc_type | upper }}</button>
      {% endfor %}
    </div>

    {# Text search (FILTER-03) #}
    <div class="filter-search">
      <input type="search" x-model="searchQuery" placeholder="Search IOCs..." class="filter-search-input" autocomplete="off" />
    </div>
  </div>
</div>
```

**Step 4: Add x-show to each IOC card**

On each `.ioc-card` div, add the `x-show` directive:

```html
<div class="ioc-card" data-ioc-value="{{ ioc.value }}" data-ioc-type="{{ ioc.type.value }}" data-verdict="no_data" x-show="cardVisible($el)">
```

CRITICAL: Use `x-show` (NOT `x-if`). `x-show` adds `display:none` but keeps the element in the DOM. The vanilla JS enrichment polling loop uses `querySelector` to find cards by `data-ioc-value` — `x-if` would remove them from the DOM and break enrichment.

**Step 5: Add filter bar rendering in both modes**

The filter bar must render in BOTH online and offline modes. In offline mode, all cards have `data-verdict="no_data"`, so verdict filtering degrades gracefully — "All" and "No Data" show cards, other verdicts show nothing. The type pills and text search are fully useful in offline mode. The verdict dashboard is conditional (online only), but the filter bar is NOT conditional.

**Step 6: Update tailwind.config.js safelist**

Add all dynamic filter class names that appear only in Alpine `:class` bindings (Tailwind may not detect them):

```javascript
// Dynamic Alpine filter classes (Phase 7)
"filter-btn--active",
"filter-pill--active",
"filter-pill--ipv4",
"filter-pill--ipv6",
"filter-pill--domain",
"filter-pill--url",
"filter-pill--md5",
"filter-pill--sha1",
"filter-pill--sha256",
"filter-pill--cve",
```

Add these entries to the existing safelist array in `tailwind.config.js`.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && python -c "
from app import create_app
app = create_app({'TESTING': True, 'WTF_CSRF_ENABLED': False, 'SERVER_NAME': 'localhost'})
with app.test_client() as c:
    # Submit offline analysis to get results page
    resp = c.post('/analyze', data={'ioc_text': '8.8.8.8 evil.com abc123def456abc123def456abc123de', 'mode': 'offline'})
    html = resp.data.decode()
    # Verify Alpine component
    assert 'x-data' in html, 'Missing x-data'
    assert 'cardVisible' in html, 'Missing cardVisible function'
    assert 'x-show' in html, 'Missing x-show on cards'
    # Verify filter bar
    assert 'filter-bar-wrapper' in html, 'Missing filter bar wrapper'
    assert 'filter-btn' in html, 'Missing filter buttons'
    assert 'filter-pill' in html, 'Missing type pills'
    assert 'filter-search-input' in html, 'Missing search input'
    assert 'x-model' in html, 'Missing x-model on search'
    # Verify type pills are present only for types in results
    assert 'filter-pill--ipv4' in html, 'Missing ipv4 pill'
    assert 'filter-pill--domain' in html, 'Missing domain pill'
    # Verify x-show on cards
    assert 'x-show=\"cardVisible' in html, 'Missing x-show cardVisible'
    print('All HTML assertions passed')
"</automated>
    <manual>Open results page in browser, verify filter bar appears with verdict buttons, type pills, and search input</manual>
  </verify>
  <done>Results template has Alpine x-data wrapper, filter bar with verdict buttons + type pills + search input, x-show on cards, dashboard badges with @click handlers, and tailwind.config.js safelist updated with all dynamic filter classes</done>
</task>

<task type="auto">
  <name>Task 2: Add filter bar CSS styles and regenerate Tailwind CSS</name>
  <files>app/static/src/input.css, app/static/dist/style.css</files>
  <action>
Add all CSS styles for the filter bar, filter buttons, filter pills, search input, and sticky positioning to `app/static/src/input.css`. Then regenerate the compiled CSS.

**Step 1: Add filter bar styles inside the `@layer components` block**

Add the following styles after the `.verdict-dashboard-count` block and before the `/* ---- IOC Cards Grid ---- */` comment:

```css
/* ---- Filter Bar ---- */

.filter-bar-wrapper {
    position: sticky;
    top: 0;
    z-index: 10;
    background-color: var(--bg-primary);
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border);
    margin-bottom: 1rem;
}

.filter-bar {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-verdict-buttons {
    display: flex;
    gap: 0.35rem;
    flex-wrap: wrap;
}

.filter-btn {
    display: inline-flex;
    align-items: center;
    padding: 0.3rem 0.65rem;
    border-radius: 2rem;
    border: 1px solid var(--border);
    background-color: var(--bg-secondary);
    color: var(--text-secondary);
    font-family: var(--font-ui);
    font-size: 0.78rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
}

.filter-btn:hover {
    border-color: var(--border-hover);
    color: var(--text-primary);
}

.filter-btn--active {
    background-color: var(--bg-tertiary);
    border-color: var(--text-secondary);
    color: var(--text-primary);
    font-weight: 600;
}

/* Verdict-colored active states for filter buttons */
.filter-btn--malicious.filter-btn--active {
    border-color: var(--verdict-malicious);
    color: var(--verdict-malicious);
    background-color: rgba(248, 81, 73, 0.15);
}

.filter-btn--suspicious.filter-btn--active {
    border-color: var(--verdict-suspicious);
    color: var(--verdict-suspicious);
    background-color: rgba(245, 158, 11, 0.15);
}

.filter-btn--clean.filter-btn--active {
    border-color: var(--verdict-clean);
    color: var(--verdict-clean);
    background-color: rgba(63, 185, 80, 0.15);
}

.filter-btn--no_data.filter-btn--active {
    border-color: var(--verdict-no-data);
    color: var(--verdict-no-data);
    background-color: rgba(139, 148, 158, 0.15);
}

/* ---- IOC Type Filter Pills ---- */

.filter-type-pills {
    display: flex;
    gap: 0.35rem;
    flex-wrap: wrap;
}

.filter-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.2rem 0.5rem;
    border-radius: 2rem;
    border: 1px solid var(--border);
    background-color: var(--bg-secondary);
    color: var(--text-secondary);
    font-family: var(--font-mono);
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    cursor: pointer;
    transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
}

.filter-pill:hover {
    border-color: var(--border-hover);
    color: var(--text-primary);
}

.filter-pill--active {
    background-color: var(--bg-tertiary);
    border-color: var(--text-secondary);
    color: var(--text-primary);
}

/* Type-colored active states for filter pills */
.filter-pill--ipv4.filter-pill--active   { border-color: var(--accent-ipv4);   color: var(--accent-ipv4); }
.filter-pill--ipv6.filter-pill--active   { border-color: var(--accent-ipv6);   color: var(--accent-ipv6); }
.filter-pill--domain.filter-pill--active { border-color: var(--accent-domain); color: var(--accent-domain); }
.filter-pill--url.filter-pill--active    { border-color: var(--accent-url);    color: var(--accent-url); }
.filter-pill--md5.filter-pill--active    { border-color: var(--accent-md5);    color: var(--accent-md5); }
.filter-pill--sha1.filter-pill--active   { border-color: var(--accent-sha1);   color: var(--accent-sha1); }
.filter-pill--sha256.filter-pill--active { border-color: var(--accent-sha256); color: var(--accent-sha256); }
.filter-pill--cve.filter-pill--active    { border-color: var(--accent-cve);    color: var(--accent-cve); }

/* ---- Filter Search Input ---- */

.filter-search {
    display: flex;
}

.filter-search-input {
    width: 100%;
    max-width: 300px;
    padding: 0.35rem 0.75rem;
    background-color: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 0.8rem;
    transition: border-color 0.15s ease;
}

.filter-search-input:focus {
    outline: none;
    border-color: var(--accent-ipv4);
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

.filter-search-input::placeholder {
    color: var(--text-secondary);
    opacity: 0.6;
}

/* ---- No Filter Results Message ---- */

.filter-no-results {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
}
```

**Step 2: Add responsive filter bar styles**

Inside the existing `@media (max-width: 640px)` block, add:

```css
.filter-bar-wrapper {
    padding: 0.5rem 0;
}

.filter-search-input {
    max-width: 100%;
}
```

**Step 3: Update dashboard badge cursor for click-to-filter**

Change the existing `.verdict-dashboard-badge` `cursor: default;` to `cursor: pointer;` (since badges are now clickable filter shortcuts).

**Step 4: Regenerate CSS**

Run `make css` to regenerate `app/static/dist/style.css` with the new filter styles. Verify the output file contains the filter classes.

IMPORTANT: The CSS must be committed (dist/style.css is tracked in git per Phase 6 decisions).
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && make css && grep -c "filter-bar-wrapper" app/static/dist/style.css && grep -c "filter-btn--active" app/static/dist/style.css && grep -c "filter-pill--active" app/static/dist/style.css && grep -c "filter-search-input" app/static/dist/style.css && grep -c "position: sticky" app/static/dist/style.css && echo "CSS verification passed"</automated>
    <manual>Open results page in browser — filter bar should be visible, properly styled, and stick to the top when scrolling</manual>
  </verify>
  <done>Filter bar CSS is complete with sticky positioning, verdict button active states (verdict-colored), type pill active states (type-colored), search input, and responsive breakpoint. Generated CSS includes all filter styles.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x -q` — all existing tests pass (no regressions)
2. `make css` succeeds and dist/style.css contains filter classes
3. `grep 'x-data' app/templates/results.html` returns a match
4. `grep 'x-show' app/templates/results.html` returns matches (one per card)
5. `grep 'filter-btn--active' tailwind.config.js` returns a match (safelist entry)
6. Results page renders in browser with visible filter bar in both offline and online modes
</verification>

<success_criteria>
- Filter bar renders with 5 verdict buttons (All, Malicious, Suspicious, Clean, No Data)
- Type pills render only for IOC types present in the results
- Search input is visible and bound to Alpine state
- Filter bar has sticky positioning (CSS `position: sticky; top: 0`)
- Dashboard verdict badges are clickable (set activeVerdict on click)
- Cards have `x-show="cardVisible($el)"` — Alpine shows/hides based on filter state
- All three filter axes combine (verdict AND type AND search)
- All existing tests pass without regression
- Generated CSS includes all filter styles
</success_criteria>

<output>
After completion, create `.planning/phases/07-filtering-search/07-01-SUMMARY.md`
</output>
