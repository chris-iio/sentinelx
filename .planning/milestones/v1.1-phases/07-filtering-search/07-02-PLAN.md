---
phase: 07-filtering-search
plan: 02
type: execute
wave: 2
depends_on:
  - "07-01"
files_modified:
  - tests/e2e/test_results_page.py
  - tests/e2e/pages/results_page.py
autonomous: false
requirements:
  - FILTER-01
  - FILTER-02
  - FILTER-03
  - FILTER-04

must_haves:
  truths:
    - "E2E test confirms clicking Malicious filter button hides non-malicious cards"
    - "E2E test confirms IOC type pills match types present in results"
    - "E2E test confirms text search filters cards by IOC value substring"
    - "E2E test confirms filter bar has sticky positioning"
    - "E2E test confirms dashboard badge click applies verdict filter"
    - "All existing E2E tests pass with no regressions"
  artifacts:
    - path: "tests/e2e/test_results_page.py"
      provides: "E2E tests for filter bar interactions"
      contains: "test_filter"
    - path: "tests/e2e/pages/results_page.py"
      provides: "Page object model with filter bar selectors"
      contains: "filter"
  key_links:
    - from: "tests/e2e/test_results_page.py"
      to: "tests/e2e/pages/results_page.py"
      via: "Page object model pattern"
      pattern: "ResultsPage"
    - from: "tests/e2e/pages/results_page.py"
      to: "app/templates/results.html"
      via: "CSS selectors targeting filter elements"
      pattern: "filter-bar"
---

<objective>
Add E2E tests verifying all filter interactions work correctly in the browser, then perform human visual verification.

Purpose: Ensure the Alpine.js filtering system works end-to-end in a real browser context — unit tests cannot verify Alpine reactivity, DOM visibility, or sticky positioning.

Output: E2E tests covering all 4 FILTER requirements, plus human-verified visual confirmation.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-filtering-search/07-RESEARCH.md
@.planning/phases/07-filtering-search/07-01-SUMMARY.md
@app/templates/results.html
@tests/e2e/test_results_page.py
@tests/e2e/pages/results_page.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add E2E tests for filter bar interactions</name>
  <files>tests/e2e/test_results_page.py, tests/e2e/pages/results_page.py</files>
  <action>
Update the page object model and add E2E tests for all filter interactions. The existing test file already has tests for the card layout from Phase 6 — add filter tests alongside them.

**Step 1: Update ResultsPage POM with filter selectors**

Add the following properties/methods to the `ResultsPage` class in `tests/e2e/pages/results_page.py`:

```python
@property
def filter_bar(self):
    return self.page.locator(".filter-bar-wrapper")

@property
def filter_verdict_buttons(self):
    return self.page.locator(".filter-verdict-buttons .filter-btn")

def filter_by_verdict(self, verdict):
    """Click the filter button for the given verdict (e.g., 'malicious', 'all')."""
    self.page.locator(f".filter-btn").filter(has_text=verdict.replace("_", " ").title()).click()

@property
def filter_type_pills(self):
    return self.page.locator(".filter-type-pills .filter-pill")

def filter_by_type(self, ioc_type):
    """Click the type pill for the given IOC type (e.g., 'ipv4')."""
    self.page.locator(f".filter-pill").filter(has_text=ioc_type.upper()).click()

@property
def search_input(self):
    return self.page.locator(".filter-search-input")

def search(self, query):
    """Type a search query into the filter search input."""
    self.search_input.fill(query)

@property
def visible_cards(self):
    """Return locator for IOC cards that are currently visible (not hidden by x-show)."""
    return self.page.locator(".ioc-card:visible")

@property
def hidden_cards(self):
    """Return locator for IOC cards that are currently hidden by x-show."""
    return self.page.locator(".ioc-card:not(:visible)")

@property
def dashboard_badges(self):
    return self.page.locator(".verdict-dashboard-badge")

def click_dashboard_badge(self, verdict):
    """Click the dashboard badge for the given verdict."""
    self.page.locator(f".verdict-dashboard-badge[data-verdict='{verdict}']").click()
```

**Step 2: Add filter E2E tests**

Add the following test functions to `tests/e2e/test_results_page.py`. These tests use offline mode (no API key needed) to submit text containing multiple IOC types, then verify filter behavior.

Test input text should contain multiple IOC types for meaningful filtering:
`"8.8.8.8 1.1.1.1 evil.com test.org abc123def456abc123def456abc123de"`
This gives ipv4 (2), domain (2), and md5 (1) — 5 IOCs across 3 types.

**Test: Filter bar renders with correct elements (FILTER-01, FILTER-02, FILTER-03)**
- Navigate to results page with multi-type IOCs
- Assert filter bar is visible
- Assert 5 verdict buttons exist (All, Malicious, Suspicious, Clean, No Data)
- Assert "All Types" pill exists plus pills only for types in the results (ipv4, domain, md5)
- Assert search input is visible

**Test: Verdict filter hides non-matching cards (FILTER-01)**
- In offline mode all cards have verdict="no_data"
- Click "No Data" button — all cards should remain visible
- Click "Malicious" button — all cards should be hidden (none are malicious)
- Click "All" button — all cards visible again

**Test: Type filter shows only matching type (FILTER-02)**
- Click "IPV4" pill — only ipv4 cards visible
- Click "DOMAIN" pill — only domain cards visible
- Click "All Types" — all cards visible

**Test: Text search filters by IOC value (FILTER-03)**
- Type "8.8" in search — only 8.8.8.8 card visible
- Clear search — all cards visible
- Type "evil" — only evil.com card visible

**Test: Combined filters work together (FILTER-01 + FILTER-02 + FILTER-03)**
- Type "8" in search, then click "IPV4" type pill
- Should show only ipv4 cards containing "8"

**Test: Filter bar has sticky positioning (FILTER-04)**
- Verify filter bar has `position: sticky` CSS property (use `evaluate` to check computed style)

Note: Dashboard badge click-to-filter tests require online mode which needs a VT API key. Skip these with a note unless the test environment supports them. The filter bar's verdict button test covers the same Alpine state mechanism.

All tests should follow the existing test file patterns: `@pytest.mark.parametrize("browser_type", ["chromium"])` if that pattern exists, or use the existing fixture setup.

IMPORTANT: Do NOT modify any existing tests. Only add new test functions.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && python -m pytest tests/e2e/test_results_page.py -x -q -k "filter" --timeout=60 2>&1 | tail -20</automated>
    <manual>Review test output to confirm all filter tests pass</manual>
  </verify>
  <done>E2E tests cover: filter bar rendering, verdict filtering, type pill filtering, text search, combined filters, and sticky positioning. All new tests pass. All existing tests pass without regression.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of filter bar in browser</name>
  <action>Human verifies the complete Phase 7 filtering system works correctly in the browser.</action>
  <what-built>
Complete Phase 7 filtering system: Alpine.js reactive filter bar with verdict buttons, IOC type pills, text search input, sticky positioning, and dashboard badge click-to-filter. All E2E tests passing.
  </what-built>
  <verify>Human visual verification — see steps below</verify>
  <done>User confirms filtering works correctly in browser</done>
  <how-to-verify>
1. Start the app: `cd /home/chris/projects/sentinelx && python run.py`
2. Open http://127.0.0.1:5000 in your browser
3. Paste the following text and submit in OFFLINE mode:
   ```
   8.8.8.8 1.1.1.1 evil.com test.org abc123def456abc123def456abc123de
   ```
4. Verify filter bar appears below the header with:
   - 5 verdict buttons: All | Malicious | Suspicious | Clean | No Data
   - Type pills: All Types | IPV4 | DOMAIN | MD5 (only these three — no phantom pills)
   - Search input with placeholder "Search IOCs..."
5. Click "No Data" verdict button — all 5 cards should remain visible (all are no_data in offline)
6. Click "Malicious" button — all cards should disappear
7. Click "All" button — all 5 cards visible again
8. Click "IPV4" type pill — only 2 cards visible (8.8.8.8 and 1.1.1.1)
9. Click "All Types" — all 5 cards visible
10. Type "evil" in search — only evil.com card visible
11. Clear search — all cards visible
12. Scroll down (if page is long enough) — filter bar should stick to top
13. (Optional, requires VT API key) Submit in ONLINE mode, verify dashboard badges are clickable and apply verdict filter
14. Run: `python -m pytest tests/ -x -q` — confirm all tests pass
  </how-to-verify>
  <resume-signal>Type "approved" if filtering works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x -q` — all tests pass (unit + E2E)
2. `python -m pytest tests/e2e/ -x -q -k "filter"` — all filter E2E tests pass
3. Human verification of filter interactions in browser
</verification>

<success_criteria>
- E2E tests exist covering FILTER-01 (verdict), FILTER-02 (type pills), FILTER-03 (search), FILTER-04 (sticky)
- All new E2E tests pass
- All existing tests pass without regression
- Human verifies filter bar works correctly in browser
- Filter bar appears in both offline and online modes
</success_criteria>

<output>
After completion, create `.planning/phases/07-filtering-search/07-02-SUMMARY.md`
</output>
