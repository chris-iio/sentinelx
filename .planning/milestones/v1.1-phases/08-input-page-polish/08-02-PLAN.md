---
phase: 08-input-page-polish
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - tests/e2e/pages/index_page.py
  - tests/e2e/test_homepage.py
  - tests/e2e/test_ui_controls.py
autonomous: false
requirements: [INPUT-01, INPUT-02, INPUT-03]

must_haves:
  truths:
    - "E2E tests verify toggle switch replaces dropdown (INPUT-01)"
    - "E2E tests verify paste feedback appears with character count (INPUT-02)"
    - "E2E tests verify submit button label changes on mode toggle (INPUT-03)"
    - "All existing E2E tests pass (no regressions from select removal)"
    - "Human confirms toggle switch looks and works correctly in browser"
  artifacts:
    - path: "tests/e2e/pages/index_page.py"
      provides: "Updated IndexPage POM with mode_toggle locators replacing mode_select"
      contains: "mode_toggle"
    - path: "tests/e2e/test_homepage.py"
      provides: "Updated homepage tests referencing toggle widget instead of select"
      contains: "mode_toggle"
    - path: "tests/e2e/test_ui_controls.py"
      provides: "Updated mode toggle tests using click instead of select_option, plus new tests for paste feedback and reactive submit label"
      contains: "paste_feedback"
  key_links:
    - from: "tests/e2e/pages/index_page.py"
      to: "app/templates/index.html"
      via: "Locators target #mode-toggle-btn, #mode-toggle-widget, #mode-input, #paste-feedback"
      pattern: "mode-toggle"
    - from: "tests/e2e/test_ui_controls.py"
      to: "tests/e2e/pages/index_page.py"
      via: "Tests use IndexPage POM methods toggle_mode(), expect_mode()"
      pattern: "toggle_mode"
---

<objective>
Update all E2E tests and the IndexPage POM to work with the new toggle switch (replacing the old select dropdown), add new E2E tests for paste feedback and reactive submit label, and visually verify the complete input page in a browser.

Purpose: Ensure all 3 INPUT requirements have automated E2E coverage and human-verified visual correctness.
Output: Updated POM and test files with passing E2E suite, human-approved visual verification.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-input-page-polish/08-RESEARCH.md
@.planning/phases/08-input-page-polish/08-01-SUMMARY.md
@tests/e2e/pages/index_page.py
@tests/e2e/test_homepage.py
@tests/e2e/test_ui_controls.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update IndexPage POM and E2E tests for toggle switch, paste feedback, and reactive label</name>
  <files>
    tests/e2e/pages/index_page.py
    tests/e2e/test_homepage.py
    tests/e2e/test_ui_controls.py
  </files>
  <action>
**IndexPage POM changes (`tests/e2e/pages/index_page.py`):**

1. Remove the `mode_select` locator (`page.locator("#mode-select")`).

2. Add new locators:
```python
self.mode_toggle_widget = page.locator("#mode-toggle-widget")
self.mode_toggle_btn = page.locator("#mode-toggle-btn")
self.mode_input = page.locator("#mode-input")
self.paste_feedback = page.locator("#paste-feedback")
```

3. Replace `select_mode()` method with `toggle_mode()`:
```python
def toggle_mode(self) -> None:
    """Click the mode toggle button to switch between offline/online."""
    self.mode_toggle_btn.click()
```

4. Add `get_mode()` method:
```python
def get_mode(self) -> str:
    """Return the current mode value from the hidden input."""
    return self.mode_input.input_value()
```

5. Add `expect_mode()` method:
```python
def expect_mode(self, mode: str) -> None:
    """Assert the hidden mode input has the expected value."""
    expect(self.mode_input).to_have_value(mode)
```

6. Update `select_mode()` to use the toggle (for backward compat with `extract_iocs`):
```python
def select_mode(self, mode: str) -> None:
    """Set mode to the given value by toggling if needed."""
    current = self.mode_input.input_value()
    if current != mode:
        self.toggle_mode()
```

This keeps `extract_iocs()` working since it calls `self.select_mode(mode)`.

**test_homepage.py changes:**

1. In `test_form_elements_present`: Replace `expect(idx.mode_select).to_be_visible()` with `expect(idx.mode_toggle_widget).to_be_visible()`.

2. Replace `test_mode_select_options` with `test_mode_toggle_labels`:
```python
def test_mode_toggle_labels(page: Page, index_url: str) -> None:
    """Mode toggle shows Offline and Online labels."""
    idx = IndexPage(page, index_url.rstrip("/"))
    idx.goto()

    offline_label = idx.mode_toggle_widget.locator(".mode-toggle-label--offline")
    online_label = idx.mode_toggle_widget.locator(".mode-toggle-label--online")
    expect(offline_label).to_have_text("Offline")
    expect(online_label).to_have_text("Online")
```

3. Replace `test_offline_mode_selected_by_default` with:
```python
def test_offline_mode_by_default(page: Page, index_url: str) -> None:
    """Offline mode is active by default."""
    idx = IndexPage(page, index_url.rstrip("/"))
    idx.goto()

    idx.expect_mode("offline")
    expect(idx.mode_toggle_btn).to_have_attribute("aria-pressed", "false")
```

**test_ui_controls.py changes:**

1. Replace `test_mode_toggle_to_online`:
```python
def test_mode_toggle_to_online(page: Page, index_url: str) -> None:
    """User can switch to online mode via toggle."""
    idx = IndexPage(page, index_url.rstrip("/"))
    idx.goto()

    idx.toggle_mode()
    idx.expect_mode("online")
    expect(idx.mode_toggle_btn).to_have_attribute("aria-pressed", "true")
```

2. Replace `test_mode_toggle_back_to_offline`:
```python
def test_mode_toggle_back_to_offline(page: Page, index_url: str) -> None:
    """User can switch back to offline mode after toggling to online."""
    idx = IndexPage(page, index_url.rstrip("/"))
    idx.goto()

    idx.toggle_mode()
    idx.expect_mode("online")

    idx.toggle_mode()
    idx.expect_mode("offline")
    expect(idx.mode_toggle_btn).to_have_attribute("aria-pressed", "false")
```

3. Add new test for reactive submit label (INPUT-03):
```python
def test_submit_label_changes_on_mode_toggle(page: Page, index_url: str) -> None:
    """Submit button label changes between 'Extract IOCs' and 'Extract & Enrich' on toggle."""
    idx = IndexPage(page, index_url.rstrip("/"))
    idx.goto()

    expect(idx.submit_btn).to_have_text("Extract IOCs")

    idx.toggle_mode()
    expect(idx.submit_btn).to_have_text("Extract & Enrich")

    idx.toggle_mode()
    expect(idx.submit_btn).to_have_text("Extract IOCs")
```

4. Add new test for paste feedback (INPUT-02):
```python
def test_paste_shows_character_count_feedback(page: Page, index_url: str) -> None:
    """Pasting text shows 'N characters pasted' feedback near textarea."""
    idx = IndexPage(page, index_url.rstrip("/"))
    idx.goto()

    # Simulate paste by setting clipboard and triggering paste
    test_text = "192.168.1.1\n10.0.0.1\nhxxps://evil[.]com"
    idx.textarea.focus()
    # Use evaluate to simulate paste event with clipboard data
    page.evaluate("""(text) => {
        const textarea = document.getElementById('ioc-text');
        textarea.value = text;
        textarea.dispatchEvent(new Event('paste', { bubbles: true }));
    }""", test_text)

    # Wait for the feedback to appear (setTimeout 0 + render)
    expect(idx.paste_feedback).to_be_visible({ timeout: 2000 })
    expect(idx.paste_feedback).to_contain_text("characters pasted")
```

Note: The paste event simulation sets the value first then dispatches `paste`, matching the browser's behavior after the setTimeout(0) in the handler reads `textarea.value.length`.

**IMPORTANT:** Use `.to_have_text()` not `.to_have_value()` for checking button text. Use `.to_have_value()` for hidden input values. Follow existing test patterns: each test creates its own IndexPage instance.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && python -m pytest tests/e2e/test_homepage.py tests/e2e/test_ui_controls.py -x --timeout=30 -v 2>&1 | tail -30</automated>
    <manual>None — automated tests cover all assertions</manual>
  </verify>
  <done>
    - IndexPage POM has mode_toggle_widget, mode_toggle_btn, mode_input, paste_feedback locators
    - select_mode() updated to work via toggle (backward compat for extract_iocs)
    - toggle_mode(), get_mode(), expect_mode() methods added
    - test_mode_select_options replaced with test_mode_toggle_labels
    - test_offline_mode_selected_by_default replaced with test_offline_mode_by_default
    - test_mode_toggle_to_online and test_mode_toggle_back_to_offline updated for toggle click
    - test_submit_label_changes_on_mode_toggle added (INPUT-03)
    - test_paste_shows_character_count_feedback added (INPUT-02)
    - All E2E tests pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Visual verification of input page polish</name>
  <action>
    Human visual verification of all three INPUT requirements in a real browser.

    What was built:
    1. Mode selector toggle switch replacing the dropdown (INPUT-01)
    2. Paste character count feedback (INPUT-02)
    3. Reactive submit button label (INPUT-03)

    Steps to verify:
    1. Start the dev server: `make run` or `flask run`
    2. Open http://127.0.0.1:5000 in browser
    3. **Toggle switch (INPUT-01):**
       - Verify the mode selector is a toggle switch (pill shape) with "Offline" and "Online" labels, not a dropdown
       - Click the toggle — it should slide right with a smooth animation and highlight "Online"
       - Click again — it should slide back to "Offline"
       - Tab to the toggle — verify visible focus ring (blue glow)
    4. **Paste feedback (INPUT-02):**
       - Copy some text (e.g., a paragraph) to clipboard
       - Click in the textarea and paste (Ctrl+V)
       - Verify "N characters pasted" appears below the textarea in italic gray text
       - Wait 2 seconds — the message should auto-dismiss
    5. **Submit button label (INPUT-03):**
       - With toggle on "Offline", verify submit button says "Extract IOCs"
       - Toggle to "Online", verify submit button says "Extract & Enrich"
       - Toggle back to "Offline", verify submit button says "Extract IOCs" again
    6. **Form submission:** Paste some IOCs, toggle to offline, submit — verify results page loads correctly
  </action>
  <verify>Human confirms all three INPUT requirements work correctly in the browser</verify>
  <done>
    - Toggle switch renders correctly with smooth animation and accessible focus ring
    - Paste feedback shows character count and auto-dismisses
    - Submit button label updates reactively on mode toggle
    - Form submission works end-to-end with toggle widget
    - Human types "approved" to complete Phase 8
  </done>
  <resume-signal>Type "approved" to complete Phase 8, or describe any visual issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x --timeout=30 -q` — all tests pass (including E2E)
2. `grep "mode-select" tests/e2e/ -r` — returns NO matches (old locator fully removed)
3. `grep "mode_toggle" tests/e2e/pages/index_page.py` — returns matches for new locators
4. Human-verified: toggle switch, paste feedback, and reactive label all work visually
</verification>

<success_criteria>
- All E2E tests pass including new tests for toggle, paste feedback, and reactive label
- No references to `mode-select` or `mode_select` remain in test files
- IndexPage POM `select_mode()` works via toggle (backward compat)
- Human approves visual appearance of all three INPUT improvements
- Full test suite passes (all ~280+ tests)
</success_criteria>

<output>
After completion, create `.planning/phases/08-input-page-polish/08-02-SUMMARY.md`
</output>
