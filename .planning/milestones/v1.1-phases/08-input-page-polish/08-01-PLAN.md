---
phase: 08-input-page-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/templates/index.html
  - app/static/src/input.css
  - app/static/main.js
  - app/static/dist/style.css
autonomous: true
requirements: [INPUT-01, INPUT-02, INPUT-03]

must_haves:
  truths:
    - "Mode selector is a toggle switch (not a dropdown) with Offline/Online labels"
    - "Pasting text into textarea shows 'N characters pasted' feedback that auto-dismisses"
    - "Submit button reads 'Extract IOCs' in offline mode and 'Extract & Enrich' in online mode"
    - "Toggle switch has correct aria-pressed state and keyboard focus indicator"
    - "Hidden input name='mode' submits correct value on form POST"
  artifacts:
    - path: "app/templates/index.html"
      provides: "Toggle switch widget HTML replacing <select>, paste-feedback span, submit button with dynamic label"
      contains: "mode-toggle-widget"
    - path: "app/static/src/input.css"
      provides: "Toggle switch CSS component styles, paste feedback styles"
      contains: "mode-toggle-track"
    - path: "app/static/main.js"
      provides: "initModeToggle(), updateSubmitLabel(), showPasteFeedback() functions"
      contains: "initModeToggle"
    - path: "app/static/dist/style.css"
      provides: "Regenerated Tailwind CSS including new toggle component"
  key_links:
    - from: "app/static/main.js"
      to: "app/templates/index.html"
      via: "getElementById('mode-toggle-widget'), getElementById('mode-toggle-btn'), getElementById('mode-input'), getElementById('paste-feedback')"
      pattern: "getElementById.*mode-toggle"
    - from: "app/templates/index.html"
      to: "app/routes.py"
      via: "hidden input name='mode' submits form value"
      pattern: "name=\"mode\""
    - from: "app/static/main.js"
      to: "app/static/main.js"
      via: "initModeToggle() calls updateSubmitLabel() on toggle click"
      pattern: "updateSubmitLabel"
---

<objective>
Implement all three INPUT requirements: replace the mode `<select>` dropdown with a CSS toggle switch (INPUT-01), add paste character count feedback (INPUT-02), and make the submit button label reactive to mode changes (INPUT-03).

Purpose: Improve input page UX so analysts immediately understand the current mode and get feedback on paste actions, reducing confusion about what will happen on submit.
Output: Updated index.html with toggle widget, extended main.js with toggle/paste/label handlers, new CSS component styles in input.css, regenerated dist/style.css.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-input-page-polish/08-RESEARCH.md
@app/templates/index.html
@app/static/main.js
@app/static/src/input.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace mode select with toggle switch and add paste feedback</name>
  <files>
    app/templates/index.html
    app/static/src/input.css
    app/static/main.js
  </files>
  <action>
**index.html changes:**

1. Remove the entire `<select id="mode-select">` block (lines 34-38) and its parent `.mode-toggle` div.

2. Replace with toggle widget HTML:
```html
<div class="mode-toggle">
    <label class="form-label">Analysis Mode</label>
    <div class="mode-toggle-widget" id="mode-toggle-widget" data-mode="offline">
        <span class="mode-toggle-label mode-toggle-label--offline">Offline</span>
        <button type="button" class="mode-toggle-track" id="mode-toggle-btn" aria-pressed="false" aria-label="Toggle analysis mode">
            <span class="mode-toggle-thumb"></span>
        </button>
        <span class="mode-toggle-label mode-toggle-label--online">Online</span>
    </div>
    <input type="hidden" name="mode" id="mode-input" value="offline">
</div>
```

Note: The `<label>` no longer needs `for="mode-select"` since the toggle is a `<button>`, not a form control with an id matching a label. The hidden input carries `name="mode"` for the Flask route (`request.form.get("mode", "offline")`).

3. Add paste feedback span immediately after the closing `</textarea>` tag:
```html
<span id="paste-feedback" class="paste-feedback" style="display:none;" aria-live="polite"></span>
```

The `style="display:none"` in HTML is safe under the current CSP (no `style-src` restriction blocks inline styles; confirmed in Phase 7 STATE.md).

**input.css changes:**

1. Remove the existing `.mode-select` and `.mode-select:focus` rules (lines 233-249).

2. Add toggle switch component styles inside the existing `@layer components` block, after the `.mode-toggle` rule:

```css
.mode-toggle-widget {
    display: flex;
    align-items: center;
    gap: 0.6rem;
}

.mode-toggle-track {
    position: relative;
    width: 44px;
    height: 24px;
    border-radius: 12px;
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border);
    cursor: pointer;
    transition: background-color 0.2s ease, border-color 0.2s ease;
    padding: 0;
    flex-shrink: 0;
}

.mode-toggle-track:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.25);
}

.mode-toggle-thumb {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: var(--text-secondary);
    transition: transform 0.2s ease, background-color 0.2s ease;
}

.mode-toggle-widget[data-mode="online"] .mode-toggle-track {
    background-color: rgba(74, 255, 158, 0.15);
    border-color: rgba(74, 255, 158, 0.4);
}

.mode-toggle-widget[data-mode="online"] .mode-toggle-thumb {
    transform: translateX(20px);
    background-color: var(--accent-domain);
}

.mode-toggle-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    user-select: none;
    transition: color 0.15s ease;
}

.mode-toggle-widget[data-mode="offline"] .mode-toggle-label--offline,
.mode-toggle-widget[data-mode="online"] .mode-toggle-label--online {
    color: var(--text-primary);
    font-weight: 600;
}

.paste-feedback {
    font-size: 0.78rem;
    color: var(--text-secondary);
    font-style: italic;
    display: block;
    margin-top: 0.25rem;
    min-height: 1.2em;
}
```

**main.js changes:**

1. Add `initModeToggle()` function (new, after `initSubmitButton()`):
```javascript
function initModeToggle() {
    var widget = document.getElementById("mode-toggle-widget");
    var toggleBtn = document.getElementById("mode-toggle-btn");
    var modeInput = document.getElementById("mode-input");
    if (!widget || !toggleBtn || !modeInput) return;

    toggleBtn.addEventListener("click", function () {
        var current = widget.getAttribute("data-mode");
        var next = current === "offline" ? "online" : "offline";
        widget.setAttribute("data-mode", next);
        modeInput.value = next;
        toggleBtn.setAttribute("aria-pressed", next === "online" ? "true" : "false");
        updateSubmitLabel(next);
    });

    // Set initial label based on current mode (defensive)
    updateSubmitLabel(modeInput.value);
}
```

2. Add `updateSubmitLabel()` function:
```javascript
function updateSubmitLabel(mode) {
    var submitBtn = document.getElementById("submit-btn");
    if (!submitBtn) return;
    submitBtn.textContent = mode === "online" ? "Extract \u0026 Enrich" : "Extract IOCs";
}
```

Note: Use `"Extract \u0026 Enrich"` or `"Extract & Enrich"` (both work in JS string context). The ampersand is safe in `.textContent`.

3. Add `showPasteFeedback()` function:
```javascript
function showPasteFeedback(charCount) {
    var feedback = document.getElementById("paste-feedback");
    if (!feedback) return;
    feedback.textContent = charCount + " characters pasted";
    feedback.style.display = "";
    clearTimeout(feedback._timer);
    feedback._timer = setTimeout(function () {
        feedback.style.display = "none";
    }, 2000);
}
```

4. Extend the existing paste handler in `initSubmitButton()` (lines 51-54). Change:
```javascript
textarea.addEventListener("paste", function () {
    setTimeout(updateSubmitState, 0);
});
```
To:
```javascript
textarea.addEventListener("paste", function () {
    setTimeout(function () {
        updateSubmitState();
        showPasteFeedback(textarea.value.length);
    }, 0);
});
```

5. Add `initModeToggle()` call in the `init()` function (the DOMContentLoaded handler), after `initSubmitButton()`.

**IMPORTANT:** Do NOT use innerHTML anywhere. Use .textContent for all dynamic content (SEC-08). Do NOT use Alpine.js (removed in Phase 7). Follow existing var/function declaration style (no arrow functions, no template literals, no const/let).
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && python -c "
from app import create_app
app = create_app({'TESTING': True, 'WTF_CSRF_ENABLED': False, 'SERVER_NAME': 'localhost'})
with app.test_client() as c:
    resp = c.get('/')
    html = resp.data.decode()
    assert 'mode-toggle-widget' in html, 'Toggle widget missing'
    assert 'mode-toggle-btn' in html, 'Toggle button missing'
    assert 'mode-input' in html, 'Hidden mode input missing'
    assert 'paste-feedback' in html, 'Paste feedback span missing'
    assert 'mode-select' not in html, 'Old select element still present'
    assert 'name=\"mode\"' in html, 'Hidden input missing name=mode'
    print('All HTML checks passed')
"</automated>
    <manual>None required — automated verification covers HTML structure</manual>
  </verify>
  <done>
    - index.html has toggle widget replacing select dropdown, paste-feedback span, hidden input with name="mode"
    - input.css has toggle switch component CSS and paste feedback CSS (old .mode-select rules removed)
    - main.js has initModeToggle(), updateSubmitLabel(), showPasteFeedback() functions
    - Paste handler in initSubmitButton() extended with showPasteFeedback() call
    - initModeToggle() called in init() function
  </done>
</task>

<task type="auto">
  <name>Task 2: Regenerate Tailwind CSS and run full test suite</name>
  <files>
    app/static/dist/style.css
  </files>
  <action>
1. Run `make css` to regenerate `app/static/dist/style.css` with the new toggle component styles.

2. Verify the generated CSS contains the new toggle classes:
```bash
grep -c "mode-toggle-track" app/static/dist/style.css
grep -c "mode-toggle-thumb" app/static/dist/style.css
grep -c "paste-feedback" app/static/dist/style.css
```

3. Run the full test suite to check for regressions:
```bash
python -m pytest tests/ -x --timeout=30 -q
```

**Expected:** Some E2E tests will fail because they reference the old `#mode-select` element (specifically `test_form_elements_present`, `test_mode_select_options`, `test_offline_mode_selected_by_default`, `test_mode_toggle_to_online`, `test_mode_toggle_back_to_offline`). This is expected and will be fixed in Plan 02. All non-mode-related tests should pass.

4. Run just the non-E2E tests to confirm no backend regressions:
```bash
python -m pytest tests/ -x --timeout=30 -q --ignore=tests/e2e
```

**Expected:** All non-E2E tests pass (the hidden input change does not affect backend — `request.form.get("mode", "offline")` reads the same field name).
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && make css && python -m pytest tests/ -x --timeout=30 -q --ignore=tests/e2e</automated>
    <manual>None required</manual>
  </verify>
  <done>
    - dist/style.css regenerated with toggle component styles
    - All non-E2E tests pass without regression
    - CSS contains mode-toggle-track, mode-toggle-thumb, paste-feedback classes
  </done>
</task>

</tasks>

<verification>
1. `grep "mode-toggle-widget" app/templates/index.html` returns match
2. `grep "mode-select" app/templates/index.html` returns NO match (old select removed)
3. `grep "initModeToggle" app/static/main.js` returns match
4. `grep "showPasteFeedback" app/static/main.js` returns match
5. `grep "updateSubmitLabel" app/static/main.js` returns match
6. `grep "mode-toggle-track" app/static/dist/style.css` returns match
7. `python -m pytest tests/ --ignore=tests/e2e -x -q` passes
</verification>

<success_criteria>
- Toggle switch widget renders in index.html (no `<select>` element)
- Hidden input with `name="mode"` carries form value for Flask route
- CSS toggle animates between offline/online states via `[data-mode]` selector
- Paste handler shows character count feedback that auto-dismisses after 2s
- Submit button label updates reactively on mode toggle
- All non-E2E tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-input-page-polish/08-01-SUMMARY.md`
</output>
