---
phase: 03-additional-ti-providers
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - app/routes.py
  - app/static/main.js
  - app/static/style.css
  - app/templates/results.html
  - tests/test_routes.py
autonomous: false
requirements: [ENRC-02, ENRC-03]

must_haves:
  truths:
    - "Submitting a SHA256 hash in online mode returns enrichment results from all three providers (VirusTotal, MalwareBazaar, ThreatFox) in the same results view"
    - "Each IOC shows multiple provider results stacked vertically beneath it"
    - "Results appear as they arrive (fastest provider first) without reordering existing results"
    - "A MalwareBazaar or ThreatFox failure shows per-provider error without affecting other provider results"
    - "Suspicious verdict badge is visually distinct (yellow/orange) alongside existing malicious (red), clean (green), no_data (gray), error (amber)"
    - "Copy button includes worst verdict across all providers for that IOC"
    - "Export includes worst verdict per IOC across all providers"
  artifacts:
    - path: "app/routes.py"
      provides: "Multi-provider adapter wiring in /analyze route"
      contains: "MBAdapter"
    - path: "app/static/main.js"
      provides: "Multi-provider polling and rendering"
      contains: "ioc_value.*provider"
    - path: "app/static/style.css"
      provides: "Suspicious verdict badge styling"
      contains: "verdict-suspicious"
    - path: "tests/test_routes.py"
      provides: "Updated route tests for multi-provider enrichment"
  key_links:
    - from: "app/routes.py"
      to: "app/enrichment/orchestrator.py"
      via: "EnrichmentOrchestrator(adapters=[vt, mb, tf])"
      pattern: "EnrichmentOrchestrator.*adapters"
    - from: "app/routes.py"
      to: "app/enrichment/adapters/malwarebazaar.py"
      via: "MBAdapter import and instantiation"
      pattern: "from app\\.enrichment\\.adapters\\.malwarebazaar import"
    - from: "app/routes.py"
      to: "app/enrichment/adapters/threatfox.py"
      via: "TFAdapter import and instantiation"
      pattern: "from app\\.enrichment\\.adapters\\.threatfox import"
    - from: "app/static/main.js"
      to: "/enrichment/status/<job_id>"
      via: "fetch polling loop rendering multiple results per IOC"
      pattern: "renderEnrichmentResult"
---

<objective>
Wire all three providers into the Flask routes, update the JavaScript polling loop for multi-provider display, add suspicious verdict styling, and visually verify the complete Phase 3 flow.

Purpose: Plans 01 and 02 built the adapters and multi-adapter orchestrator independently. This plan connects everything: the /analyze route creates all three adapters and passes them to the orchestrator, the JS polling loop renders multiple results per IOC (stacked vertically), and the CSS adds the suspicious verdict badge. This completes the full Phase 3 integration.

Output: Fully wired multi-provider enrichment with visual verification.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-additional-ti-providers/03-01-SUMMARY.md
@.planning/phases/03-additional-ti-providers/03-02-SUMMARY.md
@app/routes.py
@app/static/main.js
@app/static/style.css
@app/templates/results.html
@tests/test_routes.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire multi-provider adapters into routes and update enrichable_count</name>
  <files>app/routes.py, tests/test_routes.py</files>
  <action>
**app/routes.py — Multi-provider wiring:**

1. Add imports for new adapters:
   ```python
   from app.enrichment.adapters.malwarebazaar import MBAdapter
   from app.enrichment.adapters.threatfox import TFAdapter
   ```

2. In the online-mode branch of `/analyze`:
   - Create all three adapters:
     ```python
     allowed_hosts = current_app.config.get("ALLOWED_API_HOSTS", [])
     vt_adapter = VTAdapter(api_key=api_key, allowed_hosts=allowed_hosts)
     mb_adapter = MBAdapter(allowed_hosts=allowed_hosts)
     tf_adapter = TFAdapter(allowed_hosts=allowed_hosts)
     ```
   - Pass all adapters to orchestrator:
     ```python
     orchestrator = EnrichmentOrchestrator(adapters=[vt_adapter, mb_adapter, tf_adapter])
     ```
   - MalwareBazaar and ThreatFox are always active in online mode (no API key needed). VTAdapter requires the API key (already checked above).

3. Update `enrichable_count` calculation: The current code counts IOCs in VT's ENDPOINT_MAP. With multi-provider, the count should reflect the total number of provider lookups that will be dispatched. Compute as: for each IOC, count how many adapters support its type. Sum across all IOCs. This matches the orchestrator's `total` field.
   ```python
   adapters_list = [vt_adapter, mb_adapter, tf_adapter]
   enrichable_count = sum(
       1 for ioc in iocs for adapter in adapters_list
       if ioc.type in adapter.supported_types
   )
   ```

4. Remove the `from app.enrichment.adapters.virustotal import ENDPOINT_MAP` import from routes (no longer needed for enrichable_count).

**tests/test_routes.py — Update tests:**

1. Update any existing tests that mock VTAdapter to also expect MBAdapter and TFAdapter creation.
2. Add `test_analyze_online_creates_all_three_adapters` — Verify that the online mode route creates VT, MB, and TF adapters and passes them to the orchestrator.
3. Add `test_enrichable_count_multi_provider` — Submit a SHA256 hash. Assert enrichable_count accounts for all three providers (3 lookups for one hash IOC).
4. Add `test_enrichable_count_domain_two_providers` — Submit a domain IOC. Assert enrichable_count reflects VT + ThreatFox (MalwareBazaar does not support domains).

Run: `python -m pytest tests/test_routes.py -x --tb=short` — all tests pass.
  </action>
  <verify>
`python -m pytest tests/test_routes.py -x --tb=short` — 0 failures. `grep "MBAdapter" app/routes.py` confirms import present. `grep "TFAdapter" app/routes.py` confirms import present. `grep "ENDPOINT_MAP" app/routes.py` returns nothing (decoupled).
  </verify>
  <done>The /analyze route creates all three provider adapters and passes them to the orchestrator. enrichable_count accurately reflects multi-provider dispatch count. No ENDPOINT_MAP dependency remains in routes. All route tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Update JS polling for multi-provider display and add suspicious verdict CSS</name>
  <files>app/static/main.js, app/static/style.css, app/templates/results.html</files>
  <action>
**app/static/main.js — Multi-provider rendering:**

The current polling loop tracks `rendered[result.ioc_value]` to avoid re-rendering. With multiple providers per IOC, change the dedup key to `result.ioc_value + "|" + result.provider` so each provider result for the same IOC gets its own row.

Update `renderEnrichmentResult()`:
- Instead of replacing the enrichment slot content (clearing spinner), APPEND a new provider result div to the slot.
- Only clear the spinner on the FIRST result for that IOC (check if slot still contains the spinner class).
- Each provider result is a div with the badge + detail, stacked vertically inside the enrichment-slot.
- Per user decision: "results appear as they arrive (fastest first) — positions are additive (new results append, don't reorder)".

Update copy-with-enrichment logic:
- Per user decision: "Copy/export: worst verdict only — export includes the most concerning result across all providers for each IOC"
- Define verdict severity order: malicious > suspicious > clean > no_data > error
- When updating `data-enrichment` on copy button, compute worst verdict across all providers for that IOC. Track per-IOC verdicts in a dict: `iocVerdicts[ioc_value] = [{provider, verdict, text}]`.
- Set `data-enrichment` to the worst verdict's summary text.

Update export button:
- Same worst-verdict logic: for each IOC row, export the worst verdict provider line.

Add the `suspicious` verdict to the `renderEnrichmentResult` text mapping:
```javascript
} else if (verdict === "suspicious") {
    verdictText = "Suspicious";
}
```

**app/static/style.css — Add suspicious verdict badge:**

Add `.verdict-suspicious` class following the existing badge pattern:
```css
.verdict-suspicious {
    background-color: #f59e0b;  /* amber-500 — distinct from error's darker amber */
    color: #000;
}
```

Ensure the yellow/amber shade is visually distinct from the existing error badge (which is `verdict-error`). Use a brighter amber for suspicious to differentiate from error.

**app/templates/results.html — Update enrichment structure (if needed):**

The current template has one `.ioc-enrichment-row` with one `.enrichment-slot` per IOC. This structure should still work — the JS will append multiple provider divs inside the single `.enrichment-slot`. No template changes should be needed unless the spinner structure needs a wrapper. If the spinner is currently a direct child of `.enrichment-slot`, wrap it in a `<div class="spinner-wrapper">` so it can be cleanly removed when the first result arrives.

Run: `python -m pytest tests/ -x --tb=short` — full suite passes (JS changes don't break Python tests).
  </action>
  <verify>
`python -m pytest tests/ -x --tb=short` — full suite passes. `grep "verdict-suspicious" app/static/style.css` confirms new badge style. `grep "suspicious" app/static/main.js` confirms JS handles suspicious verdict. `grep "provider" app/static/main.js` confirms dedup key includes provider.
  </verify>
  <done>JS polling renders multiple provider results per IOC, stacked vertically. Dedup key is ioc_value+provider. Copy/export uses worst verdict across all providers. Suspicious verdict badge styled in amber. Full test suite passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of multi-provider enrichment</name>
  <files>app/templates/results.html, app/static/main.js, app/static/style.css</files>
  <action>
Human visual verification of the complete Phase 3 multi-provider enrichment system:
- VirusTotal + MalwareBazaar + ThreatFox results displayed together per IOC
- Stacked provider results (vertically, fastest first)
- Suspicious verdict badge in amber
- Worst-verdict copy/export

Verification steps:
1. Start the app: `source .venv/bin/activate && python run.py`
2. Open http://127.0.0.1:5000
3. Go to Settings, ensure VT API key is configured
4. On the main page, select "Online" mode
5. Paste a known malicious SHA256 hash (e.g., from MalwareBazaar recent samples page)
6. Submit and verify:
   - [ ] Progress bar shows correct total (should be 3x the number of hash IOCs — one per provider)
   - [ ] Results appear incrementally as each provider responds
   - [ ] Each IOC shows up to 3 provider results stacked vertically (VirusTotal, MalwareBazaar, ThreatFox)
   - [ ] MalwareBazaar result shows "malicious" badge if hash is known malware
   - [ ] Verdict badges are color-coded: malicious=red, suspicious=amber/yellow, clean=green, no_data=gray
   - [ ] If ThreatFox returns a low-confidence hit, the badge shows "suspicious" in amber
   - [ ] Provider errors (if any) show per-provider error badge without affecting other providers
7. Test copy button: click copy on a hash IOC, paste into text editor
   - [ ] Verify it includes worst verdict across all providers
8. Test export button: click Export All
   - [ ] Verify exported text includes worst verdict per IOC
9. Test with a domain IOC (only VT + ThreatFox should respond, not MalwareBazaar):
   - [ ] Progress bar total reflects 2 lookups (not 3)
   - [ ] Only 2 provider results shown for the domain
  </action>
  <verify>Human confirms all checklist items above pass visual inspection.</verify>
  <done>Multi-provider enrichment displays correctly: 3 providers for hashes, 2 for domains, suspicious badge visible, copy/export uses worst verdict. Human approved.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x --tb=short` — full suite green
2. Visual: SHA256 hash shows results from 3 providers in same view
3. Visual: domain shows results from 2 providers (VT + ThreatFox, no MalwareBazaar)
4. Visual: suspicious verdict badge is visually distinct amber color
5. Copy/export uses worst verdict across providers
6. Provider errors isolated — one provider failure does not affect others
</verification>

<success_criteria>
- SHA256 hash returns enrichment from VirusTotal, MalwareBazaar, and ThreatFox in the same view (Phase 3 success criteria 1)
- Provider failure returns per-provider error without affecting others (Phase 3 success criteria 2)
- Each adapter independently testable with mocked HTTP (Phase 3 success criteria 3)
- Suspicious verdict visually distinct
- Copy/export reflects worst verdict per user decision
- Human-verified end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/03-additional-ti-providers/03-03-SUMMARY.md`
</output>
