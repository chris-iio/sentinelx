---
phase: 01-foundation-and-offline-pipeline
plan: 04
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
  - "01-03"
files_modified:
  - app/routes.py
  - app/templates/base.html
  - app/templates/index.html
  - app/templates/results.html
  - app/static/style.css
  - app/static/main.js
  - tests/test_routes.py
autonomous: false
requirements:
  - UI-01
  - UI-02
  - UI-04
  - UI-07
  - SEC-16

must_haves:
  truths:
    - "Analyst can paste text into a large textarea and click Extract IOCs"
    - "Results page groups IOCs by type with collapsible accordion sections and count badges"
    - "Offline mode indicator is visible on results page"
    - "Offline/online toggle defaults to offline and is visible on the input page"
    - "Offline mode submission makes zero outbound network calls"
    - "Oversize POST (>512KB) returns 413 error with user-friendly message"
    - "Request with untrusted Host header returns 400"
    - "Copy button copies refanged IOC value to clipboard"
    - "Empty input disables submit button"
    - "No IOCs found shows friendly message"
  artifacts:
    - path: "app/routes.py"
      provides: "GET / and POST /analyze route handlers"
      exports: ["bp"]
    - path: "app/templates/base.html"
      provides: "Base layout with dark theme, no inline scripts"
      contains: "DOCTYPE html"
    - path: "app/templates/index.html"
      provides: "Paste form with textarea, mode toggle, submit button"
      contains: "Extract IOCs"
    - path: "app/templates/results.html"
      provides: "IOC results grouped by type with accordion, mode indicator"
      contains: "grouped"
    - path: "app/static/style.css"
      provides: "Dark theme CSS with IOC type accent colors"
      min_lines: 50
    - path: "app/static/main.js"
      provides: "Clipboard copy functionality (CSP-compliant, no inline scripts)"
      contains: "clipboard"
    - path: "tests/test_routes.py"
      provides: "Integration tests for routes and security properties"
      min_lines: 60
  key_links:
    - from: "app/routes.py"
      to: "app/pipeline/extractor.py"
      via: "run_pipeline import for POST /analyze"
      pattern: "from.*pipeline.*import"
    - from: "app/routes.py"
      to: "app/templates/results.html"
      via: "render_template with grouped IOCs"
      pattern: "render_template.*results"
    - from: "app/templates/index.html"
      to: "app/routes.py"
      via: "Form POST to /analyze"
      pattern: "action.*analyze"
    - from: "app/templates/base.html"
      to: "app/static/style.css"
      via: "CSS link tag"
      pattern: "url_for.*static.*style"
    - from: "app/templates/base.html"
      to: "app/static/main.js"
      via: "Script tag (external, CSP-compliant)"
      pattern: "url_for.*static.*main"
---

<objective>
Complete routes, templates, and integration tests connecting the pipeline to the web UI.

Purpose: Wire the extraction pipeline to Flask routes and build the analyst-facing UI. This is where the analyst experience comes together — paste text, see extracted IOCs grouped by type, with all security defenses verified end-to-end.

Output: Fully functional offline IOC extraction web app with dark theme UI, security integration tests, and visual verification.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-offline-pipeline/01-RESEARCH.md
@.planning/phases/01-foundation-and-offline-pipeline/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-offline-pipeline/01-02-SUMMARY.md
@.planning/phases/01-foundation-and-offline-pipeline/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement routes and integration tests</name>
  <files>
    app/routes.py
    tests/test_routes.py
  </files>
  <action>
    Update `app/routes.py` from placeholder to full implementation:

    1. `GET /` — renders `index.html` template. No data needed.

    2. `POST /analyze` — the main endpoint:
       - Read `text` from `request.form.get('text', '')`
       - Read `mode` from `request.form.get('mode', 'offline')`
       - If `text.strip()` is empty: re-render `index.html` with `error='No input provided.'`
       - Call `run_pipeline(text)` from `app.pipeline.extractor` to get deduplicated IOC list
       - Call `group_by_type(iocs)` from `app.pipeline.models` to group for display
       - If no IOCs found: render `results.html` with `grouped={}`, `mode=mode`, `total_count=0`, `no_results=True`
       - Otherwise: render `results.html` with `grouped=grouped`, `mode=mode`, `total_count=len(deduped)`
       - IMPORTANT: No outbound network calls happen in offline mode (UI-02). The route handler does NOT call any enrichment — that's Phase 2.

    3. SEC-16 structure: Add `ALLOWED_API_HOSTS` to the app config (empty list for Phase 1). This establishes the SSRF prevention structure that Phase 2 will enforce. In Phase 1, no outbound calls are made, so enforcement is trivially satisfied.

    Create `tests/test_routes.py` with comprehensive integration tests:

    **Functional tests:**
    - `test_index_returns_200` — GET / returns 200
    - `test_analyze_with_valid_input` — POST /analyze with mixed IOC text returns 200 with results
    - `test_analyze_empty_input` — POST /analyze with empty text shows error message
    - `test_analyze_extracts_ipv4` — POST with IPv4 text, verify IOC appears in response
    - `test_analyze_groups_by_type` — POST with mixed types, verify grouping in response HTML

    **Security tests:**
    - `test_oversize_post_returns_413` — POST 600 KB payload returns 413 (SEC-12)
    - `test_invalid_host_returns_400` — GET with `Host: evil.com` returns 400 (SEC-11)
    - `test_debug_mode_is_false` — `app.debug is False` (SEC-15)
    - `test_security_headers_present` — CSP, X-Content-Type-Options, X-Frame-Options all present (SEC-09)
    - `test_offline_mode_makes_no_http_calls` — Mock `urllib.request.urlopen`, `http.client.HTTPConnection`, and any `httpx`/`requests` imports; POST in offline mode; assert none called (UI-02)
    - `test_csrf_token_required` — POST /analyze without CSRF token returns 400 when CSRF is enabled (SEC-10)

    **Edge case tests:**
    - `test_analyze_no_iocs_found` — POST with text containing no IOCs shows friendly message
    - `test_analyze_deduplicates` — POST with duplicate IOCs returns deduplicated results
  </action>
  <verify>
    ```bash
    source .venv/bin/activate
    pytest tests/test_routes.py -v
    pytest tests/ -v --tb=short  # All tests including pipeline tests still pass
    ```
  </verify>
  <done>
    Routes handle GET / and POST /analyze. Integration tests verify functional behavior, all security properties (413, 400, CSP, CSRF, debug=False, no HTTP calls in offline mode), and edge cases. All existing pipeline tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build templates and static assets</name>
  <files>
    app/templates/base.html
    app/templates/index.html
    app/templates/results.html
    app/static/style.css
    app/static/main.js
  </files>
  <action>
    Create the analyst-facing UI following CONTEXT.md visual direction:

    1. `app/templates/base.html` — Base layout:
       - Standard HTML5 doctype
       - `<link>` to `{{ url_for('static', filename='style.css') }}`
       - `<script src="{{ url_for('static', filename='main.js') }}" defer></script>` (external, CSP-compliant — NO inline scripts)
       - Dark background, minimal chrome
       - `{% block content %}{% endblock %}` for page content
       - NO `| safe` filter on ANY variable (SEC-08)
       - Jinja2 autoescaping is enabled by default — do not override

    2. `app/templates/index.html` — Input page:
       - Extends `base.html`
       - Large `<textarea>` with name="text", placeholder showing example defanged IOCs:
         ```
         Paste IOCs here, e.g.:
         192[.]168[.]1[.]1
         hxxp://evil[.]com/malware
         e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
         CVE-2025-49596
         ```
       - Offline/online toggle as a `<select>` or radio buttons with name="mode", defaulting to "offline"
       - Submit button labeled "Extract IOCs" (disabled when textarea is empty — handled by `main.js`)
       - Clear button to reset textarea
       - `<form method="post" action="{{ url_for('main.analyze') }}">`
       - `<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>` (SEC-10)
       - If `error` variable is set, show inline error message (not modal)

    3. `app/templates/results.html` — Results page:
       - Extends `base.html`
       - Mode indicator banner: "Results — Offline Mode" or "Results — Online Mode" (UI-07)
       - Total IOC count summary: "Found X unique IOCs"
       - If `no_results` or `total_count == 0`: show "No IOCs detected in the pasted text. Supported types: IPv4, IPv6, domain, URL, MD5, SHA1, SHA256, CVE."
       - IOC groups using `<details>/<summary>` elements (accordion, no JavaScript needed):
         - `<summary>` shows IOC type name + count badge, e.g., "IPv4 (12)"
         - All sections `open` by default on first load
         - Inside each `<details>`: HTML table with columns:
           - Normalized Value (monospace font)
           - Original (shown only when differs from normalized, muted secondary style)
           - Copy button (calls clipboard API from main.js)
       - Type-specific accent colors on group headers:
         - IPv4/IPv6: blue (#4a9eff)
         - Domain: green (#4aff9e)
         - URL: cyan (#4aeeee)
         - Hash (MD5/SHA1/SHA256): orange (#ff9e4a)
         - CVE: red (#ff4a4a)
       - "Back to input" link
       - All IOC values rendered with `{{ ioc.value }}` — NEVER `| safe` (SEC-08)

    4. `app/static/style.css` — Dark theme styling:
       - CSS custom properties for color palette:
         - `--bg-primary: #0d1117` (GitHub dark-style background)
         - `--bg-secondary: #161b22`
         - `--text-primary: #e6edf3`
         - `--text-secondary: #8b949e`
         - `--border: #30363d`
         - Type-specific accent colors as above
       - Monospace font for IOC values (`font-family: 'Fira Code', 'Cascadia Code', 'JetBrains Mono', monospace`)
       - System sans-serif for labels/UI (`font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif`)
       - No gradients, no decoration — minimal, clinical aesthetic
       - Responsive textarea (large, fills width)
       - Table styling: clean borders, hover row highlight
       - `<details>` styling: custom summary marker, proper spacing
       - Button styling: submit (accent), clear (muted), copy (small inline)
       - Mode toggle styling

    5. `app/static/main.js` — Minimal JavaScript (CSP-compliant):
       - Clipboard copy: attach click listeners to all `.copy-btn` elements, use `navigator.clipboard.writeText()` to copy the `data-value` attribute
       - Show brief "Copied!" feedback on button text
       - Disable submit button when textarea is empty (listen for `input` event)
       - NO inline event handlers (no `onclick` attributes) — all listeners attached from this external file
       - This file is served from `static/` so it passes CSP `script-src 'self'`
  </action>
  <verify>
    ```bash
    source .venv/bin/activate
    # Start the app and verify manually
    python run.py &
    sleep 2

    # Check security headers
    curl -sI http://127.0.0.1:5000/ | grep -E "(Content-Security|X-Content-Type|X-Frame)"

    # Check response contains expected elements
    curl -s http://127.0.0.1:5000/ | grep -c "Extract IOCs"

    # Kill the app
    kill %1

    # Run all tests
    pytest tests/ -v --tb=short
    ```
  </verify>
  <done>
    Dark theme UI renders correctly. Index page has textarea, mode toggle, and submit button. Results page shows grouped IOCs with accordion sections, count badges, mode indicator, and copy buttons. No inline scripts. No |safe on untrusted data. All tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual and functional verification</name>
  <files>app/templates/index.html, app/templates/results.html</files>
  <action>
    Human visual and functional verification of the complete offline IOC extraction app.

    What was built:
    - Dark theme input page (textarea, offline/online toggle, Extract IOCs button)
    - Extraction pipeline processing defanged text
    - Results page with IOC groups in accordion sections, count badges, mode indicator, copy buttons
    - Full security scaffold (CSP, CSRF, TRUSTED_HOSTS, MAX_CONTENT_LENGTH)
  </action>
  <verify>
    1. Start the app: `source .venv/bin/activate && python run.py`
    2. Open `http://127.0.0.1:5000/` in browser

    **Input page checks:**
    - [ ] Dark theme visible
    - [ ] Large textarea with placeholder text showing defanged examples
    - [ ] Offline/online toggle visible, defaults to offline
    - [ ] Submit button says "Extract IOCs"
    - [ ] Submit button is disabled when textarea is empty
    - [ ] Clear button resets textarea

    **Paste this test input:**
    ```
    Alert from SIEM: Source IP 192[.]168[.]1[.]100 contacted hxxps://evil-c2[.]example[.]com/beacon
    Hash of payload: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
    Related vulnerability: CVE-2025-49596
    Also seen from 192[.]168[.]1[.]100 (duplicate)
    DNS query to malware[.]example[.]org
    ```

    **Results page checks:**
    - [ ] Mode indicator shows "Offline Mode"
    - [ ] IOCs grouped by type in accordion sections (all expanded by default)
    - [ ] Count badges show correct numbers per type
    - [ ] Duplicate IP (192.168.1.100) appears only once
    - [ ] Defanged values are normalized (e.g., `hxxps://evil-c2[.]example[.]com` -> proper URL)
    - [ ] Original defanged form shown where it differs from normalized
    - [ ] Copy button copies refanged value to clipboard
    - [ ] Type-specific accent colors on group headers
    - [ ] Monospace font on IOC values

    **Security checks:**
    - [ ] `curl -sI http://127.0.0.1:5000/ | grep Content-Security-Policy` shows `default-src 'self'; script-src 'self'`
    - [ ] `curl -H "Host: evil.com" http://127.0.0.1:5000/` returns 400
    - [ ] View page source: no `| safe` in rendered HTML, no inline `<script>` tags

    **Empty state check:**
    - [ ] Paste `Hello world, no indicators here` and submit -> shows "No IOCs detected" message
  </verify>
  <done>
    User has visually confirmed: dark theme renders correctly, IOCs are extracted and grouped properly, mode indicator is visible, copy buttons work, security headers are present, and untrusted hosts are rejected. Type "approved" or describe issues to fix.
  </done>
</task>

</tasks>

<verification>
1. `pytest tests/ -v` — all tests pass (pipeline + routes)
2. `pytest tests/ --cov=app --cov-report=term-missing` — 80%+ coverage
3. Security headers verified via curl
4. Host validation verified via curl with bad Host
5. Manual paste of defanged IOC text produces correct grouped results
6. No inline scripts in any template
7. No `| safe` filter in any template
8. Offline mode verified: no HTTP calls during extraction
</verification>

<success_criteria>
- Analyst can paste defanged text and see extracted, classified, deduplicated IOCs grouped by type
- Dark theme UI with accordion sections, count badges, and copy buttons
- Offline mode indicator visible
- All security defenses verified by integration tests
- 80%+ test coverage across the full app
- Human verification confirms visual quality and functional correctness
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-offline-pipeline/01-04-SUMMARY.md`
</output>
