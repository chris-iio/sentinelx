---
phase: 01-foundation-and-offline-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - requirements.txt
  - .gitignore
  - .env.example
  - app/__init__.py
  - app/config.py
  - app/pipeline/__init__.py
  - app/pipeline/models.py
  - run.py
  - tests/__init__.py
  - tests/conftest.py
autonomous: true
requirements:
  - SEC-01
  - SEC-02
  - SEC-03
  - SEC-08
  - SEC-09
  - SEC-10
  - SEC-11
  - SEC-12
  - SEC-13
  - SEC-14
  - SEC-15

must_haves:
  truths:
    - "Flask app factory creates app with all security config before any routes"
    - "TRUSTED_HOSTS rejects requests with unexpected Host header (400)"
    - "MAX_CONTENT_LENGTH is 512KB and rejects oversize requests (413)"
    - "CSP header 'default-src self; script-src self' is present on every response"
    - "CSRF protection is enabled on all POST endpoints"
    - "Debug mode is hardcoded to False"
    - "App binds to 127.0.0.1 only"
    - "API keys read from env vars only; missing keys fail fast at startup"
    - "IOCType enum and frozen IOC dataclass exist for pipeline use"
  artifacts:
    - path: "app/__init__.py"
      provides: "Application factory with security scaffold"
      contains: "create_app"
    - path: "app/config.py"
      provides: "Config class reading env vars with validation"
      contains: "class Config"
    - path: "app/pipeline/models.py"
      provides: "IOCType enum and IOC frozen dataclass"
      contains: "class IOCType"
    - path: "run.py"
      provides: "Production entry point binding 127.0.0.1"
      contains: "127.0.0.1"
    - path: "tests/conftest.py"
      provides: "Pytest fixtures for app and client"
      contains: "app"
  key_links:
    - from: "app/__init__.py"
      to: "app/config.py"
      via: "Config class loaded in factory"
      pattern: "Config"
    - from: "run.py"
      to: "app/__init__.py"
      via: "create_app import"
      pattern: "from app import create_app"
---

<objective>
Project scaffold with Flask app factory, security configuration, and pipeline data models.

Purpose: Establish the project structure, all security defenses (CSP, CSRF, TRUSTED_HOSTS, MAX_CONTENT_LENGTH, debug lockdown), Config class, and typed data models before any feature code is written. Security is never retrofitted.

Output: Runnable Flask app (empty routes) with full security posture, IOC type system, and test fixtures.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-offline-pipeline/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project scaffold and dependencies</name>
  <files>
    pyproject.toml
    requirements.txt
    .gitignore
    .env.example
    tests/__init__.py
  </files>
  <action>
    Create the project root files:

    1. `pyproject.toml` — Python 3.12+ project config. Include:
       - `[project]` with name="sentinelx", version="0.1.0", requires-python=">=3.12"
       - `[tool.ruff]` with target-version="py312", select=["E","F","W","S","B"], line-length=100
       - `[tool.pytest.ini_options]` with testpaths=["tests"]

    2. `requirements.txt` — Pin exact versions:
       ```
       Flask==3.1.3
       Flask-WTF==1.2.2
       iocextract==1.16.1
       iocsearcher==2.7.2
       python-dotenv==1.2.1
       ```

    3. `.gitignore` — Standard Python gitignore including:
       - `.venv/`, `__pycache__/`, `*.pyc`, `.env`, `*.egg-info/`, `dist/`, `build/`
       - `.planning/` should NOT be gitignored (it's part of the project)

    4. `.env.example` — Document required env vars:
       ```
       # Required for CSRF protection (auto-generated if not set)
       SECRET_KEY=
       # Required for online mode (Phase 2+)
       # VIRUSTOTAL_API_KEY=
       ```

    5. `tests/__init__.py` — Empty file to make tests a package.

    6. Create virtual environment and install dependencies:
       ```bash
       python3.12 -m venv .venv
       source .venv/bin/activate
       pip install -r requirements.txt
       pip install pytest pytest-flask ruff bandit
       ```
  </action>
  <verify>
    ```bash
    source .venv/bin/activate
    python -c "import flask; print(flask.__version__)"  # Should print 3.1.3
    python -c "import flask_wtf; print('Flask-WTF OK')"
    python -c "import iocextract; print('iocextract OK')"
    python -c "from iocsearcher.searcher import Searcher; print('iocsearcher OK')"
    pytest --version
    ```
  </verify>
  <done>
    Virtual environment created with all dependencies installed. pyproject.toml, requirements.txt, .gitignore, and .env.example exist. All imports succeed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create app factory with security scaffold, Config, models, and test fixtures</name>
  <files>
    app/__init__.py
    app/config.py
    app/pipeline/__init__.py
    app/pipeline/models.py
    app/routes.py
    run.py
    tests/conftest.py
  </files>
  <action>
    Create the Flask application with all security defenses established before any routes:

    1. `app/config.py` — Config class:
       - Read `SECRET_KEY` from `os.environ`, fallback to `secrets.token_hex(32)`
       - Read `VIRUSTOTAL_API_KEY` from `os.environ` (optional in Phase 1)
       - `TRUSTED_HOSTS = ['localhost', '127.0.0.1']`
       - `MAX_CONTENT_LENGTH = 512 * 1024` (512 KB)
       - `WTF_CSRF_ENABLED = True`
       - `DEBUG = False` (hardcoded, never from env)
       - `ALLOWED_API_HOSTS` list (empty for Phase 1, structure for Phase 2 SSRF prevention per SEC-16)
       - `validate()` method that raises `ValueError` if online mode is configured but API keys are missing (SEC-03)
       - `TestConfig` subclass with `TESTING = True`, `WTF_CSRF_ENABLED = False`, `SERVER_NAME = 'localhost'`

    2. `app/__init__.py` — Application factory `create_app(config_override=None)`:
       - Load Config (or TestConfig via config_override)
       - Set `app.debug = False` (hardcoded — SEC-15)
       - Initialize `CSRFProtect(app)` (SEC-10)
       - Register blueprint from routes
       - `@app.after_request` setting security headers (SEC-09):
         - `Content-Security-Policy: default-src 'self'; script-src 'self'`
         - `X-Content-Type-Options: nosniff`
         - `X-Frame-Options: SAMEORIGIN`
         - `Referrer-Policy: no-referrer`
       - `@app.errorhandler(413)` returning user-friendly message with size limit stated (SEC-12)
       - Jinja2 autoescaping is on by default for .html templates — do NOT disable it (SEC-08)
       - No subprocess calls, no shell execution, no eval/exec (SEC-13)
       - No persistent storage of raw pasted text — pipeline is stateless per request (SEC-14)

    3. `app/routes.py` — Minimal blueprint with placeholder routes:
       - `bp = Blueprint('main', __name__)`
       - `GET /` → return "sentinelx" (placeholder, templates come in Plan 04)
       - `POST /analyze` → return "analyze" (placeholder)

    4. `app/pipeline/__init__.py` — Empty init file.

    5. `app/pipeline/models.py` — Data models:
       - `IOCType` enum with values: IPV4, IPV6, DOMAIN, URL, MD5, SHA1, SHA256, CVE
       - `IOC` frozen dataclass with fields: `type: IOCType`, `value: str` (canonical/refanged), `raw_match: str` (original from input)
       - `group_by_type(iocs: list[IOC]) -> dict[IOCType, list[IOC]]` utility function

    6. `run.py` — Entry point:
       - `from app import create_app`
       - `app = create_app()`
       - `app.run(host='127.0.0.1', port=5000, debug=False)` (SEC-01 — localhost only)
       - Guard with `if __name__ == '__main__':`

    7. `tests/conftest.py` — Pytest fixtures:
       - `@pytest.fixture` for `app` using `create_app({'TESTING': True, 'WTF_CSRF_ENABLED': False, 'SERVER_NAME': 'localhost'})`
       - `@pytest.fixture` for `client` using `app.test_client()`

    Important:
    - Use `python-dotenv` `load_dotenv()` in config.py for dev convenience, but `.env` is in `.gitignore` (SEC-02)
    - SECRET_KEY auto-generates if not in env — this is fine for dev (SEC-02)
    - No `|safe` anywhere in any template (SEC-08)
    - TRUSTED_HOSTS set to `['localhost', '127.0.0.1']` — Flask raises SecurityError → 400 for unrecognized hosts (SEC-11)
  </action>
  <verify>
    ```bash
    source .venv/bin/activate
    # App factory works
    python -c "from app import create_app; app = create_app(); print('Factory OK')"

    # Security properties
    python -c "
    from app import create_app
    app = create_app({'TESTING': True, 'WTF_CSRF_ENABLED': False, 'SERVER_NAME': 'localhost'})
    assert app.debug is False, 'Debug must be False'
    assert app.config['MAX_CONTENT_LENGTH'] == 512 * 1024, 'MAX_CONTENT_LENGTH wrong'
    assert app.config['TRUSTED_HOSTS'] == ['localhost', '127.0.0.1'], 'TRUSTED_HOSTS wrong'
    with app.test_client() as c:
        r = c.get('/')
        assert 'Content-Security-Policy' in r.headers, 'Missing CSP'
        assert \"default-src 'self'\" in r.headers['Content-Security-Policy'], 'Bad CSP'
    print('All security checks passed')
    "

    # Models work
    python -c "
    from app.pipeline.models import IOCType, IOC, group_by_type
    ioc = IOC(type=IOCType.IPV4, value='192.168.1.1', raw_match='192[.]168[.]1[.]1')
    assert ioc.type == IOCType.IPV4
    print('Models OK')
    "

    # Run bandit security scan
    bandit -r app/ -ll 2>&1 | tail -5
    ```
  </verify>
  <done>
    App factory creates Flask app with all security defenses active. Config class validates env vars. IOCType enum and IOC frozen dataclass exist. run.py binds to 127.0.0.1 only. Test fixtures provide app and client. bandit finds no high/critical issues. Debug mode is False. CSP, CSRF, TRUSTED_HOSTS, MAX_CONTENT_LENGTH all configured.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app import create_app; app = create_app()"` succeeds
2. All security headers present on responses (CSP, X-Content-Type-Options, X-Frame-Options, Referrer-Policy)
3. `app.debug is False` in all configurations
4. `app.config['TRUSTED_HOSTS']` is `['localhost', '127.0.0.1']`
5. `app.config['MAX_CONTENT_LENGTH']` is `512 * 1024`
6. `CSRFProtect` initialized
7. `IOCType` enum has all 8 types
8. `IOC` dataclass is frozen (immutable)
9. `run.py` uses `host='127.0.0.1'`
10. `bandit -r app/` reports no high/critical issues
</verification>

<success_criteria>
- Flask app factory runs with full security scaffold
- All 11 SEC requirements for this plan are structurally addressed
- IOC type system exists for pipeline plans to use
- Test fixtures exist for all subsequent plans
- No security misconfigurations detected by bandit
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-offline-pipeline/01-01-SUMMARY.md`
</output>
