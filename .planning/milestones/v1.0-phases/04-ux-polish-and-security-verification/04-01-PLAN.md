---
phase: 04-ux-polish-and-security-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/static/main.js
  - app/static/style.css
  - app/templates/results.html
autonomous: false
requirements:
  - UI-06

must_haves:
  truths:
    - "Analyst can distinguish 'NO RECORD' (provider has no data) from 'CLEAN' (provider explicitly reports benign) at a glance via distinct badge labels and colors"
    - "Providers returning 'no_data' are grouped into a collapsed section below active results, reducing visual noise"
    - "Progress counter reads 'N/M providers complete' matching actual done/total semantics"
    - "Badge text uses mapped display labels (MALICIOUS, SUSPICIOUS, CLEAN, NO RECORD, ERROR) — never raw verdict strings with underscores"
    - "Per-provider loading indicator shows remaining provider count after first result arrives for an IOC"
  artifacts:
    - path: "app/static/main.js"
      provides: "Verdict label map, no-data collapsed section logic, updated progress text, per-provider loading indicator"
      contains: "VERDICT_LABELS"
    - path: "app/static/style.css"
      provides: "Styling for no-data collapsed section, nodata summary"
      contains: "enrichment-nodata-section"
    - path: "app/templates/results.html"
      provides: "Updated initial progress counter text"
      contains: "providers complete"
  key_links:
    - from: "app/static/main.js"
      to: "app/static/style.css"
      via: "CSS class names for nodata section and verdict badges"
      pattern: "enrichment-nodata-section"
    - from: "app/static/main.js"
      to: "app/templates/results.html"
      via: "DOM element IDs for progress bar text and enrichment slots"
      pattern: "enrich-progress-text"
---

<objective>
Sharpen verdict clarity so SOC analysts can distinguish "no data found" from "explicitly clean" at a glance, implement collapsed no-data section grouping, update progress counter semantics, and add per-provider loading indicators.

Purpose: Fulfills UI-06 — the only remaining v1 requirement. Analysts need unambiguous visual signals to triage IOCs efficiently. "No record" vs "Clean" must be instantly distinguishable without reading detail text.

Output: Updated main.js with verdict label map, no-data section logic, progress text; updated style.css with no-data section styling; updated results.html with correct initial progress text.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ux-polish-and-security-verification/04-RESEARCH.md

Key existing code to read before modifying:
@app/static/main.js
@app/static/style.css
@app/templates/results.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement verdict label map, no-data collapsed section, progress counter, and per-provider loading indicator in main.js</name>
  <files>app/static/main.js</files>
  <action>
Modify app/static/main.js to implement the following changes. All DOM operations MUST use createElement + textContent only (no innerHTML — SEC-08). Follow existing ES5/var/IIFE style exactly.

1. **Add VERDICT_LABELS constant** (inside the IIFE, near the top after VERDICT_SEVERITY):

```javascript
var VERDICT_LABELS = {
    "malicious":  "MALICIOUS",
    "suspicious": "SUSPICIOUS",
    "clean":      "CLEAN",
    "no_data":    "NO RECORD",
    "error":      "ERROR"
};
```

2. **Update renderEnrichmentResult()** to:
   a. Use `VERDICT_LABELS[verdict] || verdict.toUpperCase()` for `badge.textContent` instead of raw verdict string.
   b. For `no_data` verdict results: instead of appending to the main slot, call `getOrCreateNodataSection(slot)` to get/create a `<details>` element, append the provider result row there, then update the summary count. Do NOT append `no_data` rows to the main enrichment slot directly.
   c. For non-`no_data` results: append to the main slot as currently done. After removing the spinner wrapper, also call `updatePendingIndicator()` to show remaining provider count.
   d. Update detail text for `clean` verdict to: `"Clean — scanned by " + result.total_engines + " engines"` (makes explicit that a scan happened, distinguishing from no_data).
   e. Update detail text for `no_data` verdict to: `"Not in " + result.provider + " database"` (analyst-friendly phrasing).

3. **Add getOrCreateNodataSection(slot) helper function:**
   - Check slot for existing `.enrichment-nodata-section` element.
   - If none: create `<details>` with className `"enrichment-nodata-section"` (collapsed by default — no `open` attribute). Create `<summary>` with className `"enrichment-nodata-summary"` and initial text `"1 provider: no record"`. Append summary to details, details to slot.
   - Return the details element.

4. **Add updateNodataSummary(detailsEl) helper function:**
   - Count `.provider-result-row` children inside the details element.
   - Update the `<summary>` textContent to `count + " provider" + (count !== 1 ? "s" : "") + ": no record"`.
   - Call this after appending each no_data result row.

5. **Add updatePendingIndicator(slot, receivedCount) helper function:**
   - Get total expected providers from a new per-IOC tracking object (see below).
   - Calculate remaining = totalExpected - receivedCount.
   - If remaining <= 0: remove existing `.enrichment-waiting-text` element from slot if present, return.
   - If remaining > 0: find or create a `<span>` with className `"enrichment-waiting-text enrichment-pending-text"`, set textContent to `remaining + " provider" + (remaining !== 1 ? "s" : "") + " still loading..."`.
   - Append the indicator to the slot (after result rows, before the nodata section).

6. **Track per-IOC result counts:**
   - Add `var iocResultCounts = {};` alongside the existing `iocVerdicts` object.
   - In renderEnrichmentResult, before rendering: `iocResultCounts[result.ioc_value] = (iocResultCounts[result.ioc_value] || 0) + 1;`
   - After rendering each result (both no_data and active), call `updatePendingIndicator(slot, iocResultCounts[result.ioc_value])`.
   - For totalExpected per IOC: read it from a `data-enrichable-count` attribute on the `.ioc-enrichment-row` element (will be set in results.html — see Task 2). Parse with `parseInt(targetRow.getAttribute("data-enrichable-count"), 10) || 0`.

7. **Update updateProgressBar():**
   - Change text from `done + "/" + total + " IOCs enriched"` to `done + "/" + total + " providers complete"`.

IMPORTANT: Do NOT use innerHTML anywhere. Do NOT introduce arrow functions, template literals, let/const, or any ES6+ syntax. Maintain the existing var/function/IIFE style throughout.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && python -m pytest tests/test_routes.py -x -q 2>&1 | tail -5</automated>
    <manual>Verify main.js has no syntax errors by checking the test suite still passes (routes load templates which reference main.js)</manual>
  </verify>
  <done>
    - VERDICT_LABELS constant exists and maps all 5 verdict strings to display labels
    - badge.textContent uses VERDICT_LABELS lookup, never raw verdict string
    - no_data results are routed to a collapsed details section via getOrCreateNodataSection()
    - Progress text reads "N/M providers complete"
    - Per-provider loading indicator shows remaining count after first result arrives
    - Clean verdict detail text explicitly mentions engine count
    - No innerHTML usage anywhere in the file
    - All existing functionality preserved (copy, export, polling)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update results.html progress text and add per-IOC enrichable count, add no-data section CSS styling</name>
  <files>app/templates/results.html, app/static/style.css</files>
  <action>
**results.html changes:**

1. Update the initial progress counter text (line 40) from:
   `Enriching 0/{{ enrichable_count }} IOCs...`
   to:
   `0/{{ enrichable_count }} providers complete`

2. Add `data-enrichable-count` attribute to each `.ioc-enrichment-row` element. This attribute tells JS how many providers are expected for each IOC.
   - The template already has `data-ioc-value="{{ ioc.value }}"` on the enrichment row.
   - Add a new attribute `data-enrichable-count` — but we need per-IOC enrichable count, not global. The simplest approach: pass a dict `ioc_enrichable_counts` from the route keyed by ioc.value. Alternatively, since this requires a Python route change, use a different approach:
   - **Preferred approach (no Python change):** Add `data-ioc-type="{{ ioc.type.value }}"` to the `.ioc-enrichment-row` element (it's already on the copy button but not on the enrichment row). Then in main.js, use a JS constant `IOC_PROVIDER_COUNTS` that maps IOC type to expected provider count:
     ```
     var IOC_PROVIDER_COUNTS = {
         "ipv4": 2, "ipv6": 2, "domain": 2, "url": 2,
         "md5": 3, "sha1": 3, "sha256": 3
     };
     ```
     (VT supports all 7 enrichable types, MB supports md5/sha1/sha256, TF supports all 7 — so hashes get 3 providers, others get 2.)
   - **IMPORTANT: Put IOC_PROVIDER_COUNTS in main.js (Task 1 file), not in the template.** The template change is just adding `data-ioc-type` to the enrichment row.
   - Update the enrichment row `<tr>` tag from:
     `<tr class="ioc-enrichment-row" data-ioc-value="{{ ioc.value }}">`
     to:
     `<tr class="ioc-enrichment-row" data-ioc-value="{{ ioc.value }}" data-ioc-type="{{ ioc.type.value }}">`

Note: The `IOC_PROVIDER_COUNTS` constant should also be added to main.js. Update Task 1's updatePendingIndicator to read `data-ioc-type` from targetRow and look up in IOC_PROVIDER_COUNTS instead of using `data-enrichable-count`.

**style.css changes:**

Add styles for the no-data collapsed section at the end of the enrichment UI section (after `.enrichment-summary`):

```css
/* No-data collapsed section — groups providers with no record */
.enrichment-nodata-section {
    margin-top: 0.35rem;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background-color: var(--bg-tertiary);
}

.enrichment-nodata-summary {
    padding: 0.35rem 0.75rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
    cursor: pointer;
    user-select: none;
    list-style: none;
}

.enrichment-nodata-summary::-webkit-details-marker {
    display: none;
}

.enrichment-nodata-summary::before {
    content: "\25B6";
    font-size: 0.5rem;
    margin-right: 0.4rem;
    display: inline-block;
    transition: transform 0.15s ease;
}

.enrichment-nodata-section[open] .enrichment-nodata-summary::before {
    transform: rotate(90deg);
}

.enrichment-nodata-section .provider-result-row {
    padding: 0.25rem 0.75rem;
}
```

These styles match the existing dark theme: muted background, small font, collapsed by default with triangle indicator — consistent with the `.ioc-group` accordion pattern established in Phase 1.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && python -m pytest tests/test_routes.py -x -q 2>&1 | tail -5</automated>
    <manual>Check that results.html renders without Jinja2 errors and the new CSS classes are syntactically valid</manual>
  </verify>
  <done>
    - results.html progress text says "0/N providers complete" not "Enriching 0/N IOCs..."
    - Each ioc-enrichment-row has data-ioc-type attribute for JS provider count lookup
    - style.css has .enrichment-nodata-section styling with collapsed details/summary pattern
    - Nodata section uses muted colors matching dark theme
    - No |safe filter used anywhere in the template changes
    - No inline scripts added
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification of verdict clarity UX</name>
  <files>app/static/main.js, app/static/style.css, app/templates/results.html</files>
  <action>
Human visual verification of the verdict clarity UX implemented in Tasks 1-2.

What was built: Verdict clarity UX with distinct badge labels (MALICIOUS, SUSPICIOUS, CLEAN, NO RECORD, ERROR), collapsed no-data section, progress counter as "providers complete", per-provider loading indicators.
  </action>
  <verify>
    1. Start the app: `cd /home/chris/projects/sentinelx && source venv/bin/activate && python run.py`
    2. Open http://127.0.0.1:5000 in a browser
    3. Paste a SHA256 hash (e.g. `e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855`) and select Online Mode
    4. Submit and observe:
       a. Progress bar text reads "0/3 providers complete" (3 = VT + MB + TF for SHA256)
       b. As results arrive, badge labels show "MALICIOUS", "CLEAN", "NO RECORD", "SUSPICIOUS", or "ERROR" — never raw strings like "no_data"
       c. Providers returning "no_data" are grouped into a collapsed "N providers: no record" section below any active findings
       d. "CLEAN" badge is green; "NO RECORD" badge is gray/muted — visually distinct
       e. After first result arrives for an IOC, remaining providers show "N providers still loading..." text
       f. On completion, progress bar turns green and reads "Enrichment complete"
    5. Also test with a domain (e.g. `example.com`) — should show 2 providers expected
    6. Verify export button still works after enrichment completes
  </verify>
  <done>All visual verification items confirmed by human tester. Verdict clarity is unambiguous at a glance.</done>
</task>

</tasks>

<verification>
- [ ] Badge labels use VERDICT_LABELS map — no raw verdict strings displayed
- [ ] "NO RECORD" (gray/muted) visually distinct from "CLEAN" (green) at a glance
- [ ] No-data results grouped into collapsed `<details>` section per IOC
- [ ] Progress counter text matches "N/M providers complete" pattern
- [ ] Per-provider loading indicator counts down remaining providers
- [ ] All DOM operations use createElement + textContent (no innerHTML)
- [ ] No |safe filter in templates
- [ ] No inline scripts added
- [ ] Existing copy/export/polling functionality preserved
</verification>

<success_criteria>
UI-06 is fully implemented: an analyst looking at enrichment results can instantly distinguish "NO RECORD" (provider has no data about this IOC) from "CLEAN" (provider scanned and reports benign) via distinct badge labels, colors, and grouping. The UX communicates enrichment progress with correct "providers complete" semantics.
</success_criteria>

<output>
After completion, create `.planning/phases/04-ux-polish-and-security-verification/04-01-SUMMARY.md`
</output>
