# Phase 3.1: Integration Fixes and Git Hygiene - Research

**Researched:** 2026-02-22
**Domain:** CSP compliance, git hygiene, documentation reconciliation
**Confidence:** HIGH

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

#### Documentation scope
- Fix BOTH ROADMAP.md checkboxes AND Phase 3 SUMMARY.md inaccuracies — full doc reconciliation
- ROADMAP.md: only fix the 6 audit-flagged checkboxes (Phase 2: 02-02/03/04, Phase 3: 03-01/02/03) — not a full audit of all phases
- SUMMARY.md: targeted fix only — correct the "per-adapter helper copies" wording to reflect the shared `http_safety.py` module. Do NOT review other factual claims in summaries
- Milestone audit report (`.planning/v1.0-MILESTONE-AUDIT.md`): update resolved items to reflect current status after fixes are applied — do not leave as historical snapshot

### Claude's Discretion
- Commit organization (atomic per fix vs grouped)
- Script migration approach (how to structure `initSettingsPage()` in `main.js`)
- Testing strategy for the JS migration
- Order of operations for the fixes

### Deferred Ideas (OUT OF SCOPE)

None — discussion stayed within phase scope
</user_constraints>

---

## Summary

Phase 3.1 is a gap-closure phase with no new features. Its job is to fix one CSP regression (inline `<script>` in settings.html), commit two planning documents to git, and correct two SUMMARY.md files that describe a code pattern that was superseded by the `http_safety.py` refactor commit.

**Critical discovery:** The milestone audit was written on 2026-02-21, before commit `a716378` (refactor: extract shared HTTP safety utils). That commit already resolved two of the six originally-flagged audit items: `http_safety.py` is now tracked in git, and the working directory is clean of code changes. The ROADMAP.md plan-level checkboxes were also already correct at the time of audit (they were `[x]` throughout). This means Phase 3.1 has a smaller actual scope than the audit suggested.

**Primary recommendation:** Fix the CSP regression (1 code change), update the two SUMMARY.md files with accurate wording, commit the milestone audit planning document, and update the audit report to reflect resolved items — all in a single focused plan.

---

## Current State Assessment (as of research date)

This is the ground truth — verified by direct file inspection and `git status`.

### Item-by-item audit status

| Audit Item | Originally Flagged | Current Status | Action Needed |
|------------|-------------------|----------------|---------------|
| Inline `<script>` in `settings.html` lines 64-80 | CRITICAL | **STILL PRESENT** | YES — migrate to `main.js` |
| `http_safety.py` untracked in git | CRITICAL | **RESOLVED** (commit `a716378`) | NO — already committed |
| Uncommitted working directory changes | TECH DEBT | **RESOLVED** (commit `a716378`) | NO — tree is clean |
| ROADMAP.md plan-level checkboxes stale | TECH DEBT | **RESOLVED** (checkboxes were already `[x]`) | NO — already correct |
| SUMMARY.md "per-adapter helper copies" inaccuracy | TECH DEBT | **STILL PRESENT** in 03-01 and 03-02 | YES — update wording |
| Milestone audit report not committed | IMPLICIT | **PENDING** (file is untracked `??`) | YES — commit the file |

### What `git status` actually shows

```
On branch main
Untracked files:
  .planning/v1.0-MILESTONE-AUDIT.md    ← needs to be committed
  everything-claude-code/              ← unrelated, do not touch
```

There are no staged or unstaged modifications to tracked files. The tree is clean except for the planning document.

---

## Standard Stack

No new libraries or frameworks required. This phase operates entirely within the existing stack:

| Technology | Version | Purpose | Notes |
|------------|---------|---------|-------|
| Vanilla JS (ES5-compatible) | — | CSP-compliant scripts | All existing `main.js` code is ES5 |
| Jinja2 templates | — | HTML template editing | Remove `<script>` block from settings.html |
| Git | — | Version control | `git add` + `git commit` |

**Installation:** None required.

---

## Architecture Patterns

### Pattern 1: main.js Init Function Pattern

The existing `main.js` follows a consistent IIFE pattern where each UI feature gets its own `init*()` function:

```javascript
// Source: app/static/main.js (lines 26-394)
(function () {
    "use strict";

    function initSubmitButton() {
        var form = document.getElementById("analyze-form");
        if (!form) return;           // ← guard: no-op on pages without this element
        // ... attaches listeners
    }

    function initCopyButtons() { ... }
    function initEnrichmentPolling() { ... }
    function initExportButton() { ... }

    // Initialization block — each function guards itself with early return
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", function () {
            initSubmitButton();
            initCopyButtons();
            initEnrichmentPolling();
            initExportButton();
        });
    } else {
        initSubmitButton();
        initCopyButtons();
        initEnrichmentPolling();
        initExportButton();
    }
}());
```

**Key design:** Every `init*()` function begins with a guard that checks for a page-specific DOM element and returns early if not found. This means all init functions are called on every page but only activate on pages where their elements exist. `initSettingsPage()` must follow this same pattern.

### Pattern 2: initSettingsPage() Implementation

The inline script to be migrated (settings.html lines 64-80):

```javascript
// Current inline script — violates CSP script-src 'self'
(function () {
    var btn = document.getElementById('toggle-key-btn');
    var input = document.getElementById('api-key');
    if (btn && input) {
        btn.addEventListener('click', function () {
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'Show';
            }
        });
    }
}());
```

This becomes `initSettingsPage()` in `main.js`:

```javascript
// Source: pattern derived from existing main.js init functions
function initSettingsPage() {
    var btn = document.getElementById('toggle-key-btn');
    var input = document.getElementById('api-key');
    if (!btn || !input) return;      // guard: no-op on non-settings pages
    btn.addEventListener('click', function () {
        if (input.type === 'password') {
            input.type = 'text';
            btn.textContent = 'Hide';
        } else {
            input.type = 'password';
            btn.textContent = 'Show';
        }
    });
}
```

Then add `initSettingsPage()` to both branches of the DOMContentLoaded block.

### Pattern 3: SUMMARY.md Wording Fix

**Inaccurate wording** (appears in both 03-01-SUMMARY.md and 03-02-SUMMARY.md):

- 03-01-SUMMARY.md, `patterns-established` frontmatter line 48:
  ```
  "Shared helper isolation: _validate_endpoint and _read_limited copied per-module
  (not extracted to shared utils) — deliberate isolation matches adapter-per-file pattern"
  ```
- 03-01-SUMMARY.md body line 101:
  ```
  "Helper functions (`_validate_endpoint`, `_read_limited`) copied into MBAdapter module for
  isolation — deliberate choice to keep adapters self-contained"
  ```
- 03-02-SUMMARY.md, `patterns-established` frontmatter line 23:
  ```
  "Per-adapter isolation: each adapter module copies _validate_endpoint and _read_limited helpers"
  ```
- 03-02-SUMMARY.md body line 94:
  ```
  "Per-adapter helper isolation: Each adapter module contains its own copy of
  `_validate_endpoint` and `_read_limited` rather than a shared utilities module..."
  ```

**Accurate replacement:** These should note that the pattern was initially per-adapter but was subsequently extracted to `app/enrichment/http_safety.py` in commit `a716378`. The CONTEXT.md says: "correct the 'per-adapter helper copies' wording to reflect the shared `http_safety.py` module."

### Pattern 4: Milestone Audit Report Update

The audit report frontmatter uses YAML structure with an `integration` section and `tech_debt` section listing gaps. After Phase 3.1 fixes are applied, items that were resolved should be marked resolved in the report. The report should not remain as a pure historical snapshot — the CONTEXT.md decision explicitly says to update resolved items.

### Anti-Patterns to Avoid

- **Touching settings.html's Jinja2 logic:** Only remove the `<script>` block (lines 64-80). Do not modify the form, flash messages, or template structure.
- **Using innerHTML in the new initSettingsPage():** The existing code only sets `input.type` and `btn.textContent` — both are safe. Do not introduce any innerHTML.
- **Reviewing all SUMMARY.md claims:** CONTEXT.md explicitly says "Do NOT review other factual claims in summaries." Fix only the flagged per-adapter helper wording.
- **Touching `everything-claude-code/`:** This is an unrelated untracked directory. Leave it alone.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Script isolation | Custom module system | IIFE + existing main.js pattern | Already established, CSP-compliant |
| DOM-ready detection | Custom readyState watcher | Existing DOMContentLoaded pattern in main.js | Already proven to work with `defer` attribute |

**Key insight:** All patterns needed already exist in the codebase. This phase is strictly additive to `main.js` and subtractive from `settings.html`.

---

## Common Pitfalls

### Pitfall 1: Script Tag Position in settings.html

**What goes wrong:** The `<script>` block is at the bottom of `settings.html` (lines 64-80), after the `{% endblock %}` would normally be. Removing it could leave a trailing blank line or orphan the `{% endblock %}` marker if not careful.

**Why it happens:** The `<script>` was inserted after the form section, before `{% endblock %}`.

**How to avoid:** Remove lines 64-80 inclusive (the entire `<script>...</script>` block). Verify `{% endblock %}` remains on the last line.

**Warning signs:** Template parse error if `{% endblock %}` is accidentally removed.

### Pitfall 2: main.js Initialization Coverage

**What goes wrong:** Adding `initSettingsPage()` to the `DOMContentLoaded` listener but forgetting the `else` branch (for when DOM is already ready when the script runs).

**Why it happens:** There are two identical init call blocks in main.js — one for loading state and one for already-ready state. Editors scanning for "the initialization block" often only see the first one.

**How to avoid:** Add `initSettingsPage()` to both the DOMContentLoaded callback (line 386) and the else branch (line 392). The existing pattern shows 4 calls in each branch.

**Warning signs:** Show/Hide toggle works after hard reload but not after navigation (or vice versa).

### Pitfall 3: Testing the JS Migration Without a Browser

**What goes wrong:** No automated test infrastructure exists for the show/hide toggle behavior. Assuming the migration works without verification.

**Why it happens:** `main.js` tests are not part of the existing Python test suite. Manual testing is the validation path.

**How to avoid:** After the migration, manually verify: start the app, navigate to /settings, click "Show" — the password field should reveal, button should say "Hide". Click again — should return to password type.

**Warning signs:** Browser console errors about `initSettingsPage is not a function` (if accidentally placed outside the IIFE), or the button doing nothing (if the init call was missed).

### Pitfall 4: git status After Committing the Audit File

**What goes wrong:** Committing `.planning/v1.0-MILESTONE-AUDIT.md` to satisfy "clean working tree" but not actually verifying git status afterwards.

**Why it happens:** Automated commits can fail silently or partially stage.

**How to avoid:** Run `git status` after every commit and verify the expected files appear in `git log --name-only HEAD`.

---

## Code Examples

### Adding initSettingsPage to main.js

```javascript
// Source: main.js IIFE pattern — add after initExportButton function (~line 377)

// ---- Settings page: show/hide API key toggle ----

function initSettingsPage() {
    var btn = document.getElementById('toggle-key-btn');
    var input = document.getElementById('api-key');
    if (!btn || !input) return;
    btn.addEventListener('click', function () {
        if (input.type === 'password') {
            input.type = 'text';
            btn.textContent = 'Hide';
        } else {
            input.type = 'password';
            btn.textContent = 'Show';
        }
    });
}

// Then update both initialization branches:
if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", function () {
        initSubmitButton();
        initCopyButtons();
        initEnrichmentPolling();
        initExportButton();
        initSettingsPage();          // ← add here
    });
} else {
    initSubmitButton();
    initCopyButtons();
    initEnrichmentPolling();
    initExportButton();
    initSettingsPage();              // ← and here
}
```

### Removing the inline script from settings.html

```html
<!-- BEFORE (settings.html lines 62-81): -->
        </section>
    </div>
</div>

<script>
(function () {
    var btn = document.getElementById('toggle-key-btn');
    var input = document.getElementById('api-key');
    if (btn && input) {
        btn.addEventListener('click', function () {
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'Show';
            }
        });
    }
}());
</script>
{% endblock %}

<!-- AFTER (settings.html — remove lines 64-80, keep endblock): -->
        </section>
    </div>
</div>

{% endblock %}
```

### Corrected SUMMARY.md wording

```
# Replace the inaccurate "per-adapter helper copies" pattern with:

"Shared HTTP safety module: validate_endpoint and read_limited initially copied
per-adapter; subsequently extracted to app/enrichment/http_safety.py
(commit a716378) — adapters now import from the shared module"
```

### Git operations

```bash
# Commit the milestone audit report (currently untracked)
git add .planning/v1.0-MILESTONE-AUDIT.md
git commit -m "docs(audit): add v1.0 milestone audit report"

# After CSP fix:
git add app/templates/settings.html app/static/main.js
git commit -m "fix(csp): migrate settings inline script to main.js (SEC-09)"

# After doc fixes:
git add .planning/phases/03-additional-ti-providers/03-01-SUMMARY.md
git add .planning/phases/03-additional-ti-providers/03-02-SUMMARY.md
git commit -m "docs(03): correct http_safety.py per-adapter helper wording in summaries"
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|-----------------|--------------|--------|
| Per-adapter copies of `_validate_endpoint` and `_read_limited` | Shared `app/enrichment/http_safety.py` | Commit `a716378` (2026-02-21) | Audit item 2 already resolved |
| `http_safety.py` untracked in git | Tracked and committed | Commit `a716378` (2026-02-21) | Audit item 3 already resolved |
| Working directory had uncommitted adapter changes | Clean working tree | Commit `a716378` (2026-02-21) | Audit item 4 already resolved |
| Inline `<script>` in settings.html | **Still inline — not yet fixed** | Not yet changed | CSP regression still present |

**Key insight for planning:** The audit was written before commit `a716378`. Three of the six flagged items are already resolved. The planner should scope the phase to only what is actually still needed.

---

## Open Questions

1. **Commit organization: atomic vs grouped**
   - What we know: CONTEXT.md leaves this to Claude's discretion
   - Recommendation: Atomic commits make sense — one commit per logical fix: (a) CSP fix with JS migration, (b) SUMMARY.md doc corrections, (c) audit report commit + update. Three commits total is clean and reviewable.

2. **Whether to update the milestone audit report's YAML frontmatter**
   - What we know: CONTEXT.md says "update resolved items to reflect current status after fixes are applied"
   - What's unclear: The YAML frontmatter tracks `integration: 3/5` and lists gaps. After Phase 3.1 closes the gaps, the score becomes `integration: 5/5` and the `integration` gaps list becomes empty.
   - Recommendation: Update both the YAML frontmatter scores and the body text in the audit report to reflect resolved status.

3. **Whether the 03-03-SUMMARY.md also needs correction**
   - What we know: The audit flagged "Phase 3 SUMMARYs" (plural). Research confirmed 03-01 and 03-02 have the inaccurate wording. 03-03-SUMMARY.md was checked and does NOT contain "per-adapter helper copies" language — it was written after the refactor pattern was established.
   - Recommendation: Only update 03-01 and 03-02. Skip 03-03.

---

## Sources

### Primary (HIGH confidence)
- Direct file inspection: `app/templates/settings.html` — inline script confirmed present (lines 64-80)
- Direct file inspection: `app/static/main.js` — init function pattern confirmed (lines 26-396)
- `git status` output — confirmed only `.planning/v1.0-MILESTONE-AUDIT.md` and unrelated directory are untracked
- `git ls-files app/enrichment/http_safety.py` — confirmed tracked
- `git show a716378 --stat` — confirmed http_safety.py added in this commit
- `.planning/v1.0-MILESTONE-AUDIT.md` — original audit report, verified all findings against current code
- `.planning/phases/03.1-integration-fixes-git-hygiene/03.1-CONTEXT.md` — locked user decisions

### Secondary (MEDIUM confidence)
- Phase 3 SUMMARY.md files (03-01, 03-02) — confirmed inaccurate per-adapter helper wording still present
- `python3 -m pytest tests/ --ignore=tests/e2e -q` — 221 passed, 0 failed, confirming test suite is healthy

---

## Metadata

**Confidence breakdown:**
- Current state assessment: HIGH — verified directly via `git status`, file reads, and `git show`
- CSP fix approach: HIGH — pattern matches existing main.js exactly; straightforward extraction
- Doc fix locations: HIGH — confirmed exact lines with grep and file reads
- Commit organization: MEDIUM — left to Claude's discretion; recommendation is advisory

**Research date:** 2026-02-22
**Valid until:** No expiry concern — this phase fixes static code and documentation with no external dependencies
