---
phase: 13-results-page-redesign
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - app/templates/partials/_empty_state.html
  - app/templates/partials/_verdict_dashboard.html
  - app/templates/partials/_enrichment_slot.html
  - app/static/src/input.css
  - app/static/dist/style.css
  - app/static/main.js
  - tests/e2e/pages/results_page.py
autonomous: true
requirements:
  - RESULTS-05
  - RESULTS-06
  - RESULTS-07

must_haves:
  truths:
    - "Empty state displays shield icon with 'No IOCs detected' headline and supported types body text"
    - "Verdict dashboard shows 4 KPI cards with large monospace numbers and colored top borders"
    - "Pending enrichment slots show animated shimmer rectangles instead of a spinner"
    - "KPI dashboard click-to-filter still works (JS data-attribute contracts preserved)"
    - "Shimmer disappears when enrichment results arrive (JS .spinner-wrapper removal preserved)"
  artifacts:
    - path: "app/templates/partials/_empty_state.html"
      provides: "Icon + headline + body empty state"
      contains: "empty-state"
    - path: "app/templates/partials/_verdict_dashboard.html"
      provides: "KPI card grid with monospace counts"
      contains: "verdict-kpi-card"
    - path: "app/templates/partials/_enrichment_slot.html"
      provides: "Shimmer skeleton loader"
      contains: "shimmer-line"
    - path: "app/static/src/input.css"
      provides: "CSS for empty state, KPI cards, shimmer animation"
      contains: "shimmer"
  key_links:
    - from: "app/templates/partials/_verdict_dashboard.html"
      to: "app/static/main.js"
      via: "[data-verdict-count] and [data-verdict] attributes"
      pattern: "data-verdict-count"
    - from: "app/templates/partials/_enrichment_slot.html"
      to: "app/static/main.js"
      via: ".spinner-wrapper class preserved for JS removal"
      pattern: "spinner-wrapper"
    - from: "app/static/main.js"
      to: "app/templates/partials/_verdict_dashboard.html"
      via: ".verdict-dashboard-badge[data-verdict] → .verdict-kpi-card[data-verdict] selector update"
      pattern: "verdict-kpi-card.*data-verdict"
---

<objective>
Redesign the empty state, verdict dashboard, and enrichment loading state — replacing minimal text with an icon treatment, inline pills with KPI cards, and spinners with shimmer skeleton loaders.

Purpose: These three features complete the visual elevation of the results page. The KPI dashboard provides at-a-glance severity scanning. The shimmer loader matches the Linear/Vercel aesthetic. The empty state gives users clear guidance when no IOCs are found.

Output: Updated partial templates with new HTML structures, CSS for KPI cards/shimmer/empty-state, and a JS selector update for the dashboard click handler.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-results-page-redesign/13-RESEARCH.md
@.planning/phases/13-results-page-redesign/13-01-SUMMARY.md
@app/templates/partials/_empty_state.html
@app/templates/partials/_verdict_dashboard.html
@app/templates/partials/_enrichment_slot.html
@app/static/src/input.css
@app/static/main.js
@tests/e2e/pages/results_page.py

<interfaces>
<!-- JS contracts in main.js that MUST be preserved or carefully updated:

     1. Spinner removal (line 422):
        var spinnerWrapper = slot.querySelector(".spinner-wrapper");
        if (spinnerWrapper) { slot.removeChild(spinnerWrapper); }
        → KEEP the class name .spinner-wrapper on the shimmer wrapper. Zero JS change needed.

     2. Verdict count update (line 251):
        var countEl = dashboard.querySelector('[data-verdict-count="' + verdicts[j] + '"]');
        → KEEP [data-verdict-count="malicious"] etc. on the new KPI card count spans.

     3. Dashboard badge click handler (line 725):
        var dashBadges = dashboard.querySelectorAll(".verdict-dashboard-badge[data-verdict]");
        badge.getAttribute("data-verdict")
        → UPDATE selector from .verdict-dashboard-badge to .verdict-kpi-card
          This is the ONE JS change needed in this plan.

     4. Card data attributes (line 623-644) — unchanged, not affected by this plan.

     Page Object Model (tests/e2e/pages/results_page.py):
       - self.no_results_box = page.locator(".no-results") → UPDATE to ".empty-state"
       - self.no_results_hint = page.locator(".no-results-hint") → UPDATE to ".empty-state-body"
       - self.dashboard_badges = page.locator(".verdict-dashboard-badge") → UPDATE to ".verdict-kpi-card"
       - self.click_dashboard_badge uses .verdict-dashboard-badge → UPDATE to .verdict-kpi-card
-->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign empty state with icon treatment</name>
  <files>
    app/templates/partials/_empty_state.html,
    app/static/src/input.css,
    tests/e2e/pages/results_page.py
  </files>
  <action>
    **A. Replace `_empty_state.html` content**

    The partial currently contains the `.no-results` div. Replace it entirely with:

    ```html
    {% from "macros/icons.html" import icon %}
    <div class="empty-state">
        <div class="empty-state-icon">
            {{ icon("shield-check", class="empty-state-svg", aria_label="No IOCs detected") }}
        </div>
        <h2 class="empty-state-headline">No IOCs detected</h2>
        <p class="empty-state-body">
            Supported types: IPv4, IPv6, domain, URL, MD5, SHA1, SHA256, CVE
        </p>
    </div>
    ```

    **B. Add CSS for empty state in `input.css`**

    Replace the existing `.no-results` CSS block (`.no-results`, `.no-results p`, `.no-results-hint`) with:

    ```css
    /* ---- Empty state ---- */

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }

    .empty-state-icon {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
    }

    .empty-state-svg {
        width: 48px;
        height: 48px;
        color: var(--text-muted);
        opacity: 0.6;
    }

    .empty-state-headline {
        font-size: 1.125rem;
        font-weight: var(--weight-heading);
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .empty-state-body {
        font-size: 0.85rem;
        color: var(--text-secondary);
    }
    ```

    **C. Update Page Object Model**

    In `tests/e2e/pages/results_page.py`, update the selectors for the no-results state:

    Change:
    ```python
    self.no_results_box = page.locator(".no-results")
    self.no_results_hint = page.locator(".no-results-hint")
    ```
    To:
    ```python
    self.no_results_box = page.locator(".empty-state")
    self.no_results_hint = page.locator(".empty-state-body")
    ```

    The `expect_no_results` method uses these locators and checks for "Supported types" text, which is preserved in the new markup.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && make css && python3 -m pytest tests/e2e/test_extraction.py::test_no_iocs_found -q -x 2>&1 | tail -5</automated>
  </verify>
  <done>
    Empty state shows shield-check icon + "No IOCs detected" headline + supported types body. test_no_iocs_found passes. Old .no-results CSS removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade verdict dashboard to KPI cards + shimmer skeleton loader</name>
  <files>
    app/templates/partials/_verdict_dashboard.html,
    app/templates/partials/_enrichment_slot.html,
    app/static/src/input.css,
    app/static/main.js,
    tests/e2e/pages/results_page.py
  </files>
  <action>
    **A. Replace `_verdict_dashboard.html` with KPI card grid**

    Replace the entire content with:

    ```html
    <div class="verdict-dashboard" id="verdict-dashboard">
        <div class="verdict-kpi-card verdict-kpi-card--malicious" data-verdict="malicious"
             role="button" tabindex="0">
            <span class="verdict-kpi-count" data-verdict-count="malicious">0</span>
            <span class="verdict-kpi-label">Malicious</span>
        </div>
        <div class="verdict-kpi-card verdict-kpi-card--suspicious" data-verdict="suspicious"
             role="button" tabindex="0">
            <span class="verdict-kpi-count" data-verdict-count="suspicious">0</span>
            <span class="verdict-kpi-label">Suspicious</span>
        </div>
        <div class="verdict-kpi-card verdict-kpi-card--clean" data-verdict="clean"
             role="button" tabindex="0">
            <span class="verdict-kpi-count" data-verdict-count="clean">0</span>
            <span class="verdict-kpi-label">Clean</span>
        </div>
        <div class="verdict-kpi-card verdict-kpi-card--no_data" data-verdict="no_data"
             role="button" tabindex="0">
            <span class="verdict-kpi-count" data-verdict-count="no_data">0</span>
            <span class="verdict-kpi-label">No Data</span>
        </div>
    </div>
    ```

    CRITICAL: Preserve `id="verdict-dashboard"`, all `data-verdict` and `data-verdict-count` attributes exactly.

    **B. Replace `_enrichment_slot.html` with shimmer skeleton**

    Replace the entire content with shimmer rectangles. KEEP the `.spinner-wrapper` class name so JS can remove it without changes:

    ```html
    <div class="enrichment-slot">
        <div class="spinner-wrapper shimmer-wrapper">
            <div class="shimmer-line shimmer-line--wide"></div>
            <div class="shimmer-line shimmer-line--medium"></div>
            <div class="shimmer-line shimmer-line--narrow"></div>
        </div>
    </div>
    ```

    The dual class `.spinner-wrapper.shimmer-wrapper` ensures JS still finds and removes the wrapper by `.spinner-wrapper` (line 422 of main.js).

    **C. Add CSS for KPI cards and shimmer**

    In `input.css`, replace the existing `.verdict-dashboard`, `.verdict-dashboard-badge`, and `.verdict-dashboard-count` CSS blocks with the new KPI card styles:

    ```css
    /* ---- Verdict Dashboard (KPI Cards) ---- */

    .verdict-dashboard {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }

    .verdict-kpi-card {
        background-color: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        border-top: 3px solid var(--border);
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: background-color 0.15s ease, border-color 0.15s ease;
        text-align: left;
    }

    .verdict-kpi-card:hover {
        background-color: var(--bg-tertiary);
        border-color: var(--border-hover);
    }

    .verdict-kpi-card--malicious  { border-top-color: var(--verdict-malicious-border); }
    .verdict-kpi-card--suspicious { border-top-color: var(--verdict-suspicious-border); }
    .verdict-kpi-card--clean      { border-top-color: var(--verdict-clean-border); }
    .verdict-kpi-card--no_data    { border-top-color: var(--verdict-no-data-border); }

    .verdict-kpi-count {
        font-family: var(--font-mono);
        font-size: 1.75rem;
        font-weight: 700;
        line-height: 1;
        display: block;
        color: var(--text-primary);
    }

    .verdict-kpi-label {
        font-size: 0.72rem;
        font-variant: small-caps;
        letter-spacing: 0.06em;
        color: var(--text-secondary);
        margin-top: 0.25rem;
        display: block;
    }
    ```

    Add KPI card responsive breakpoint in the existing `@media (max-width: 640px)` block:
    ```css
    .verdict-dashboard {
        grid-template-columns: repeat(2, 1fr);
    }
    ```

    Add shimmer CSS after the enrichment UI section:

    ```css
    /* ---- Shimmer Skeleton ---- */

    @keyframes shimmer {
        0%   { background-position: -468px 0; }
        100% { background-position: 468px 0; }
    }

    .shimmer-wrapper {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .shimmer-line {
        background: linear-gradient(
            to right,
            var(--bg-tertiary) 8%,
            var(--bg-hover)    18%,
            var(--bg-tertiary) 33%
        );
        background-size: 936px 100%;
        animation: shimmer 1.4s linear infinite;
        border-radius: var(--radius-sm);
        height: 12px;
    }

    .shimmer-line--wide   { width: 85%; }
    .shimmer-line--medium { width: 65%; }
    .shimmer-line--narrow { width: 45%; }
    ```

    Also remove the old `.enrichment-spinner` and `.enrichment-pending-text` CSS rules and the `@keyframes spin` since the spinner is replaced by shimmer. BUT CHECK FIRST: if `@keyframes spin` is used elsewhere, keep it. If only used by `.enrichment-spinner`, remove it.

    **D. Update main.js dashboard badge click handler**

    In `main.js`, line ~725, change the selector from `.verdict-dashboard-badge[data-verdict]` to `.verdict-kpi-card[data-verdict]`:

    Change:
    ```javascript
    var dashBadges = dashboard.querySelectorAll(".verdict-dashboard-badge[data-verdict]");
    ```
    To:
    ```javascript
    var dashBadges = dashboard.querySelectorAll(".verdict-kpi-card[data-verdict]");
    ```

    This is the ONLY JS change needed. The `.spinner-wrapper` removal logic stays unchanged.

    **E. Update Page Object Model**

    In `tests/e2e/pages/results_page.py`, update the dashboard badge selectors:

    Change `dashboard_badges` property:
    ```python
    return self.page.locator(".verdict-dashboard-badge")
    ```
    To:
    ```python
    return self.page.locator(".verdict-kpi-card")
    ```

    Change `click_dashboard_badge` method:
    ```python
    self.page.locator(f".verdict-dashboard-badge[data-verdict='{verdict}']").click()
    ```
    To:
    ```python
    self.page.locator(f".verdict-kpi-card[data-verdict='{verdict}']").click()
    ```

    **F. Build CSS**

    Run `make css` to regenerate `app/static/dist/style.css`.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && make css && python3 -m pytest tests/e2e/ -q -x 2>&1 | tail -20</automated>
  </verify>
  <done>
    1. Verdict dashboard shows 4 KPI cards (grid layout) with large monospace counts and colored top borders — RESULTS-06 done
    2. Empty enrichment slots show shimmer rectangles instead of spinner — RESULTS-07 done
    3. Empty state has icon + headline + body — RESULTS-05 done (from Task 1)
    4. Dashboard click-to-filter works (JS updated)
    5. Shimmer removed by JS on enrichment result (spinner-wrapper class preserved)
    6. All E2E tests pass (except 2 known VT API key failures)
    7. `make css` succeeds, dist/style.css regenerated
  </done>
</task>

</tasks>

<verification>
Run the full test suite:

```bash
cd /home/chris/projects/sentinelx && make css && python3 -m pytest tests/e2e/ -q
```

Verify KPI card structure:
```bash
grep -n "verdict-kpi-card" app/templates/partials/_verdict_dashboard.html
```

Verify shimmer CSS:
```bash
grep -n "shimmer" app/static/src/input.css
```

Verify JS selector update:
```bash
grep -n "verdict-kpi-card" app/static/main.js
```

Verify empty state icon:
```bash
grep -n "shield-check" app/templates/partials/_empty_state.html
```
</verification>

<success_criteria>
1. Empty state: shield icon + "No IOCs detected" headline + supported types body
2. KPI dashboard: 4 grid cards with monospace counts, colored top borders, small-caps labels
3. Shimmer: 3 animated gradient rectangles per pending enrichment slot
4. Dashboard click-to-filter works via updated JS selector
5. Shimmer disappears when enrichment results arrive via existing .spinner-wrapper JS logic
6. All E2E tests pass (except 2 known VT API key failures)
7. Responsive: KPI grid collapses to 2 columns on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/13-results-page-redesign/13-03-SUMMARY.md`
</output>
