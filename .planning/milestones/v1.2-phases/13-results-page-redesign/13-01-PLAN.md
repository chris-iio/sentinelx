---
phase: 13-results-page-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/templates/results.html
  - app/templates/partials/_ioc_card.html
  - app/templates/partials/_verdict_dashboard.html
  - app/templates/partials/_filter_bar.html
  - app/templates/partials/_enrichment_slot.html
  - app/templates/partials/_empty_state.html
  - tests/e2e/test_homepage.py
  - tests/e2e/pages/results_page.py
autonomous: true
requirements:
  - RESULTS-01

must_haves:
  truths:
    - "All existing Playwright E2E tests pass after partial extraction (zero regressions)"
    - "results.html uses {% include %} to pull in partials instead of inline HTML blocks"
    - "Each partial file exists as a separate file in app/templates/partials/"
    - "test_header_branding passes with updated tagline expectation"
  artifacts:
    - path: "app/templates/partials/_ioc_card.html"
      provides: "Single IOC card template (loop body)"
      contains: "ioc-card"
    - path: "app/templates/partials/_verdict_dashboard.html"
      provides: "Verdict dashboard (online mode)"
      contains: "verdict-dashboard"
    - path: "app/templates/partials/_filter_bar.html"
      provides: "Sticky filter bar + search"
      contains: "filter-bar"
    - path: "app/templates/partials/_enrichment_slot.html"
      provides: "Enrichment pending slot (online mode)"
      contains: "enrichment-slot"
    - path: "app/templates/partials/_empty_state.html"
      provides: "No-results empty state"
      contains: "no-results"
  key_links:
    - from: "app/templates/results.html"
      to: "app/templates/partials/_ioc_card.html"
      via: "{% include 'partials/_ioc_card.html' %}"
      pattern: "include.*_ioc_card"
    - from: "app/templates/results.html"
      to: "app/templates/partials/_verdict_dashboard.html"
      via: "{% include 'partials/_verdict_dashboard.html' %}"
      pattern: "include.*_verdict_dashboard"
---

<objective>
Extract the monolithic `results.html` template into Jinja2 `{% include %}` partials without changing any visual output or breaking any E2E tests.

Purpose: Structural refactoring that creates a clean separation of concerns, making each section independently editable. This is the foundation for all visual changes in Plans 02 and 03. Also fixes the pre-existing `test_header_branding` test failure from Phase 12.

Output: 5 partial template files in `app/templates/partials/`, a slim `results.html` orchestrator, and a green E2E test suite.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-results-page-redesign/13-RESEARCH.md
@app/templates/results.html
@tests/e2e/pages/results_page.py
@tests/e2e/test_homepage.py
@tests/e2e/test_extraction.py
@tests/e2e/test_results_page.py

<interfaces>
<!-- Jinja2 include context: all variables passed to render_template("results.html", ...) are
     automatically available in included partials. No explicit variable passing needed.

     Variables available in partials (from Flask route):
       - mode: "online" | "offline"
       - job_id: str | None
       - grouped: dict[IOCType, list[IOC]]
       - total_count: int
       - enrichable_count: int
       - no_results: bool
       - ioc (loop variable): IOC object with .value, .type.value, .raw_match
       - ioc_type (loop variable): IOCType enum

     JS contracts in main.js that MUST be preserved:
       - .spinner-wrapper — removed by JS on first enrichment result (line 422)
       - [data-verdict-count="X"] — updated by JS polling (line 251)
       - [data-verdict="X"] on .verdict-dashboard-badge — click handler (line 725)
       - [data-ioc-value], [data-ioc-type], [data-verdict] on .ioc-card — filtering (line 623-644)
       - #verdict-dashboard — JS getElementById (line 723)
       - #filter-search-input — JS getElementById
       - #ioc-cards-grid — JS getElementById
       - #enrich-progress, #enrich-progress-fill, #enrich-progress-text — JS progress updates
       - #enrich-warning — JS warning display
       - #export-btn — JS export handler

     Page Object Model selectors (tests/e2e/pages/results_page.py):
       - .mode-indicator — mode text
       - .results-summary .ioc-count — total count
       - .no-results — no results box
       - .no-results-hint — hint text
       - .ioc-card — card elements
       - .ioc-type-badge — type badges
       - .verdict-label — verdict labels
       - .ioc-value — IOC value code elements
       - .ioc-original — original match text
       - .copy-btn — copy buttons
       - #verdict-dashboard — dashboard container
       - [data-verdict-count="X"] — count spans
       - .filter-bar-wrapper — sticky bar
       - .filter-verdict-buttons .filter-btn — verdict filter buttons
       - .filter-type-pills .filter-pill — type filter pills
       - .filter-search-input — search input
       - .verdict-dashboard-badge[data-verdict] — dashboard badges
-->
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Jinja2 template partials from results.html</name>
  <files>
    app/templates/results.html,
    app/templates/partials/_ioc_card.html,
    app/templates/partials/_verdict_dashboard.html,
    app/templates/partials/_filter_bar.html,
    app/templates/partials/_enrichment_slot.html,
    app/templates/partials/_empty_state.html
  </files>
  <action>
    Create `app/templates/partials/` directory.

    Extract 5 partials from `results.html` using `{% include %}`. Jinja2 includes inherit the full render context — do NOT pass variables explicitly.

    **1. `_empty_state.html`** — Extract the `.no-results` div (lines 45-50 of current results.html):
    ```html
    <div class="no-results">
        <p>No IOCs detected in the pasted text.</p>
        <p class="no-results-hint">
            Supported types: IPv4, IPv6, domain, URL, MD5, SHA1, SHA256, CVE.
        </p>
    </div>
    ```

    **2. `_verdict_dashboard.html`** — Extract the `.verdict-dashboard` div (lines 58-87), keeping all `data-verdict` and `data-verdict-count` attributes exactly as-is. Do NOT include the `{% if mode == "online" %}` wrapper — that stays in results.html.

    **3. `_filter_bar.html`** — Extract the `.filter-bar-wrapper` div (lines 92-117), including the verdict buttons, type pills, and search input. All IDs and data attributes must be preserved exactly.

    **4. `_enrichment_slot.html`** — Extract the `.enrichment-slot` div content (lines 144-149). This is the inner content of the enrichment slot rendered inside the card loop when `mode == "online"`:
    ```html
    <div class="enrichment-slot">
        <div class="spinner-wrapper">
            <span class="enrichment-spinner"></span>
            <span class="enrichment-pending-text">Pending enrichment...</span>
        </div>
    </div>
    ```
    Keep the class `.spinner-wrapper` — JS removes it by this name (main.js line 422).

    **5. `_ioc_card.html`** — Extract the `.ioc-card` div (lines 123-151). This is the full card including header, original match, and enrichment slot. The enrichment slot inside the card should use `{% include "partials/_enrichment_slot.html" %}` wrapped in the existing `{% if mode == "online" and job_id %}` condition.

    **6. Update `results.html`** to be a slim orchestrator that uses `{% include %}`:
    - `{% include "partials/_empty_state.html" %}` in the no-results branch
    - `{% include "partials/_verdict_dashboard.html" %}` inside `{% if mode == "online" and job_id %}`
    - `{% include "partials/_filter_bar.html" %}` for the filter bar
    - `{% include "partials/_ioc_card.html" %}` inside the double `{% for %}` loop
    - Keep all `{% if %}` conditionals in results.html — partials should be unconditional content

    **CRITICAL constraints:**
    - Every ID, class, and data-attribute must be preserved character-for-character
    - The `{% for ioc_type, iocs in grouped.items() %}` and inner `{% for ioc in iocs %}` loops stay in results.html
    - All `{% if %}` guards (mode checks, no_results check) stay in results.html
    - The `#filter-root` div stays in results.html wrapping the includes
    - Do NOT add any new HTML, classes, or styling — pure structural extraction
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && python3 -m pytest tests/e2e/ -q -x 2>&1 | tail -20</automated>
  </verify>
  <done>
    5 partial files exist in app/templates/partials/. results.html uses {% include %} for each section. All existing E2E tests pass (except the 2 known pre-existing VT API key failures and the test_header_branding failure fixed in Task 2).
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix pre-existing test_header_branding test failure</name>
  <files>
    tests/e2e/test_homepage.py
  </files>
  <action>
    Update `test_header_branding` in `tests/e2e/test_homepage.py` (line 23) to expect the Phase 12 tagline change:

    Change:
    ```python
    expect(idx.site_tagline).to_have_text("Offline IOC Extractor")
    ```

    To:
    ```python
    expect(idx.site_tagline).to_have_text("IOC Triage Tool")
    ```

    This is NOT a regression — Phase 12 intentionally changed the tagline from "Offline IOC Extractor" to "IOC Triage Tool" to reflect the dual online/offline capability. The test was not updated at that time.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && python3 -m pytest tests/e2e/test_homepage.py::test_header_branding -q -x 2>&1 | tail -5</automated>
  </verify>
  <done>
    test_header_branding passes with "IOC Triage Tool" expectation. Full E2E suite runs with only the 2 known VT API key failures remaining.
  </done>
</task>

</tasks>

<verification>
Run the full E2E test suite after both tasks:

```bash
cd /home/chris/projects/sentinelx && python3 -m pytest tests/e2e/ -q
```

Expected: All tests pass except the 2 known pre-existing VT API key failures (`test_online_mode_indicator`, `test_online_mode_shows_verdict_dashboard`).

Also verify partials exist:
```bash
ls app/templates/partials/
```

Expected: `_empty_state.html`, `_enrichment_slot.html`, `_filter_bar.html`, `_ioc_card.html`, `_verdict_dashboard.html`
</verification>

<success_criteria>
1. All 5 partial template files exist in `app/templates/partials/`
2. `results.html` is a slim orchestrator using `{% include %}` for each section
3. All E2E tests pass (except the 2 known VT API key failures)
4. `test_header_branding` passes with "IOC Triage Tool"
5. No visual changes — output is identical before and after extraction
</success_criteria>

<output>
After completion, create `.planning/phases/13-results-page-redesign/13-01-SUMMARY.md`
</output>
