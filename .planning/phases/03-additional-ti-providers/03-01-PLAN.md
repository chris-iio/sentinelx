---
phase: 03-additional-ti-providers
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/enrichment/orchestrator.py
  - app/enrichment/adapters/malwarebazaar.py
  - app/enrichment/adapters/__init__.py
  - app/config.py
  - tests/test_orchestrator.py
  - tests/test_malwarebazaar.py
autonomous: true
requirements: [ENRC-02]

must_haves:
  truths:
    - "Orchestrator accepts a list of adapters and dispatches each IOC to every adapter that supports its type"
    - "MalwareBazaar adapter queries abuse.ch POST API for MD5/SHA1/SHA256 hashes and returns malware family, tags, file type, first/last seen"
    - "MalwareBazaar found result maps to verdict=malicious (it is a malware sample repo)"
    - "MalwareBazaar not-found result maps to verdict=no_data"
    - "MalwareBazaar failure returns per-provider EnrichmentError without affecting other providers"
  artifacts:
    - path: "app/enrichment/orchestrator.py"
      provides: "Multi-adapter orchestrator dispatching IOCs to multiple providers"
      contains: "adapters"
    - path: "app/enrichment/adapters/malwarebazaar.py"
      provides: "MalwareBazaar API adapter for hash lookups"
      exports: ["MBAdapter"]
    - path: "tests/test_orchestrator.py"
      provides: "Updated orchestrator tests for multi-adapter behavior"
    - path: "tests/test_malwarebazaar.py"
      provides: "MalwareBazaar adapter tests with mocked HTTP"
  key_links:
    - from: "app/enrichment/orchestrator.py"
      to: "app/enrichment/adapters/malwarebazaar.py"
      via: "adapter.lookup(ioc) call in thread pool"
      pattern: "adapter\\.lookup"
    - from: "app/enrichment/adapters/malwarebazaar.py"
      to: "https://mb-api.abuse.ch/api/v1/"
      via: "requests.post with hash query"
      pattern: "mb-api\\.abuse\\.ch"
---

<objective>
Refactor the enrichment orchestrator to support multiple adapters and build the MalwareBazaar adapter for hash IOC lookups.

Purpose: The orchestrator currently accepts a single VTAdapter. Phase 3 requires dispatching each IOC to multiple providers in parallel. This plan refactors the orchestrator to accept a list of adapters (each with a `lookup(ioc)` method and a `supported_types` set), then builds the MalwareBazaar adapter following the established VTAdapter pattern. MalwareBazaar is a malware sample repository (abuse.ch) — finding a hash there means it IS malware, so existence maps to verdict=malicious.

Output: Multi-adapter orchestrator + working MalwareBazaar adapter, all TDD-verified.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-enrichment/02-01-SUMMARY.md
@.planning/phases/02-core-enrichment/02-02-SUMMARY.md
@app/enrichment/orchestrator.py
@app/enrichment/adapters/virustotal.py
@app/enrichment/models.py
@app/pipeline/models.py
@app/config.py
@tests/test_orchestrator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for multi-adapter orchestrator and MalwareBazaar adapter</name>
  <files>tests/test_orchestrator.py, tests/test_malwarebazaar.py</files>
  <action>
**tests/test_orchestrator.py — Add multi-adapter tests:**

Update existing orchestrator tests to work with the new multi-adapter interface. The orchestrator will accept `adapters` (list) instead of a single `adapter`. Each adapter has a `supported_types` property (set of IOCType) and a `lookup(ioc)` method.

Add these new test cases:
1. `test_multi_adapter_dispatches_to_all_matching` — Create two mock adapters: adapter_a supports {IPV4}, adapter_b supports {IPV4, DOMAIN}. Submit one IPV4 IOC. Assert results list has 2 entries (one from each adapter).
2. `test_multi_adapter_skips_unsupported_type` — adapter_a supports {MD5} only. Submit a DOMAIN IOC. Assert 0 results (IOC skipped for that adapter).
3. `test_multi_adapter_total_counts_all_dispatches` — Submit 2 IOCs to 2 adapters where both support both types. Assert total=4 (2 IOCs x 2 adapters).
4. `test_adapter_failure_isolated_across_providers` — adapter_a returns EnrichmentError, adapter_b returns EnrichmentResult. Assert both results present (error from a does not block b).

Update existing tests: change `EnrichmentOrchestrator(adapter)` to `EnrichmentOrchestrator(adapters=[adapter])` for backward compatibility. The old ENDPOINT_MAP import should be removed from orchestrator.py — each adapter declares its own supported_types.

**tests/test_malwarebazaar.py — New file:**

Write tests for MBAdapter with mocked HTTP (use unittest.mock.patch on requests.post):
1. `test_lookup_sha256_found` — Mock POST to mb-api.abuse.ch returning query_status="ok" with sample data. Assert EnrichmentResult with provider="MalwareBazaar", verdict="malicious", raw_stats containing file_type, tags, signature (malware family), first_seen, last_seen.
2. `test_lookup_md5_found` — Same but with MD5 hash. Assert correct result.
3. `test_lookup_sha1_found` — Same but with SHA1 hash.
4. `test_lookup_not_found` — Mock returning query_status="hash_not_found". Assert EnrichmentResult with verdict="no_data", detection_count=0, total_engines=0.
5. `test_lookup_unsupported_type_domain` — Pass a DOMAIN IOC. Assert EnrichmentError with "Unsupported type".
6. `test_lookup_timeout` — Mock raising requests.exceptions.Timeout. Assert EnrichmentError with "Timeout".
7. `test_lookup_http_error` — Mock raising requests.exceptions.HTTPError. Assert EnrichmentError.
8. `test_ssrf_validation` — Pass allowed_hosts that does NOT include mb-api.abuse.ch. Assert EnrichmentError with SSRF message.
9. `test_supported_types` — Assert MBAdapter.supported_types == {IOCType.MD5, IOCType.SHA1, IOCType.SHA256}.
10. `test_response_size_limit` — Mock a response body exceeding 1MB. Assert EnrichmentError.

Run: `python -m pytest tests/test_orchestrator.py tests/test_malwarebazaar.py -x` — all new tests MUST FAIL (RED).
  </action>
  <verify>
`python -m pytest tests/test_orchestrator.py tests/test_malwarebazaar.py -x 2>&1 | tail -5` shows FAILED for new tests. Existing orchestrator tests may also fail due to interface change — that is expected (RED phase).
  </verify>
  <done>New test files exist with all specified test cases. Running pytest shows failures for all new tests (ImportError or AssertionError). No production code has been written yet.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN + REFACTOR — Implement multi-adapter orchestrator and MalwareBazaar adapter</name>
  <files>app/enrichment/orchestrator.py, app/enrichment/adapters/malwarebazaar.py, app/enrichment/adapters/__init__.py, app/config.py</files>
  <action>
**app/enrichment/orchestrator.py — Refactor for multi-adapter:**

Change `__init__` signature from `adapter` (single) to `adapters` (list). Each adapter must have:
- `supported_types`: a set of IOCType values the adapter handles
- `lookup(ioc)`: returns EnrichmentResult | EnrichmentError

Remove the `from app.enrichment.adapters.virustotal import ENDPOINT_MAP` import. The orchestrator no longer knows about VT specifically.

In `enrich_all()`:
- For each IOC, iterate over `self._adapters` and collect (adapter, ioc) pairs where `ioc.type in adapter.supported_types`
- Submit ALL (adapter, ioc) pairs to the ThreadPoolExecutor
- `total` should reflect the number of dispatched lookups (IOC count x matching adapters), not just IOC count
- Keep the retry-once pattern per individual lookup
- Everything else (LRU, Lock, get_status) stays the same

**app/enrichment/adapters/malwarebazaar.py — New file:**

Create MBAdapter following VTAdapter pattern:

```python
MB_BASE = "https://mb-api.abuse.ch/api/v1/"
TIMEOUT = (5, 30)
MAX_RESPONSE_BYTES = 1 * 1024 * 1024

class MBAdapter:
    supported_types = {IOCType.MD5, IOCType.SHA1, IOCType.SHA256}

    def __init__(self, allowed_hosts: list[str]) -> None:
        self._allowed_hosts = allowed_hosts

    def lookup(self, ioc: IOC) -> EnrichmentResult | EnrichmentError:
        # 1. Check supported type
        # 2. Validate endpoint against SSRF allowlist
        # 3. POST to MB_BASE with data={"query": "get_info", "hash": ioc.value}
        # 4. HTTP safety: timeout=TIMEOUT, stream=True, allow_redirects=False
        # 5. Read response with byte cap (_read_limited)
        # 6. Parse: query_status == "ok" -> malicious, "hash_not_found" -> no_data
```

Response parsing for found hash (per user decision — show malware family, tags, file type, first/last seen):
- `raw_stats` dict: `{"file_type": ..., "signature": ..., "tags": [...], "first_seen": ..., "last_seen": ...}`
- `verdict`: "malicious" (found in MalwareBazaar = confirmed malware sample)
- `detection_count`: 1 (present), `total_engines`: 1 (MalwareBazaar is binary: present or not)
- `scan_date`: Use `first_seen` from response if available
- `provider`: "MalwareBazaar"

No API key needed — MalwareBazaar hash queries are public (per user context). No Auth-Key header needed for basic queries.

Reuse the `_validate_endpoint` and `_read_limited` patterns from VTAdapter (copy the helper functions or extract shared utils — prefer copying into the module for isolation, matching the adapter-per-file pattern).

**app/enrichment/adapters/__init__.py — Update:**

Add MBAdapter to package exports if needed.

**app/config.py — Update ALLOWED_API_HOSTS:**

Add "mb-api.abuse.ch" to the ALLOWED_API_HOSTS list.

**Also add `supported_types` to VTAdapter** in `app/enrichment/adapters/virustotal.py`:
```python
class VTAdapter:
    supported_types = {IOCType.IPV4, IOCType.IPV6, IOCType.DOMAIN, IOCType.URL, IOCType.MD5, IOCType.SHA1, IOCType.SHA256}
```
This is derived from ENDPOINT_MAP keys. The orchestrator uses this property instead of importing ENDPOINT_MAP directly.

Run: `python -m pytest tests/ -x --tb=short` — ALL tests must pass (GREEN). Then run `python -m pytest tests/ --cov=app --cov-report=term-missing` for coverage check.
  </action>
  <verify>
`python -m pytest tests/ -x --tb=short` — 0 failures. `python -m pytest tests/test_malwarebazaar.py tests/test_orchestrator.py -v` shows all tests passing. Coverage for `app/enrichment/adapters/malwarebazaar.py` is >90%.
  </verify>
  <done>Multi-adapter orchestrator accepts list of adapters, dispatches IOCs to all matching providers in parallel. MalwareBazaar adapter queries abuse.ch for hash IOCs, returns malicious/no_data verdicts with malware family, tags, file type, first/last seen. All existing tests still pass (no regressions). ALLOWED_API_HOSTS includes mb-api.abuse.ch. VTAdapter has supported_types property.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -x --tb=short` — full suite passes, zero failures
2. `python -m pytest tests/test_malwarebazaar.py -v` — all 10 MB adapter tests pass
3. `python -m pytest tests/test_orchestrator.py -v` — multi-adapter tests pass
4. `grep "mb-api.abuse.ch" app/config.py` — SSRF allowlist updated
5. `grep "supported_types" app/enrichment/adapters/virustotal.py` — VTAdapter has supported_types
6. `grep -r "ENDPOINT_MAP" app/enrichment/orchestrator.py` — returns nothing (decoupled)
</verification>

<success_criteria>
- MalwareBazaar adapter independently testable with mocked HTTP (ENRC-02 partial)
- Orchestrator dispatches to multiple adapters per IOC (multi-provider foundation)
- No shared state between adapters (ENRC-02 requirement: "independently testable")
- All HTTP safety controls enforced on MalwareBazaar calls (timeout, size cap, no redirects, SSRF allowlist)
- Zero test regressions across full suite
</success_criteria>

<output>
After completion, create `.planning/phases/03-additional-ti-providers/03-01-SUMMARY.md`
</output>
