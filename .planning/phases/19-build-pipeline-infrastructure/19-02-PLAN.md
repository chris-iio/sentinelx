---
phase: 19-build-pipeline-infrastructure
plan: 02
type: execute
wave: 2
depends_on:
  - "19-01"
files_modified:
  - app/templates/base.html
  - app/static/dist/main.js
autonomous: true
requirements:
  - BUILD-02
  - BUILD-06

must_haves:
  truths:
    - "The app loads correctly in the browser with base.html serving dist/main.js instead of main.js"
    - "The test_csp_header_exact_match security regression test passes against the compiled dist/main.js bundle"
    - "Running make build produces both app/static/dist/style.css and app/static/dist/main.js"
    - "The original app/static/main.js still exists and provides all functionality (it is NOT deleted until Phase 22)"
  artifacts:
    - path: "app/templates/base.html"
      provides: "Script tag pointing to dist/main.js"
      contains: "dist/main.js"
    - path: "app/static/dist/main.js"
      provides: "Compiled IIFE bundle (placeholder for now)"
  key_links:
    - from: "app/templates/base.html"
      to: "app/static/dist/main.js"
      via: "url_for script tag"
      pattern: "url_for.*dist/main\\.js"
    - from: "tests/test_security_audit.py"
      to: "app response headers"
      via: "CSP header assertion"
      pattern: "script-src.*self"
---

<objective>
Wire base.html to serve the compiled dist/main.js bundle, commit the generated bundle, and verify the CSP security regression test still passes. This completes the build pipeline integration.

Purpose: Ensure the Flask app serves the esbuild-compiled bundle and that no CSP security regression is introduced by the build output.
Output: Updated base.html script tag, committed dist/main.js placeholder bundle, passing CSP test.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-build-pipeline-infrastructure/19-RESEARCH.md
@.planning/phases/19-build-pipeline-infrastructure/19-01-SUMMARY.md
@app/templates/base.html
@tests/test_security_audit.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update base.html script tag and verify CSP compliance</name>
  <files>app/templates/base.html</files>
  <action>
1. In `app/templates/base.html`, change the script tag on line 35 from:
```html
<script src="{{ url_for('static', filename='main.js') }}" defer></script>
```
to:
```html
<script src="{{ url_for('static', filename='dist/main.js') }}" defer></script>
```

No other template changes are needed. The CSP is set in the Flask app middleware (not in base.html), so changing the script `src` attribute does not affect CSP headers.

IMPORTANT: The original `app/static/main.js` is NOT deleted. It remains in the repository until Phase 22. At this point, `dist/main.js` is just an empty IIFE placeholder — all actual JavaScript functionality is still loaded from the original `main.js` path. However, since we're changing the script tag to point to `dist/main.js`, we need to ensure the original JS code is available.

WAIT — this is a critical detail. The placeholder `dist/main.js` is an empty IIFE. If we point the script tag to it, we lose ALL JavaScript functionality. The original `main.js` has 856 lines of actual code.

There are two valid approaches:
**Option A (recommended):** Keep both script tags temporarily — `dist/main.js` (empty placeholder, proves pipeline works) AND `main.js` (actual functionality). Delete the `main.js` tag in Phase 22 when `dist/main.js` contains the real code.
**Option B:** Don't update the script tag yet — leave it pointing to `main.js` until Phase 22 when the real TypeScript code is compiled into `dist/main.js`.

**Choose Option A:** Add the `dist/main.js` script tag BEFORE the existing `main.js` tag. This proves the build pipeline is integrated with the template while preserving all functionality:

```html
<script src="{{ url_for('static', filename='dist/main.js') }}" defer></script>
<script src="{{ url_for('static', filename='main.js') }}" defer></script>
```

Both scripts are IIFE format with `defer`, so they execute in document order. The empty IIFE from `dist/main.js` is a no-op. All real functionality comes from `main.js`.

In Phase 22, when `dist/main.js` contains the full TypeScript-compiled code, the `main.js` line is removed and `main.js` is deleted.

2. Run `make js` to ensure `dist/main.js` exists (production build — minified, no source maps). This should already exist from Plan 01 Task 3, but verify.

3. Run the CSP security regression test:
```bash
python -m pytest tests/test_security_audit.py::test_csp_header_exact_match -xvs
```

This test checks Flask response headers only (default-src 'self', script-src 'self', no unsafe-inline, no unsafe-eval). The esbuild IIFE output does not use eval or Function constructor, so CSP is preserved.

4. Run the full security audit test suite to catch any regressions:
```bash
python -m pytest tests/test_security_audit.py -xvs
```

5. Run a broader test sweep to verify the app still works with the dual-script-tag approach:
```bash
python -m pytest tests/ -x --timeout=30 -q
```

If any E2E tests fail due to JavaScript errors, it means the dual-script approach has an issue — investigate and fix. The empty IIFE should be completely inert and cause no conflicts.
  </action>
  <verify>
    <automated>python -m pytest tests/test_security_audit.py::test_csp_header_exact_match -xvs && grep -q "dist/main.js" app/templates/base.html && grep -q "main.js" app/templates/base.html && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>base.html has script tag for dist/main.js (empty placeholder) alongside the original main.js (real functionality), CSP test passes, all existing tests pass without regressions</done>
</task>

<task type="auto">
  <name>Task 2: Commit dist/main.js bundle and verify full build pipeline</name>
  <files>app/static/dist/main.js</files>
  <action>
1. Ensure `app/static/dist/main.js` contains the production build (minified IIFE, no source maps). Run `make js` if needed.

2. Verify the file is tracked by git. Since `app/static/dist/` is explicitly un-ignored in `.gitignore` (line 18: `!app/static/dist/`), the bundle should be committable. Verify with:
```bash
git status app/static/dist/main.js
```

3. The bundle will be committed as part of the plan's commit. It should be committed alongside all other Phase 19 changes — not separately.

4. Run the full build pipeline end-to-end:
```bash
make build
```
Verify both `app/static/dist/style.css` and `app/static/dist/main.js` exist after the build completes.

5. Final verification — run ALL tests one more time to confirm nothing is broken:
```bash
python -m pytest tests/ -x --timeout=30 -q
```

6. Verify the complete pipeline works from a clean build state:
```bash
rm app/static/dist/main.js
make build
test -f app/static/dist/main.js && test -f app/static/dist/style.css && echo "Clean build: PASS" || echo "Clean build: FAIL"
```
  </action>
  <verify>
    <automated>make build && test -f app/static/dist/main.js && test -f app/static/dist/style.css && python -m pytest tests/test_security_audit.py -xvs && echo "FULL PIPELINE PASS" || echo "FAIL"</automated>
  </verify>
  <done>dist/main.js is generated by make js, committed to git, make build produces both CSS and JS artifacts, all security tests pass, no regressions in existing test suite</done>
</task>

</tasks>

<verification>
1. `base.html` contains `dist/main.js` script tag (build pipeline integration)
2. `base.html` still contains `main.js` script tag (preserves all functionality)
3. `test_csp_header_exact_match` passes — no CSP regression
4. `make build` produces both `dist/style.css` and `dist/main.js`
5. `dist/main.js` is committed to git (available for CI/tests without running build)
6. Full test suite passes without regressions
</verification>

<success_criteria>
- base.html serves both dist/main.js (placeholder) and main.js (functionality) via script tags
- CSP security regression test passes with the new bundle in place
- make build completes successfully producing both CSS and JS artifacts
- dist/main.js is committed to the repository
- No behavioral regressions in the existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/19-build-pipeline-infrastructure/19-02-SUMMARY.md`
</output>
