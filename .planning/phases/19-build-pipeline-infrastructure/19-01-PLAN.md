---
phase: 19-build-pipeline-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Makefile
  - tsconfig.json
  - app/static/src/ts/main.ts
  - .gitignore
  - tailwind.config.js
autonomous: true
requirements:
  - BUILD-01
  - BUILD-02
  - BUILD-03
  - BUILD-04
  - BUILD-05
  - BUILD-06

must_haves:
  truths:
    - "Running `make esbuild-install` downloads the esbuild 0.27.3 linux-x64 binary to tools/esbuild and it is executable"
    - "Running `make js` produces app/static/dist/main.js as a minified IIFE bundle"
    - "Running `make js-dev` produces app/static/dist/main.js with inline source maps (no external .map file)"
    - "Running `make js-watch` starts a long-running process that recompiles on file changes"
    - "Running `make typecheck` executes tsc --noEmit and exits zero on the placeholder main.ts"
    - "Running `make build` runs both css and js targets"
    - "tsconfig.json uses strict:true, isolatedModules:true, noUncheckedIndexedAccess:true, types:[]"
  artifacts:
    - path: "Makefile"
      provides: "esbuild-install, js, js-dev, js-watch, typecheck targets; updated build target"
      contains: "ESBUILD"
    - path: "tsconfig.json"
      provides: "TypeScript type-checking config for browser + esbuild"
      contains: "isolatedModules"
    - path: "app/static/src/ts/main.ts"
      provides: "Placeholder entry point for build pipeline verification"
      contains: "export {}"
    - path: ".gitignore"
      provides: "Source map exclusion rule"
      contains: "*.map"
    - path: "tailwind.config.js"
      provides: "TypeScript source path in content array"
      contains: "ts/**/*.ts"
  key_links:
    - from: "Makefile"
      to: "app/static/src/ts/main.ts"
      via: "JS_ENTRY variable"
      pattern: "JS_ENTRY.*main\\.ts"
    - from: "Makefile"
      to: "app/static/dist/main.js"
      via: "JS_OUT variable"
      pattern: "JS_OUT.*dist/main\\.js"
    - from: "Makefile"
      to: "tools/esbuild"
      via: "ESBUILD variable"
      pattern: "ESBUILD.*tools/esbuild"
    - from: "tsconfig.json"
      to: "app/static/src/ts/**/*.ts"
      via: "include array"
      pattern: "app/static/src/ts"
---

<objective>
Set up the complete TypeScript build pipeline infrastructure: esbuild binary installation, all Makefile JS targets, tsconfig.json for strict browser-only type checking, placeholder entry point, and supporting config updates.

Purpose: Establish the build tooling foundation so that subsequent phases can convert JS to TS incrementally without any pipeline setup work.
Output: Working esbuild binary, 5 new Makefile targets (esbuild-install, js, js-dev, js-watch, typecheck), updated build target, tsconfig.json, placeholder main.ts, .gitignore and tailwind.config.js updates.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-build-pipeline-infrastructure/19-RESEARCH.md
@Makefile
@tsconfig.json
@.gitignore
@tailwind.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tsconfig.json, placeholder main.ts, and update config files</name>
  <files>tsconfig.json, app/static/src/ts/main.ts, .gitignore, tailwind.config.js</files>
  <action>
1. Create `tsconfig.json` at project root with this exact content:
```json
{
  "compilerOptions": {
    "target": "es2022",
    "lib": ["es2022", "dom", "dom.iterable"],
    "module": "es2022",
    "moduleResolution": "Bundler",
    "strict": true,
    "noEmit": true,
    "isolatedModules": true,
    "noUncheckedIndexedAccess": true,
    "types": [],
    "skipLibCheck": false
  },
  "include": ["app/static/src/ts/**/*.ts"]
}
```

Key options rationale:
- `noEmit: true` — tsc never writes files; esbuild handles transpilation
- `isolatedModules: true` — required by esbuild; prevents constructs that break single-file compilation
- `moduleResolution: "Bundler"` — esbuild compatibility mode
- `types: []` — prevents accidental @types/node resolution from Node.js on PATH
- `noUncheckedIndexedAccess: true` — catches undefined index access at compile time

2. Create directory `app/static/src/ts/` and file `app/static/src/ts/main.ts` with:
```typescript
// Phase 19 placeholder — full implementation in Phases 21-22.
// This entry point verifies the build pipeline only.

export {};
```

The `export {}` makes this a valid ES module (required for isolatedModules: true). esbuild bundles it into an empty IIFE.

3. Append to `.gitignore` (after the existing `node_modules/` line):
```
# Source maps (generated locally via make js-dev or js-watch)
app/static/dist/*.map
```

4. Update `tailwind.config.js` content array — add `"./app/static/src/ts/**/*.ts"` as a new entry after `"./app/static/**/*.js"`. This prevents Tailwind from purging classes referenced in TypeScript files in later phases (Pitfall 5 from research).
  </action>
  <verify>
    <automated>test -f tsconfig.json && test -f app/static/src/ts/main.ts && grep -q "*.map" .gitignore && grep -q "ts/\*\*/\*.ts" tailwind.config.js && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>tsconfig.json exists at project root with strict/isolatedModules/types:[] settings, placeholder main.ts exists with export {}, .gitignore excludes source maps, tailwind.config.js includes .ts content paths</done>
</task>

<task type="auto">
  <name>Task 2: Add esbuild-install target and all JS build targets to Makefile</name>
  <files>Makefile</files>
  <action>
Edit the existing Makefile to add esbuild variables and all new targets. The final Makefile should be:

```makefile
# SentinelX — Build Tooling
# Requires: tools/tailwindcss (standalone CLI binary)
#           tools/esbuild     (standalone CLI binary)

TAILWIND         := ./tools/tailwindcss
ESBUILD          := ./tools/esbuild
INPUT            := app/static/src/input.css
OUTPUT           := app/static/dist/style.css
JS_ENTRY         := app/static/src/ts/main.ts
JS_OUT           := app/static/dist/main.js
PLATFORM         := linux-x64
ESBUILD_VERSION  := 0.27.3

.PHONY: tailwind-install esbuild-install css css-watch js js-dev js-watch typecheck build

## Download Tailwind standalone CLI binary
tailwind-install:
	@mkdir -p tools
	curl -sLo $(TAILWIND) \
		https://github.com/tailwindlabs/tailwindcss/releases/download/v3.4.17/tailwindcss-$(PLATFORM)
	chmod +x $(TAILWIND)
	@echo "Tailwind CLI installed at $(TAILWIND)"

## Download esbuild standalone binary
esbuild-install:
	@mkdir -p tools
	curl -sLo /tmp/esbuild.tgz \
		https://registry.npmjs.org/@esbuild/$(PLATFORM)/-/$(PLATFORM)-$(ESBUILD_VERSION).tgz
	tar xzf /tmp/esbuild.tgz -C /tmp
	mv /tmp/package/bin/esbuild $(ESBUILD)
	chmod +x $(ESBUILD)
	rm -rf /tmp/esbuild.tgz /tmp/package
	@echo "esbuild $(ESBUILD_VERSION) installed at $(ESBUILD)"

## Build CSS (one-shot)
css:
	$(TAILWIND) -i $(INPUT) -o $(OUTPUT) --minify

## Build CSS (watch mode for development)
css-watch:
	$(TAILWIND) -i $(INPUT) -o $(OUTPUT) --watch

## Build JS bundle (production — minified IIFE, no source maps)
js:
	$(ESBUILD) $(JS_ENTRY) \
		--bundle \
		--format=iife \
		--platform=browser \
		--target=es2022 \
		--minify \
		--outfile=$(JS_OUT)

## Build JS bundle (development — unminified, inline source maps)
js-dev:
	$(ESBUILD) $(JS_ENTRY) \
		--bundle \
		--format=iife \
		--platform=browser \
		--target=es2022 \
		--sourcemap=inline \
		--outfile=$(JS_OUT)

## Build JS bundle (watch mode — recompiles on file change)
js-watch:
	$(ESBUILD) $(JS_ENTRY) \
		--bundle \
		--format=iife \
		--platform=browser \
		--target=es2022 \
		--sourcemap=inline \
		--watch \
		--outfile=$(JS_OUT)

## Type-check TypeScript without emitting output
typecheck:
	tsc --noEmit

## Full build (CSS + JS)
build: css js
```

Key details:
- `ESBUILD_VERSION := 0.27.3` — pinned version matching research recommendation
- `PLATFORM := linux-x64` — hardcoded for WSL2 environment (matches existing Tailwind pattern)
- `esbuild-install` mirrors the existing `tailwind-install` pattern: curl tgz → extract → move binary → chmod
- `js` target: `--bundle --format=iife --platform=browser --target=es2022 --minify` — CSP-safe IIFE output
- `js-dev` target: same as js but with `--sourcemap=inline` and no `--minify` — for DevTools debugging
- `js-watch` target: same as js-dev plus `--watch` — stays alive and recompiles on change
- `typecheck` target: `tsc --noEmit` — reads tsconfig.json from project root
- `build` target: updated from `build: css` to `build: css js` — runs both pipelines

IMPORTANT: Makefile recipes MUST use actual tab characters for indentation, not spaces. This is a Makefile syntax requirement.
  </action>
  <verify>
    <automated>grep -q "esbuild-install" Makefile && grep -q "^js:" Makefile && grep -q "^js-dev:" Makefile && grep -q "^js-watch:" Makefile && grep -q "^typecheck:" Makefile && grep -q "build: css js" Makefile && grep -q "ESBUILD_VERSION" Makefile && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Makefile has esbuild-install target downloading v0.27.3 linux-x64 binary, js/js-dev/js-watch/typecheck targets with correct esbuild flags, and build target depends on both css and js</done>
</task>

<task type="auto">
  <name>Task 3: Install esbuild binary and verify all build targets work</name>
  <files></files>
  <action>
1. Run `make esbuild-install` to download the esbuild 0.27.3 binary to tools/esbuild.

2. Verify `./tools/esbuild --version` outputs `0.27.3`.

3. Run `make js` and verify:
   - `app/static/dist/main.js` is created
   - The file contains a minified IIFE (should be very small — just an empty IIFE wrapper)
   - No source map comment at end of file

4. Run `make js-dev` and verify:
   - `app/static/dist/main.js` is updated
   - File contains `//# sourceMappingURL=data:application/json;base64,` at the end (inline source map)
   - No external `.map` file created in dist/

5. Run `make typecheck` and verify:
   - `tsc --noEmit` exits with code 0
   - No output (no type errors on the placeholder main.ts)
   - Requires TypeScript to be available — if `tsc` is not found, install via `npm install -g typescript@5.8`

6. Run `make build` and verify:
   - Both `app/static/dist/style.css` and `app/static/dist/main.js` exist
   - Exit code is 0

7. After all verifications pass, run `make js` one final time to leave the production (minified, no source maps) bundle in place for commit. This is the version that will be committed to git and tested by CI.
  </action>
  <verify>
    <automated>./tools/esbuild --version && make js && test -f app/static/dist/main.js && make typecheck && make build && echo "ALL TARGETS PASS" || echo "FAIL"</automated>
  </verify>
  <done>esbuild 0.27.3 binary is installed and executable, all 5 Makefile targets (js, js-dev, js-watch, typecheck, build) execute successfully, dist/main.js contains a valid minified IIFE bundle</done>
</task>

</tasks>

<verification>
1. `./tools/esbuild --version` outputs `0.27.3`
2. `make js` creates `app/static/dist/main.js` (minified IIFE, no source map)
3. `make js-dev` creates `app/static/dist/main.js` with inline source map
4. `make typecheck` exits 0 (tsc --noEmit passes on placeholder)
5. `make build` completes successfully (css + js)
6. `tsconfig.json` has strict:true, isolatedModules:true, types:[], noUncheckedIndexedAccess:true
7. `tailwind.config.js` content array includes `.ts` file path
8. `.gitignore` excludes `app/static/dist/*.map`
</verification>

<success_criteria>
- All 5 new Makefile targets execute without error
- esbuild binary is installed at tools/esbuild (gitignored, not committed)
- tsconfig.json is correctly configured for strict browser-only type checking
- Placeholder main.ts exists and passes tsc --noEmit
- dist/main.js bundle is generated and committed
- .gitignore prevents accidental source map commits
- tailwind.config.js scans .ts files for class names
</success_criteria>

<output>
After completion, create `.planning/phases/19-build-pipeline-infrastructure/19-01-SUMMARY.md`
</output>
