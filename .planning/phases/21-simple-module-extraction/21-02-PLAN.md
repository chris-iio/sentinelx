---
phase: 21-simple-module-extraction
plan: "02"
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - app/static/src/ts/modules/form.ts
  - app/static/src/ts/modules/clipboard.ts
autonomous: true
requirements: [MOD-02, MOD-03]

must_haves:
  truths:
    - "form.ts disables submit button when textarea is empty and enables when content exists"
    - "form.ts clear button resets textarea and re-disables submit"
    - "form.ts auto-grow resizes textarea on input and paste"
    - "form.ts mode toggle switches between online/offline and updates submit label"
    - "form.ts paste feedback shows character count with timed fade-out"
    - "clipboard.ts copy buttons copy IOC value (with enrichment suffix if present) to clipboard"
    - "clipboard.ts fallback copy uses execCommand when navigator.clipboard unavailable"
    - "All timer variables use ReturnType<typeof setTimeout> — no NodeJS.Timeout"
    - "make typecheck passes with zero errors"
  artifacts:
    - path: "app/static/src/ts/modules/form.ts"
      provides: "Form controls: submit, clear, auto-grow, mode toggle, paste feedback"
      exports: ["init"]
    - path: "app/static/src/ts/modules/clipboard.ts"
      provides: "Clipboard operations: copy buttons, copy-with-enrichment, fallback"
      exports: ["init", "writeToClipboard"]
  key_links:
    - from: "app/static/src/ts/modules/form.ts"
      to: "app/static/src/ts/utils/dom.ts"
      via: "import { attr }"
      pattern: "import.*attr.*from.*utils/dom"
    - from: "app/static/src/ts/modules/clipboard.ts"
      to: "app/static/src/ts/utils/dom.ts"
      via: "import { attr }"
      pattern: "import.*attr.*from.*utils/dom"
---

<objective>
Extract the form controls and clipboard modules from main.js into typed TypeScript modules with proper null guards, timer types, and DOM element narrowing.

Purpose: form.ts is the largest simple module (~130 lines, 5 functions) and exercises the key TypeScript patterns (timer module-level variables, HTMLTextAreaElement/HTMLButtonElement narrowing, attr helper). clipboard.ts exports writeToClipboard — needed by Phase 22's enrichment module for the export button.

Output: Two TypeScript modules passing make typecheck, with writeToClipboard exported from clipboard.ts for downstream use.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/21-simple-module-extraction/21-RESEARCH.md
@.planning/phases/21-simple-module-extraction/21-01-SUMMARY.md

@app/static/main.js (source of truth — extract from lines 34-223)
@app/static/src/ts/utils/dom.ts (attr helper — created in Plan 01)
@tsconfig.json

<interfaces>
<!-- Created by Plan 01 — available for import -->

From app/static/src/ts/utils/dom.ts:
```typescript
export function attr(el: Element, name: string, fallback?: string): string;
```

From app/static/src/ts/types/ioc.ts:
```typescript
export type VerdictKey = "error" | "no_data" | "clean" | "suspicious" | "malicious";
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create form controls module</name>
  <files>app/static/src/ts/modules/form.ts</files>
  <action>
Extract from main.js lines 34-162. Create `app/static/src/ts/modules/form.ts` with these functions:

**Exports:** `init` (single exported function)

**Private functions (not exported):**
- `updateSubmitState()` — checks textarea.value.trim().length, sets submitBtn.disabled
- `showPasteFeedback(charCount: number)` — shows paste character count with timed animation
- `updateSubmitLabel(mode: string)` — updates button text and CSS class for online/offline
- `initAutoGrow()` — textarea auto-sizing on input/paste, focus/blur wrap classes
- `initModeToggle()` — mode toggle button click handler

**TypeScript porting rules — apply ALL of these:**

1. **DOM element typing:**
   - `document.getElementById("ioc-text")` → store as `HTMLElement | null`, then narrow with `if (!textarea) return`
   - For `.value` access: use `document.querySelector<HTMLTextAreaElement>("#ioc-text")` OR cast after null check
   - For `.disabled` access: use `document.querySelector<HTMLButtonElement>("#submit-btn")` OR cast after null check
   - `submitBtn.disabled = ...` requires `HTMLButtonElement` type — `HTMLElement` does not have `.disabled`

2. **Timer variable — CRITICAL:**
   - main.js line 153: `feedback._timer = setTimeout(...)` — TypeScript rejects property on HTMLElement
   - Replace with module-level: `let pasteTimer: ReturnType<typeof setTimeout> | null = null;`
   - Line 153: `clearTimeout(feedback._timer)` → `if (pasteTimer !== null) clearTimeout(pasteTimer);`
   - Line 154: `feedback._timer = setTimeout(...)` → `pasteTimer = setTimeout(...)`
   - Do NOT use `NodeJS.Timeout` — use `ReturnType<typeof setTimeout>` per project decision

3. **getAttribute calls:**
   - `widget.getAttribute("data-mode")` in initModeToggle → use `attr(widget, "data-mode")` from `import { attr } from "../utils/dom"`
   - `modeInput.value` does not use getAttribute — leave as-is (but modeInput needs HTMLInputElement type)

4. **Null guards — NO non-null assertions:**
   - Every `getElementById` / `querySelector` result guarded with `if (!el) return`
   - `updateSubmitState` is a nested function that closes over `textarea` and `submitBtn` — these are already narrowed in the outer scope, so no additional null checks needed inside

5. **Function structure:**
   - `init()` calls `initSubmitButton()`, `initAutoGrow()`, and `initModeToggle()` — these are private functions
   - `updateSubmitLabel(mode)` is called by `initModeToggle` — keep in same module, do not export
   - `showPasteFeedback(charCount)` is called by the paste handler in `initSubmitButton` — keep in same module

6. **String concatenation:**
   - `charCount + " characters pasted"` → template literal or keep concat — both fine
   - String(number) pattern preserved for textContent assignments

Do NOT change any behavior. Port line-by-line, adding only type annotations and null guards.

Run `make typecheck` after writing the file.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && make typecheck 2>&1 | tail -5</automated>
  </verify>
  <done>form.ts exports init(); all 5 functions ported with typed DOM, module-level pasteTimer using ReturnType<typeof setTimeout>, no non-null assertions; make typecheck clean</done>
</task>

<task type="auto">
  <name>Task 2: Create clipboard module</name>
  <files>app/static/src/ts/modules/clipboard.ts</files>
  <action>
Extract from main.js lines 166-223. Create `app/static/src/ts/modules/clipboard.ts` with these functions:

**Exports:** `init` AND `writeToClipboard`
- `init` is called by main.ts (Phase 22) to set up copy button listeners
- `writeToClipboard` is also exported because Phase 22's enrichment.ts needs it for the export button

**Private functions (not exported):**
- `showCopiedFeedback(btn: HTMLElement)` — saves original textContent, shows "Copied!", restores after 1500ms
- `fallbackCopy(text: string, btn: HTMLElement)` — creates temporary textarea, execCommand("copy"), shows feedback

**Exported functions:**
- `init()` — queries `.copy-btn` buttons, attaches click handlers
- `writeToClipboard(text: string, btn: HTMLElement)` — tries navigator.clipboard.writeText, falls back to fallbackCopy

**TypeScript porting rules:**

1. **textContent is string | null:**
   - `var original = btn.textContent;` in showCopiedFeedback → `const original = btn.textContent ?? "Copy";`
   - This ensures `original` is `string`, not `string | null`, when assigned back in the setTimeout callback

2. **navigator.clipboard may not exist:**
   - TypeScript knows `navigator.clipboard` can be undefined (not all contexts support it)
   - The existing `if (!navigator.clipboard)` check already handles this — TypeScript will narrow correctly

3. **getAttribute calls in init:**
   - `btn.getAttribute("data-value")` → `attr(btn, "data-value")` — import from `../utils/dom`
   - `btn.getAttribute("data-enrichment")` → `const enrichment = attr(btn, "data-enrichment")` — returns "" for missing attribute
   - Adjust the enrichment check: original uses `var enrichment = btn.getAttribute("data-enrichment"); var copyText = enrichment ? (value + " | " + enrichment) : value;`
   - With attr(), empty string is falsy so the ternary still works: `const copyText = enrichment ? (value + " | " + enrichment) : value;`
   - BUT: attr returns "" when attribute missing (falsy), and returns the attribute value when present (truthy) — same behavior as `getAttribute` which returns null (falsy) or string (truthy). So the ternary logic is identical.

4. **querySelectorAll typing:**
   - `document.querySelectorAll(".copy-btn")` → `document.querySelectorAll<HTMLElement>(".copy-btn")`
   - Use `.forEach(btn => ...)` iteration (already in original)

5. **Timer in showCopiedFeedback:**
   - The setTimeout in showCopiedFeedback is fire-and-forget (not stored for later clearTimeout)
   - No need for module-level timer variable — just call `setTimeout(...)` directly
   - Return type annotation not needed on the anonymous callback

6. **catch block:**
   - `catch (e)` in fallbackCopy → `catch` (no parameter needed — error is unused)
   - Empty catch with comment preserved

7. **document.execCommand:**
   - TypeScript includes this in lib.dom.d.ts (deprecated but typed)
   - No special handling needed

Do NOT change any behavior. The copy flow (click → read data-value → check data-enrichment → writeToClipboard → feedback) must be identical.

Run `make typecheck` after writing the file.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && make typecheck 2>&1 | tail -5</automated>
  </verify>
  <done>clipboard.ts exports init() and writeToClipboard(); fallback copy, navigator.clipboard, and showCopiedFeedback all typed; make typecheck clean</done>
</task>

</tasks>

<verification>
1. `make typecheck` exits 0 — all Phase 21 files pass strict TypeScript checking
2. `grep -rn 'ReturnType<typeof setTimeout>' app/static/src/ts/modules/form.ts` returns the pasteTimer declaration
3. `grep -rn 'NodeJS' app/static/src/ts/modules/` returns no results
4. `grep -rn '!' app/static/src/ts/modules/form.ts app/static/src/ts/modules/clipboard.ts | grep -v '//' | grep -v '!=' | grep -v '!el\|!btn\|!form\|!textarea\|!submitBtn\|!clearBtn\|!widget\|!toggleBtn\|!modeInput\|!feedback\|!wrap\|!value\|!navigator\|!copyBtn\|!input'` returns no non-null assertions
5. `grep 'export function' app/static/src/ts/modules/clipboard.ts` shows both init and writeToClipboard exported
</verification>

<success_criteria>
- form.ts: init() calls 3 sub-initializers; pasteTimer is module-level ReturnType<typeof setTimeout>; all DOM elements typed correctly
- clipboard.ts: init() sets up copy button listeners; writeToClipboard exported for Phase 22; textContent handled with ?? fallback
- Zero TypeScript errors from make typecheck
- No non-null assertions, no NodeJS.Timeout references
- All attr() calls use the helper from utils/dom.ts (no raw getAttribute)
</success_criteria>

<output>
After completion, create `.planning/phases/21-simple-module-extraction/21-02-SUMMARY.md`
</output>
