---
phase: 21-simple-module-extraction
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - app/static/src/ts/utils/dom.ts
  - app/static/src/ts/modules/settings.ts
  - app/static/src/ts/modules/ui.ts
autonomous: true
requirements: [MOD-07, MOD-08]

must_haves:
  truths:
    - "The attr() helper returns string (not string | null) for all getAttribute calls"
    - "settings.ts show/hide toggle switches input.type between password and text"
    - "ui.ts scroll-aware filter bar adds/removes is-scrolled class on scroll past threshold"
    - "ui.ts card stagger sets --card-index CSS custom property on each card"
    - "make typecheck passes with zero errors across all three files"
  artifacts:
    - path: "app/static/src/ts/utils/dom.ts"
      provides: "attr() helper for null-safe getAttribute"
      exports: ["attr"]
    - path: "app/static/src/ts/modules/settings.ts"
      provides: "Settings page API key show/hide toggle"
      exports: ["init"]
    - path: "app/static/src/ts/modules/ui.ts"
      provides: "Scroll-aware filter bar and card stagger animation"
      exports: ["init"]
  key_links:
    - from: "app/static/src/ts/modules/settings.ts"
      to: "app/static/src/ts/utils/dom.ts"
      via: "import { attr }"
      pattern: "import.*attr.*from.*utils/dom"
    - from: "app/static/src/ts/modules/ui.ts"
      to: "app/static/src/ts/utils/dom.ts"
      via: "import { attr }"
      pattern: "import.*attr.*from.*utils/dom"
---

<objective>
Create the shared DOM utility module (attr helper) and the two simplest TypeScript modules (settings, ui) as the foundation for all subsequent module extraction.

Purpose: The attr() helper is a dependency for every Phase 21 module. settings.ts and ui.ts are the simplest modules (~15 and ~25 lines respectively), making them ideal for establishing the module authoring pattern that form, clipboard, cards, and filter will follow.

Output: Three new TypeScript files in utils/ and modules/ directories, all passing make typecheck.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/21-simple-module-extraction/21-RESEARCH.md

@app/static/main.js (source of truth — extract from lines 792-835)
@app/static/src/ts/types/ioc.ts (Phase 20 types — available for import)
@tsconfig.json (strict, isolatedModules, noUncheckedIndexedAccess)

<interfaces>
<!-- Phase 20 types available for import by all modules -->

From app/static/src/ts/types/ioc.ts:
```typescript
export type VerdictKey = "error" | "no_data" | "clean" | "suspicious" | "malicious";
export type IocType = "ipv4" | "ipv6" | "domain" | "url" | "md5" | "sha1" | "sha256";
export const VERDICT_SEVERITY: readonly ["error", "no_data", "clean", "suspicious", "malicious"];
export const VERDICT_LABELS: Record<VerdictKey, string>;
export const IOC_PROVIDER_COUNTS: Record<IocType, number>;
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DOM utilities and settings module</name>
  <files>app/static/src/ts/utils/dom.ts, app/static/src/ts/modules/settings.ts</files>
  <action>
Create `app/static/src/ts/utils/` directory and `dom.ts`:

```typescript
/**
 * Shared DOM utilities for SentinelX TypeScript modules.
 */

/**
 * Typed getAttribute wrapper — returns string instead of string | null.
 * Callers pass a fallback (default: "") to avoid null propagation.
 * Attribute names are intentionally typed as string (not a union) for flexibility.
 */
export function attr(el: Element, name: string, fallback = ""): string {
  return el.getAttribute(name) ?? fallback;
}
```

Create `app/static/src/ts/modules/` directory and `settings.ts`:

Extract from main.js `initSettingsPage()` (lines 792-805). Port to TypeScript with these changes:

1. Export a single `init` function (not `initSettingsPage`)
2. Cast `document.getElementById('api-key')` to `HTMLInputElement | null` (required to access `.type` property)
3. Use `if (!btn || !input) return` null guard pattern (no non-null assertions)
4. Use `btn.textContent ?? "Show"` when reading textContent to handle `string | null`
5. No `import { attr }` needed here — settings.ts only uses getElementById, not getAttribute

The function body is a direct port: click handler toggles `input.type` between "password" and "text", updates `btn.textContent` to "Hide" or "Show".

Do NOT change any behavior. The TypeScript version must be functionally identical to the JavaScript original.

Run `make typecheck` to verify zero errors.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && make typecheck 2>&1 | tail -5</automated>
  </verify>
  <done>utils/dom.ts exports attr() returning string; settings.ts exports init() with typed DOM access; make typecheck passes clean</done>
</task>

<task type="auto">
  <name>Task 2: Create UI utilities module</name>
  <files>app/static/src/ts/modules/ui.ts</files>
  <action>
Extract from main.js `initScrollAwareFilterBar()` (lines 811-826) and `initCardStagger()` (lines 830-835). Port to TypeScript with these changes:

1. Export a single `init` function that calls two private helper functions
2. `initScrollAwareFilterBar()`:
   - Query `.filter-bar-wrapper` with `document.querySelector<HTMLElement>()`
   - Use `if (!filterBar) return` null guard
   - Module-level `let scrolled = false` state variable (declared inside init scope is fine since there's no timer to track)
   - Add `{ passive: true }` to scroll listener (already in original)
   - Use `filterBar.classList.toggle("is-scrolled", scrolled)` instead of the if/else add/remove pattern (simpler, same behavior)
3. `initCardStagger()`:
   - Query `.ioc-card` with `document.querySelectorAll<HTMLElement>()`
   - Use `.forEach((card, i) => ...)` instead of indexed for-loop (avoids noUncheckedIndexedAccess issue)
   - `card.style.setProperty("--card-index", String(Math.min(i, 15)))` — same logic as original

Do NOT import anything from utils/dom.ts — ui.ts does not use getAttribute.

No behavioral changes. The TypeScript version must produce identical DOM effects.

Run `make typecheck` to verify zero errors across all files.
  </action>
  <verify>
    <automated>cd /home/chris/projects/sentinelx && make typecheck 2>&1 | tail -5</automated>
  </verify>
  <done>ui.ts exports init() with scroll-aware filter bar and card stagger; make typecheck passes with zero errors across all Phase 21 files</done>
</task>

</tasks>

<verification>
1. `make typecheck` exits 0 — all three new files pass strict TypeScript checking
2. `grep -r '!' app/static/src/ts/utils/ app/static/src/ts/modules/settings.ts app/static/src/ts/modules/ui.ts | grep -v '//'` returns no non-null assertions (only `!el` null checks, which are negations, not assertions)
3. `grep 'NodeJS' app/static/src/ts/utils/ app/static/src/ts/modules/` returns no results
4. Each file exports exactly one named export (attr for dom.ts, init for settings.ts and ui.ts)
</verification>

<success_criteria>
- utils/dom.ts: attr() helper exists, returns string, accepts Element + name + optional fallback
- settings.ts: init() function handles show/hide toggle with HTMLInputElement typing
- ui.ts: init() function handles scroll-aware filter bar and card stagger with typed DOM queries
- Zero TypeScript errors from make typecheck
- No non-null assertions anywhere in the new files
</success_criteria>

<output>
After completion, create `.planning/phases/21-simple-module-extraction/21-01-SUMMARY.md`
</output>
