---
phase: 03.1-integration-fixes-git-hygiene
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/static/main.js
  - app/templates/settings.html
  - .planning/phases/03-additional-ti-providers/03-01-SUMMARY.md
  - .planning/phases/03-additional-ti-providers/03-02-SUMMARY.md
  - .planning/v1.0-MILESTONE-AUDIT.md
autonomous: true

must_haves:
  truths:
    - "No inline <script> blocks exist in any Jinja2 template — all JavaScript lives in app/static/main.js"
    - "Show/Hide API key toggle on /settings page works via external main.js, not inline script"
    - "git status shows no untracked planning documents (v1.0-MILESTONE-AUDIT.md is committed)"
    - "Phase 3 SUMMARY.md files accurately describe the shared http_safety.py module, not per-adapter copies"
    - "Milestone audit report reflects current resolved status of integration items"
  artifacts:
    - path: "app/static/main.js"
      provides: "initSettingsPage() function for show/hide API key toggle"
      contains: "initSettingsPage"
    - path: "app/templates/settings.html"
      provides: "Settings template with NO inline script block"
    - path: ".planning/v1.0-MILESTONE-AUDIT.md"
      provides: "Updated milestone audit report with resolved integration items"
    - path: ".planning/phases/03-additional-ti-providers/03-01-SUMMARY.md"
      provides: "Corrected http_safety.py wording"
    - path: ".planning/phases/03-additional-ti-providers/03-02-SUMMARY.md"
      provides: "Corrected http_safety.py wording"
  key_links:
    - from: "app/templates/settings.html"
      to: "app/static/main.js"
      via: "script src tag in base.html loads main.js; initSettingsPage() activates on pages with #toggle-key-btn"
      pattern: "initSettingsPage"
---

<objective>
Fix the CSP regression from Phase 2's inline script in settings.html, correct Phase 3 SUMMARY.md documentation inaccuracies about per-adapter helper copies, and commit the milestone audit report with updated resolved status.

Purpose: Close all integration gaps identified by the v1.0 milestone audit — restore SEC-09 CSP compliance, clean the git working directory of planning documents, and ensure documentation accurately reflects the current codebase state.
Output: CSP-compliant settings page, accurate Phase 3 summaries, committed and updated audit report.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-integration-fixes-git-hygiene/03.1-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate inline script from settings.html to main.js (CSP fix)</name>
  <files>app/static/main.js, app/templates/settings.html</files>
  <action>
    **In `app/static/main.js`:**

    1. Add a new `initSettingsPage()` function INSIDE the existing IIFE, after `initExportButton()` (around line 377) and before the initialization block (around line 379). The function body:

    ```javascript
    // ---- Settings page: show/hide API key toggle ----

    function initSettingsPage() {
        var btn = document.getElementById('toggle-key-btn');
        var input = document.getElementById('api-key');
        if (!btn || !input) return;
        btn.addEventListener('click', function () {
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'Show';
            }
        });
    }
    ```

    2. Add `initSettingsPage();` to BOTH initialization branches:
       - In the DOMContentLoaded callback (after `initExportButton();` around line 386)
       - In the else branch (after `initExportButton();` around line 393)

    **Pattern:** Follow the existing init function pattern — guard with early return if page-specific DOM elements are missing. This ensures `initSettingsPage()` is safely called on every page but only activates on /settings.

    **In `app/templates/settings.html`:**

    3. Remove the entire inline `<script>...</script>` block (lines 64-80). Keep `{% endblock %}` on the last line. The template should end with `</div>` followed by a blank line and `{% endblock %}`.

    **What NOT to do:**
    - Do NOT modify any Jinja2 template logic (form, flash messages, etc.)
    - Do NOT use innerHTML anywhere — the existing code uses only `.type` and `.textContent` which are safe
    - Do NOT use arrow functions, template literals, or ES6+ syntax — match existing ES5 style in main.js
  </action>
  <verify>
    1. `grep -r '<script>' app/templates/` returns zero matches (no inline scripts in any template)
    2. `grep 'initSettingsPage' app/static/main.js` returns 3 matches (function definition + 2 init calls)
    3. `python3 -m pytest tests/ --ignore=tests/e2e -q` — all tests pass (no regressions)
    4. CSP header test: `python3 -c "from app import create_app; app = create_app(); c = app.test_client(); r = c.get('/'); print(r.headers.get('Content-Security-Policy'))"` — should include `script-src 'self'`
  </verify>
  <done>
    settings.html contains zero inline script blocks. main.js contains initSettingsPage() following the established guard pattern, called in both DOMContentLoaded branches. All existing tests pass. CSP header `script-src 'self'` is enforced and no template violates it.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix SUMMARY.md inaccuracies, commit and update milestone audit report</name>
  <files>.planning/phases/03-additional-ti-providers/03-01-SUMMARY.md, .planning/phases/03-additional-ti-providers/03-02-SUMMARY.md, .planning/v1.0-MILESTONE-AUDIT.md</files>
  <action>
    **In `03-01-SUMMARY.md`:**

    1. Line 48 — Replace the `patterns-established` entry:
       - OLD: `"Shared helper isolation: _validate_endpoint and _read_limited copied per-module (not extracted to shared utils) — deliberate isolation matches adapter-per-file pattern"`
       - NEW: `"Shared HTTP safety module: _validate_endpoint and _read_limited initially copied per-adapter; subsequently extracted to app/enrichment/http_safety.py (commit a716378) — adapters now import from the shared module"`

    2. Line 101 — Replace in body text:
       - OLD: `Helper functions (\`_validate_endpoint\`, \`_read_limited\`) copied into MBAdapter module for isolation — deliberate choice to keep adapters self-contained`
       - NEW: `Helper functions (\`_validate_endpoint\`, \`_read_limited\`) initially copied into MBAdapter module; subsequently extracted to shared \`app/enrichment/http_safety.py\` module (commit a716378) — adapters now import from the shared module`

    **In `03-02-SUMMARY.md`:**

    3. Line 23 — Replace the `patterns` entry in tech-stack:
       - OLD: `Per-adapter isolation: each adapter module copies _validate_endpoint and _read_limited helpers`
       - NEW: `Shared HTTP safety: _validate_endpoint and _read_limited initially per-adapter; extracted to app/enrichment/http_safety.py (commit a716378)`

    4. Line 94 — Replace in body text:
       - OLD: `**Per-adapter helper isolation**: Each adapter module contains its own copy of \`_validate_endpoint\` and \`_read_limited\` rather than a shared utilities module, matching the established VTAdapter pattern.`
       - NEW: `**Shared HTTP safety module**: Helper functions \`_validate_endpoint\` and \`_read_limited\` were initially per-adapter copies; subsequently extracted to \`app/enrichment/http_safety.py\` (commit a716378). Adapters now import from the shared module.`

    **Do NOT review other factual claims in either SUMMARY.md** — per user decision, fix only the flagged per-adapter helper wording.

    **In `.planning/v1.0-MILESTONE-AUDIT.md`:**

    5. Update the YAML frontmatter:
       - Change `status: gaps_found` to `status: resolved` (after Phase 3.1 closes all actionable gaps; UI-06 is Phase 4 scope)
       - Change `integration: 3/5` to `integration: 5/5`
       - Remove the two integration gap entries from `gaps.integration` (replace with empty list `[]`)
       - Update tech_debt items for phase 03: remove the items that are now resolved (ROADMAP checkboxes were already correct, SUMMARY.md wording is being fixed, uncommitted changes were resolved by commit a716378). Keep only items that remain unresolved, if any.

    6. Update the body text:
       - In "## Phase Verification Summary" table, update scores if needed
       - In "### Integration Issues (2 Critical)" section, mark both issues as RESOLVED with brief note: CSP fixed by migrating to main.js (Phase 3.1); http_safety.py tracked since commit a716378
       - Update the header line `**Status:** GAPS FOUND` to `**Status:** RESOLVED (except UI-06, Phase 4 scope)`
       - Update the Scores line to reflect `Integration 5/5`

    7. Commit the milestone audit report: `git add .planning/v1.0-MILESTONE-AUDIT.md`
  </action>
  <verify>
    1. `grep -c 'per-module\|per-adapter.*copies\|copied per' .planning/phases/03-additional-ti-providers/03-01-SUMMARY.md .planning/phases/03-additional-ti-providers/03-02-SUMMARY.md` — should return 0 for each file
    2. `grep 'http_safety.py' .planning/phases/03-additional-ti-providers/03-01-SUMMARY.md .planning/phases/03-additional-ti-providers/03-02-SUMMARY.md` — should return matches in both files
    3. `grep 'integration: 5/5' .planning/v1.0-MILESTONE-AUDIT.md` — should match
    4. `git status` — `.planning/v1.0-MILESTONE-AUDIT.md` should be tracked (no longer in untracked files)
  </verify>
  <done>
    Both Phase 3 SUMMARY.md files accurately describe the shared http_safety.py module instead of per-adapter helper copies. Milestone audit report is committed to git, reflects integration score 5/5, and marks the two critical integration issues as resolved. git status shows a clean working directory (excluding the unrelated everything-claude-code/ directory).
  </done>
</task>

</tasks>

<verification>
1. **CSP compliance**: `grep -r '<script>' app/templates/` returns zero matches
2. **JS function exists**: `grep -c 'initSettingsPage' app/static/main.js` returns 3 (definition + 2 init calls)
3. **Test suite green**: `python3 -m pytest tests/ --ignore=tests/e2e -q` — all tests pass
4. **Doc accuracy**: `grep -c 'per-module\|copied per-adapter\|per-adapter.*copies' .planning/phases/03-additional-ti-providers/03-0{1,2}-SUMMARY.md` returns 0
5. **Audit report committed**: `git log --oneline -1 -- .planning/v1.0-MILESTONE-AUDIT.md` shows a commit
6. **Clean tree**: `git status` shows only untracked `everything-claude-code/` (intentionally ignored)
</verification>

<success_criteria>
- Zero inline `<script>` blocks across all Jinja2 templates
- initSettingsPage() in main.js follows the established guard pattern
- All 221+ tests pass with no regressions
- Phase 3 SUMMARY.md files reference shared http_safety.py, not per-adapter copies
- Milestone audit report is tracked in git with resolved integration status
- git status shows clean working tree (only everything-claude-code/ untracked)
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-integration-fixes-git-hygiene/03.1-01-SUMMARY.md`
</output>
