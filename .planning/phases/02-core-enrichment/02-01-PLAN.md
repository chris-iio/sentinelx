---
phase: 02-core-enrichment
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - app/enrichment/__init__.py
  - app/enrichment/models.py
  - app/enrichment/adapters/__init__.py
  - app/enrichment/adapters/virustotal.py
  - app/enrichment/config_store.py
  - tests/test_enrichment_models.py
  - tests/test_vt_adapter.py
  - tests/test_config_store.py
autonomous: true
requirements: [ENRC-01, SEC-04, SEC-05, SEC-06, SEC-07]

must_haves:
  truths:
    - "VTAdapter.lookup(ioc) returns an EnrichmentResult for each supported IOC type (IP, domain, URL, hash)"
    - "VTAdapter.lookup(ioc) returns EnrichmentError for unsupported types (CVE)"
    - "VT 404 returns EnrichmentResult with verdict='no_data', not an error"
    - "All outbound requests enforce timeout=(5, 30), allow_redirects=False, and 1 MB response size cap"
    - "URL IOC lookup uses base64url-encoded identifier, never the raw URL as request target"
    - "ConfigStore reads/writes VT API key to ~/.sentinelx/config.ini"
    - "ALLOWED_API_HOSTS enforcement rejects requests to non-allowlisted hostnames"
  artifacts:
    - path: "app/enrichment/models.py"
      provides: "EnrichmentResult and EnrichmentError frozen dataclasses"
      contains: "class EnrichmentResult"
    - path: "app/enrichment/adapters/virustotal.py"
      provides: "VTAdapter with ENDPOINT_MAP, lookup(), HTTP safety controls"
      contains: "class VTAdapter"
    - path: "app/enrichment/config_store.py"
      provides: "ConfigStore for API key persistence"
      contains: "class ConfigStore"
    - path: "tests/test_vt_adapter.py"
      provides: "VT adapter unit tests with mocked HTTP"
      min_lines: 80
    - path: "tests/test_config_store.py"
      provides: "ConfigStore unit tests"
      min_lines: 20
  key_links:
    - from: "app/enrichment/adapters/virustotal.py"
      to: "app/pipeline/models.py"
      via: "imports IOC, IOCType"
      pattern: "from app\\.pipeline\\.models import"
    - from: "app/enrichment/adapters/virustotal.py"
      to: "app/enrichment/models.py"
      via: "returns EnrichmentResult or EnrichmentError"
      pattern: "EnrichmentResult|EnrichmentError"
    - from: "app/enrichment/adapters/virustotal.py"
      to: "www.virustotal.com"
      via: "requests.get to VT_BASE endpoints only"
      pattern: "VT_BASE.*=.*virustotal\\.com/api/v3"
---

<objective>
Build the enrichment data models, VirusTotal API v3 adapter with full HTTP safety controls, and API key config store — using TDD to prove correctness of endpoint mapping, response parsing, error handling, and security enforcement.

Purpose: Establish the typed enrichment foundation that the orchestrator (Plan 02) and routing (Plan 03) layers will depend on. Every HTTP safety requirement (SEC-04 through SEC-07) is implemented and tested here so no downstream code needs to worry about them.

Output: Tested VTAdapter, EnrichmentResult/EnrichmentError models, ConfigStore — all with >90% coverage.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-enrichment/02-RESEARCH.md

# Phase 1 artifacts this plan depends on:
@app/pipeline/models.py (IOC, IOCType — enrichment models reference these)
@app/config.py (ALLOWED_API_HOSTS — VT adapter enforces this)
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for enrichment models, VT adapter, and ConfigStore</name>
  <files>
    app/enrichment/__init__.py
    app/enrichment/models.py
    app/enrichment/adapters/__init__.py
    app/enrichment/adapters/virustotal.py
    app/enrichment/config_store.py
    tests/test_enrichment_models.py
    tests/test_vt_adapter.py
    tests/test_config_store.py
  </files>
  <action>
Create the enrichment package structure with minimal stubs (empty classes, `pass` bodies) so imports resolve but all tests FAIL.

**app/enrichment/models.py** — Create frozen dataclasses:
- `EnrichmentResult(ioc: IOC, provider: str, verdict: str, detection_count: int, total_engines: int, scan_date: str | None, raw_stats: dict)` — verdict is "malicious" | "clean" | "no_data"
- `EnrichmentError(ioc: IOC, provider: str, error: str)`
- Both frozen=True to match the immutability pattern from Phase 1

**tests/test_enrichment_models.py** — Write tests:
- EnrichmentResult is frozen (cannot mutate fields)
- EnrichmentError is frozen
- Both store IOC reference correctly

**tests/test_vt_adapter.py** — Write tests using `unittest.mock.patch` on `requests.Session.get`:
- `test_lookup_ipv4_success`: Mock 200 response with VT JSON, verify returns EnrichmentResult with verdict="malicious", correct detection_count, scan_date in ISO8601
- `test_lookup_domain_success`: Mock 200, verify correct endpoint path `/domains/{value}`
- `test_lookup_url_uses_base64_id`: Mock 200, verify request URL contains base64url-encoded URL ID (not the raw URL)
- `test_lookup_hash_sha256`: Mock 200, verify endpoint path `/files/{hash}`
- `test_lookup_cve_returns_error`: No mock needed — CVE type returns EnrichmentError("Unsupported type")
- `test_lookup_404_returns_no_data`: Mock 404 response, verify returns EnrichmentResult with verdict="no_data" (NOT EnrichmentError)
- `test_lookup_429_returns_rate_limit_error`: Mock 429, verify returns EnrichmentError with "Rate limit" message
- `test_lookup_401_returns_auth_error`: Mock 401, verify returns EnrichmentError with "Authentication error"
- `test_timeout_returns_error`: Mock raises `requests.exceptions.Timeout`, verify EnrichmentError
- `test_no_redirects_enforced`: Verify `allow_redirects=False` passed to requests.get (SEC-06)
- `test_timeout_params_enforced`: Verify `timeout=(5, 30)` passed (SEC-04)
- `test_stream_enabled`: Verify `stream=True` passed (SEC-05 setup)
- `test_response_size_limit`: Mock response with iter_content yielding >1MB, verify raises/returns error (SEC-05)
- `test_allowed_hosts_enforced`: Call with an IOC that would generate a non-allowlisted endpoint, verify rejection (SEC-07/SEC-16)

**tests/test_config_store.py** — Write tests:
- `test_get_vt_api_key_returns_none_when_no_config`: No config file exists, returns None
- `test_set_and_get_vt_api_key`: Write key, read back, verify match
- `test_set_vt_api_key_creates_directory`: Config dir doesn't exist, set_vt_api_key creates it
- Use `tmp_path` fixture to isolate from real filesystem

Create stub implementations in the source files (class declarations, method signatures, `raise NotImplementedError` bodies) so imports work but tests FAIL.

Run: `python -m pytest tests/test_enrichment_models.py tests/test_vt_adapter.py tests/test_config_store.py -v`
All tests MUST FAIL (red phase).
  </action>
  <verify>
`python -m pytest tests/test_enrichment_models.py tests/test_vt_adapter.py tests/test_config_store.py -v` — all tests fail (NotImplementedError or assertion failures). Zero passes.
  </verify>
  <done>Test files exist with comprehensive coverage of VT adapter behavior, HTTP safety controls, and ConfigStore. All tests fail against stubs.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN + REFACTOR — Implement VT adapter, models, and ConfigStore to pass all tests</name>
  <files>
    app/enrichment/models.py
    app/enrichment/adapters/virustotal.py
    app/enrichment/config_store.py
    app/config.py
  </files>
  <action>
Implement full production code to make all tests pass.

**app/enrichment/models.py** — Complete the frozen dataclasses (already stubbed, fill in fields).

**app/enrichment/adapters/virustotal.py** — Full implementation:
- `VT_BASE = "https://www.virustotal.com/api/v3"`
- `TIMEOUT = (5, 30)` — (connect, read) per SEC-04
- `MAX_RESPONSE_BYTES = 1 * 1024 * 1024` — 1 MB cap per SEC-05
- `ENDPOINT_MAP` dict mapping IOCType to lambda constructing URL path:
  - IPV4/IPV6 -> `/ip_addresses/{value}`
  - DOMAIN -> `/domains/{value}`
  - URL -> `/urls/{_url_id(value)}`
  - MD5/SHA1/SHA256 -> `/files/{value}`
  - CVE NOT in map
- `_url_id(url)` — `base64.urlsafe_b64encode(url.encode()).decode().strip("=")`
- `_read_limited(resp)` — `stream=True` + `iter_content(8192)` + byte counter, raise ValueError if >MAX_RESPONSE_BYTES, then json.loads
- `_validate_endpoint(url, allowed_hosts)` — parse hostname, check against allowed_hosts list, raise ValueError if not allowed (SEC-16)
- `VTAdapter.__init__(self, api_key, allowed_hosts)` — store api_key and allowed_hosts. Do NOT create a Session in __init__ (thread safety — see research Pitfall 3). Each `lookup()` call creates its own Session or uses thread-local state.
- `VTAdapter.lookup(self, ioc)` — build endpoint URL via ENDPOINT_MAP, validate against allowed_hosts, create a fresh requests.Session per call with `{"x-apikey": api_key, "Accept": "application/json"}` headers, call with `timeout=TIMEOUT, allow_redirects=False, stream=True`. Check 404 before raise_for_status (Pitfall 1). Parse with `_parse_response()`. Catch Timeout, HTTPError, generic Exception — return EnrichmentError for each.
- `_parse_response(ioc, body)` — Extract `data.attributes.last_analysis_stats` and `last_analysis_date`. Compute verdict: malicious>0 -> "malicious", total==0 -> "no_data", else -> "clean". Convert last_analysis_date from Unix epoch to ISO8601.
- `_map_http_error(ioc, err)` — 404 -> EnrichmentResult(verdict="no_data"), 429 -> EnrichmentError("Rate limit exceeded"), 401/403 -> EnrichmentError("Authentication error"), other -> EnrichmentError(f"HTTP {code}")

**app/enrichment/config_store.py** — Full implementation:
- `CONFIG_PATH = Path.home() / ".sentinelx" / "config.ini"` (outside repo tree — never committed)
- `ConfigStore.get_vt_api_key()` — read with configparser, return None if not found
- `ConfigStore.set_vt_api_key(key)` — create dir if needed, write with configparser
- Accept optional `config_path` parameter in __init__ for test isolation (tmp_path)

**app/config.py** — Update:
- `ALLOWED_API_HOSTS: list[str] = ["www.virustotal.com"]` (was empty in Phase 1)

Run: `python -m pytest tests/test_enrichment_models.py tests/test_vt_adapter.py tests/test_config_store.py -v`
All tests MUST PASS (green phase).

Then run full suite: `python -m pytest -v --tb=short`
Ensure no regressions in existing Phase 1 tests.

REFACTOR if needed: clean up any duplication, ensure all functions are <50 lines, verify naming is clear.
  </action>
  <verify>
`python -m pytest tests/test_enrichment_models.py tests/test_vt_adapter.py tests/test_config_store.py -v` — all pass.
`python -m pytest -v --tb=short` — full suite passes (no regressions).
`python -m pytest --cov=app/enrichment -v` — enrichment package coverage >90%.
  </verify>
  <done>VTAdapter correctly maps all IOC types to VT API v3 endpoints, enforces all HTTP safety controls (timeout, no redirects, response size cap, SSRF allowlist), handles 404 as "no_data", returns typed EnrichmentResult/EnrichmentError. ConfigStore persists API keys to ~/.sentinelx/config.ini. All tests green, no regressions.</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_vt_adapter.py -v` — all VT adapter tests pass
2. `python -m pytest tests/test_config_store.py -v` — all ConfigStore tests pass
3. `python -m pytest -v --tb=short` — full suite passes, no regressions
4. `python -m pytest --cov=app/enrichment` — >90% coverage on enrichment package
5. `grep -r "allow_redirects=False" app/enrichment/` — confirms SEC-06
6. `grep -r "timeout=" app/enrichment/` — confirms SEC-04
7. `grep -r "MAX_RESPONSE_BYTES" app/enrichment/` — confirms SEC-05
8. `grep -r "ALLOWED_API_HOSTS\|allowed_hosts" app/enrichment/` — confirms SEC-16/SEC-07
</verification>

<success_criteria>
- VTAdapter.lookup() returns correct EnrichmentResult for IP, domain, URL, hash IOCs
- VTAdapter.lookup() returns EnrichmentError for CVE IOCs
- VT 404 returns EnrichmentResult(verdict="no_data"), not an error
- All four HTTP safety controls enforced and tested (SEC-04, SEC-05, SEC-06, SEC-07)
- ConfigStore reads/writes API key to filesystem config file
- No regressions in Phase 1 tests
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-enrichment/02-01-SUMMARY.md`
</output>
