---
phase: 02-core-enrichment
plan: 04
type: execute
wave: 4
depends_on: [02-03]
files_modified:
  - app/templates/results.html
  - app/static/main.js
  - app/static/style.css
autonomous: false
requirements: [UI-05, ENRC-05]

must_haves:
  truths:
    - "Global progress bar shows 'N/M IOCs enriched' during online enrichment"
    - "Per-IOC spinner is visible while that IOC's enrichment is pending"
    - "Enrichment result appears inline under the IOC row as it arrives (incremental, not all-at-once)"
    - "Verdict badge is color-coded: red for malicious, green for clean, gray for no_data/unknown"
    - "Each enrichment line shows provider name, verdict, and scan date (ENRC-05)"
    - "Summary tally at IOC level: e.g. '1/1 malicious' — a count, not a combined score"
    - "Copy button copies IOC value plus enrichment summary in compact text format"
    - "Full export button exports all IOCs + enrichment at once"
    - "Error results show inline with clear provider-specific error message"
    - "Rate-limit or auth errors show a warning banner advising analyst"
  artifacts:
    - path: "app/templates/results.html"
      provides: "Enrichment display with verdict badges, progress bar, per-IOC spinners, export button"
      contains: "enrich-progress"
    - path: "app/static/main.js"
      provides: "Polling loop, incremental result rendering, copy-with-enrichment, export"
      contains: "pollEnrichment"
    - path: "app/static/style.css"
      provides: "Verdict badge colors, progress bar, spinner, enrichment row styles"
      contains: "verdict-badge"
  key_links:
    - from: "app/static/main.js"
      to: "/enrichment/status/{job_id}"
      via: "fetch polling loop every 750ms"
      pattern: "enrichment/status"
    - from: "app/static/main.js"
      to: "app/templates/results.html"
      via: "updates DOM elements (progress bar, IOC rows, verdict badges)"
      pattern: "getElementById.*enrich|querySelector.*ioc-row"
    - from: "app/templates/results.html"
      to: "app/static/main.js"
      via: "data-job-id attribute triggers polling on page load"
      pattern: "data-job-id"
---

<objective>
Build the enrichment display UI: global progress bar, per-IOC spinners, incremental verdict rendering via polling, color-coded verdict badges, copy-with-enrichment, and full export — then verify the complete Phase 2 end-to-end flow visually.

Purpose: This is the analyst-facing layer that makes enrichment results visible, responsive, and actionable. Without this, the backend enrichment system has no user interface.

Output: Fully functional enrichment UI with polling, incremental updates, verdict badges, copy/export, and visual verification.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-enrichment/02-CONTEXT.md

# Plan 03 outputs this plan depends on:
# (Read summary when available — need to know job_id attribute placement and JSON structure)

# Existing UI assets being modified:
@app/templates/results.html
@app/static/main.js
@app/static/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Results template enrichment structure and CSS</name>
  <files>
    app/templates/results.html
    app/static/style.css
  </files>
  <action>
**app/templates/results.html** — Extend for enrichment display:

1. Add `data-job-id="{{ job_id }}"` attribute to the `.page-results` div (only present in online mode when job_id is set). This triggers the JS polling loop.

2. Add `data-mode="{{ mode }}"` attribute to the `.page-results` div.

3. **Warning banner** (above progress bar, hidden by default):
- Add a div with class `enrich-warning`, id `enrich-warning`, initially hidden. JS populates it for rate-limit or auth warnings.

4. **Global progress bar** (only in online mode, before the results-grouped div):
- Wrap in a Jinja2 conditional: only render when `mode == "online" and job_id` is set.
- Container div `.enrich-progress` with id `enrich-progress`.
- Inside: `.enrich-progress-bar` div containing `.enrich-progress-fill` div (id `enrich-progress-fill`, initial width 0%).
- Text span `.enrich-progress-text` (id `enrich-progress-text`) showing "Enriching 0/{{ enrichable_count }} IOCs...".
- `enrichable_count` is a new template variable passed from the route (count of IOCs with types VT supports — excludes CVE).

5. **Export button** — Add after the results header (only in online mode):
- Button with class `btn btn-export`, id `export-btn`, type=button, starts disabled. JS enables it when enrichment completes.

6. **Per-IOC enrichment row** — Add a new `<tr>` below each IOC table row:
- Class `ioc-enrichment-row`, with `data-ioc-value="{{ ioc.value }}"`.
- Single `<td colspan="3">` containing a div `.enrichment-slot`.
- In online mode: slot contains a spinner span (`.enrichment-spinner`) and pending text span. JS replaces this content with verdict data as results arrive.
- In offline mode: enrichment row is not rendered (wrap in Jinja2 conditional).

7. **Update copy button** — Add `data-ioc-type="{{ ioc.type.value }}"` to each copy button so JS can include enrichment data in copy text.

**app/static/style.css** — Add enrichment styles:

- `.enrich-progress` — Full-width bar container, fixed height (6px), rounded, background var(--bg-tertiary)
- `.enrich-progress-fill` — Gradient fill (left to right), animated width transition (0.3s ease), accent color
- `.enrich-progress-text` — Small text below progress bar showing "N/M IOCs enriched"
- `.enrich-progress.complete .enrich-progress-fill` — Green fill when complete
- `.enrichment-spinner` — CSS-only spinning circle using border animation, 16px, inline-block
- `.enrichment-slot` — Container for enrichment content under each IOC row, padding-left indent
- `.verdict-badge` — Inline pill/badge with border-radius, padding 2px 8px, small font, monospace
- `.verdict-malicious` — Red background (e.g., rgba(215, 58, 74, 0.2) with #f85149 text for dark theme)
- `.verdict-clean` — Green background (e.g., rgba(40, 167, 69, 0.2) with #3fb950 text)
- `.verdict-no_data` — Gray background (e.g., rgba(108, 117, 125, 0.2) with #8b949e text)
- `.verdict-error` — Orange/amber background (e.g., rgba(227, 98, 9, 0.2) with #d29922 text)
- `.enrichment-summary` — Small summary text, muted color
- `.enrichment-detail` — Provider attribution text
- `.ioc-enrichment-row` — No top border (seamless with IOC row above), slightly indented left
- `.enrich-warning` — Yellow/amber banner, padding, border-radius, margin-bottom
- `.btn-export` — Export button styling consistent with existing btn-secondary pattern
  </action>
  <verify>
Manual: Open `app/templates/results.html` and verify all new elements are present, properly nested, and use correct Jinja2 conditionals.
`python -m pytest tests/test_routes.py -v` — existing route tests still pass (new HTML structure does not break existing rendering).
  </verify>
  <done>Results template has enrichment structure: progress bar, per-IOC enrichment rows with spinners, verdict badge markup, warning banner, export button. CSS defines all enrichment visual styles. Existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: JavaScript polling loop, incremental rendering, copy-with-enrichment, and export</name>
  <files>
    app/static/main.js
  </files>
  <action>
**app/static/main.js** — Add enrichment polling and rendering. Follow existing code style: `var` not `let`/`const`, no arrow functions, no template literals, IIFE wrapper.

**XSS SAFETY (CRITICAL):** All API response data rendered into the DOM MUST be sanitized. Use safe DOM methods: create elements with `document.createElement`, set text with `.textContent`, then append. Do NOT concatenate strings into raw HTML. Use `textContent` for all dynamic values to prevent XSS from API response fields (SEC-08 extension to JavaScript).

1. **initEnrichmentPolling():**
- Find `.page-results` div, read `data-job-id` and `data-mode` attributes.
- If no job_id or mode is not "online", return early.
- Track rendered IOC values in an object to avoid re-rendering.
- Set up `setInterval` at 750ms that calls `fetch('/enrichment/status/' + jobId)`.
- On response: update progress bar, render new results (skip already-rendered), check for warning-worthy errors.
- On complete: clear interval, call `markEnrichmentComplete()`.
- On fetch error: silently continue (retry on next interval).

2. **updateProgressBar(done, total):**
- Find progress fill element by id, set `style.width` to percentage.
- Find progress text element, set `textContent` to `done + '/' + total + ' IOCs enriched'`.

3. **renderEnrichmentResult(result):**
- Find the `.ioc-enrichment-row` element matching `data-ioc-value`.
- Find the `.enrichment-slot` inside it.
- Clear the slot content (remove spinner).
- Build DOM nodes using safe methods (createElement + textContent):
  - Create verdict badge span: `document.createElement('span')`, set className to `verdict-badge verdict-{verdict}`, set textContent to the verdict string.
  - Create detail span: `document.createElement('span')`, set className to `enrichment-detail`.
  - For result type: detail textContent = `{provider}: {verdictText} — Scanned {formattedDate}`
    where verdictText is `{detection_count}/{total_engines} malicious` for malicious, `Clean` for clean, `No data` for no_data.
  - For error type: badge textContent = `Error`, detail textContent = `{provider}: {error}`.
  - Append badge and detail spans to slot using `appendChild`.
- Store enrichment summary on the copy button via `setAttribute('data-enrichment', summary)`.

4. **formatDate(iso):**
- Try `new Date(iso).toLocaleDateString()`, fall back to raw string.

5. **markEnrichmentComplete():**
- Add 'complete' class to progress bar container.
- Update progress text to "Enrichment complete".
- Enable export button (remove disabled attribute).

6. **showEnrichWarning(message):**
- Find warning banner by id.
- Set display to 'block'.
- Set textContent to: `Warning: {message} — Consider using offline mode or checking your API key in Settings.`

7. **Update initCopyButtons():**
- In the existing copy click handler, check for `data-enrichment` attribute on the button.
- If present, copy format: `{ioc_value} | {enrichment_summary}` (per user decision: compact text for pasting into tickets).
- If not present (offline mode), copy just the IOC value as before.

8. **initExportButton():**
- Find export button by id, attach click handler.
- On click: iterate all `.ioc-row` elements, for each:
  - Get IOC value from `.ioc-value` textContent.
  - Get enrichment from the matching copy button's `data-enrichment` attribute.
  - Build line: `{ioc_value} | {enrichment}` (or just `{ioc_value}` if no enrichment).
- Join lines with newline, copy to clipboard using existing clipboard pattern.

9. **Wire initialization:** Add `initEnrichmentPolling()` and `initExportButton()` to the existing DOMContentLoaded handler alongside `initSubmitButton()` and `initCopyButtons()`.
  </action>
  <verify>
`python -m pytest tests/test_routes.py -v` — existing tests still pass.
Manual review: Verify NO use of raw string concatenation into DOM. All dynamic content uses createElement + textContent pattern.
`grep -c "textContent" app/static/main.js` — verify textContent used for all dynamic content.
Verify no `.innerHTML` assignments with unsanitized data.
  </verify>
  <done>
- Polling loop fetches /enrichment/status/{job_id} every 750ms
- Progress bar updates incrementally ("N/M IOCs enriched")
- Per-IOC spinners replaced with verdict badges as results arrive (safe DOM methods, no XSS risk)
- Verdict badges color-coded: red/green/gray per user decision
- Rate-limit/auth errors show warning banner
- Copy button includes enrichment summary in compact text format (user decision)
- Export button exports all IOCs + enrichment to clipboard
- All dynamic content rendered via textContent (SEC-08 safety)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual and functional verification of complete Phase 2</name>
  <files>app/templates/results.html, app/static/main.js, app/static/style.css</files>
  <action>
Human visual verification of the complete Phase 2 enrichment system:
- Settings page where analyst pastes VT API key
- Online mode in /analyze that fires parallel VT enrichment
- Global progress bar + per-IOC spinners during enrichment
- Color-coded verdict badges (red/green/gray) with provider attribution
- Copy-with-enrichment and full export buttons
- Error handling with warning banners for rate limits/auth issues
- Offline mode unchanged from Phase 1

Verification steps:
1. Start the app: `source .venv/bin/activate && python run.py`
2. Visit http://127.0.0.1:5000/settings — verify settings page renders with VT API key form, optional save test
3. Visit http://127.0.0.1:5000/ — select Online mode without API key, submit — verify redirect to settings
4. (If real key available) Configure key, submit online with: `8.8.8.8 hxxps://evil[.]example[.]com/payload 44d88612fea8a8f36de82e1278abb02f` — verify progress bar, spinners, verdict badges, copy, export
5. Select Offline mode with same text — verify no enrichment UI (regression check)
6. Check dark theme consistency, settings nav link, no JS console errors
  </action>
  <verify>Human confirms all verification steps pass. Type "approved" or describe issues.</verify>
  <done>Phase 2 visual verification approved: enrichment UI, settings page, online/offline modes, verdict badges, copy/export all confirmed working.</done>
</task>

</tasks>

<verification>
1. `python -m pytest -v --tb=short` — full suite passes
2. Visual verification: progress bar, verdict badges, copy/export all work
3. Offline mode regression: unchanged from Phase 1
4. JS console: no errors in browser developer tools
5. `grep -c "textContent" app/static/main.js` — verify safe DOM methods used for all dynamic content
</verification>

<success_criteria>
- Global progress bar shows enrichment progress (UI-05)
- Per-IOC spinners visible during pending enrichment (UI-05)
- Results arrive incrementally via polling (user decision: "results appearing incrementally")
- Verdict badges color-coded: red/green/gray (user decision)
- Each result shows provider name, verdict, scan date (ENRC-05)
- Summary tally at IOC level (user decision)
- Copy includes enrichment summary (user decision)
- Export button exports all IOCs + enrichment (user decision)
- Offline mode completely unchanged
- Human visual verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-enrichment/02-04-SUMMARY.md`
</output>
