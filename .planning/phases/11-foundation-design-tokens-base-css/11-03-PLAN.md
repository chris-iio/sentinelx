---
phase: 11-foundation-design-tokens-base-css
plan: 03
type: execute
wave: 3
depends_on:
  - "11-02"
files_modified:
  - app/static/src/input.css
autonomous: false
requirements:
  - FOUND-05

must_haves:
  truths:
    - "Every text/background token pair passes WCAG AA: 4.5:1 for normal text, 3:1 for UI components"
    - "All IOC value displays render in JetBrains Mono Variable (verifiable by inspecting font-family in DevTools)"
    - "All UI chrome text renders in Inter Variable (verifiable by inspecting font-family in DevTools)"
    - "Browser scrollbar renders in dark mode — no light scrollbar on dark background"
    - "Settings API key field does not produce yellow autofill flash after filling and refreshing"
  artifacts:
    - path: "app/static/src/input.css"
      provides: "WCAG AA verified design token system — all contrast ratios confirmed"
  key_links:
    - from: ":root token values"
      to: "WCAG AA 4.5:1 / 3:1 thresholds"
      via: "contrast ratio calculation on each foreground/background pair"
      pattern: "contrast.*ratio"
---

<objective>
Verify all text/background token pairs pass WCAG AA contrast requirements, and confirm the complete font and dark-mode infrastructure works end-to-end in the browser.

Purpose: This is the Phase 11 gate criterion. No component work in Phase 12 can begin until every token pair is verified. Catching contrast failures here prevents rework on components built atop incorrect tokens.

Output: A verified contrast audit (all pairs pass), confirmed font loading, confirmed dark browser signals, and any token value adjustments needed to pass WCAG AA.
</objective>

<execution_context>
@/home/chris/.claude/get-shit-done/workflows/execute-plan.md
@/home/chris/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-foundation-design-tokens-base-css/11-RESEARCH.md
@.planning/phases/11-foundation-design-tokens-base-css/11-02-SUMMARY.md
@app/static/src/input.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated WCAG AA contrast verification of all token pairs</name>
  <files>app/static/src/input.css</files>
  <action>
Write and run a Python script that calculates WCAG contrast ratios for all critical token pairs. The script should use the standard WCAG relative luminance formula:

```python
def relative_luminance(hex_color):
    """Calculate relative luminance per WCAG 2.1."""
    r, g, b = int(hex_color[1:3], 16)/255, int(hex_color[3:5], 16)/255, int(hex_color[5:7], 16)/255
    r = r/12.92 if r <= 0.04045 else ((r+0.055)/1.055)**2.4
    g = g/12.92 if g <= 0.04045 else ((g+0.055)/1.055)**2.4
    b = b/12.92 if b <= 0.04045 else ((b+0.055)/1.055)**2.4
    return 0.2126*r + 0.7152*g + 0.0722*b

def contrast_ratio(fg, bg):
    l1 = relative_luminance(fg)
    l2 = relative_luminance(bg)
    lighter = max(l1, l2)
    darker = min(l1, l2)
    return (lighter + 0.05) / (darker + 0.05)
```

**Token pairs to verify (from 11-RESEARCH.md):**

| Foreground | Background | Min Ratio | Category |
|-----------|-----------|-----------|----------|
| #f4f4f5 (text-primary) | #09090b (bg-primary) | 4.5:1 | Normal text |
| #f4f4f5 (text-primary) | #18181b (bg-secondary) | 4.5:1 | Normal text (card) |
| #a1a1aa (text-secondary) | #09090b (bg-primary) | 4.5:1 | Normal text (labels) |
| #a1a1aa (text-secondary) | #18181b (bg-secondary) | 4.5:1 | Normal text (card labels) |
| #71717a (text-muted) | #09090b (bg-primary) | 3:1 | UI components (placeholder) |
| #71717a (text-muted) | #18181b (bg-secondary) | 3:1 | UI components |
| #10b981 (accent) | #09090b (bg-primary) | 3:1 | UI components (buttons) |
| #f87171 (verdict-malicious-text) | #450a0a (verdict-malicious-bg) | 4.5:1 | Badge text |
| #fbbf24 (verdict-suspicious-text) | #451a03 (verdict-suspicious-bg) | 4.5:1 | Badge text |
| #34d399 (verdict-clean-text) | #022c22 (verdict-clean-bg) | 4.5:1 | Badge text |
| #a1a1aa (verdict-no-data-text) | #27272a (verdict-no-data-bg) | 4.5:1 | Badge text |
| #4a9eff (accent-ipv4) | #18181b (bg-secondary) | 3:1 | IOC type badge |
| #4aff9e (accent-domain) | #18181b (bg-secondary) | 3:1 | IOC type badge |
| #4aeeee (accent-url) | #18181b (bg-secondary) | 3:1 | IOC type badge |
| #ff9e4a (accent-md5) | #18181b (bg-secondary) | 3:1 | IOC type badge |
| #ff4a4a (accent-cve) | #18181b (bg-secondary) | 3:1 | IOC type badge |

Run the script. It should output each pair, its computed ratio, and PASS/FAIL status.

**If any pair FAILS:**
- For text tokens: bump to the next brighter zinc step (e.g., zinc-500 → zinc-400)
- For accent tokens: bump to the Tailwind -400 variant (brighter)
- For verdict tokens: bump text to the -300 variant
- Update the failed token value in the :root block of input.css
- Re-run `make css` after changes
- Re-run the contrast script to confirm the fix

**If ALL pairs PASS:** No CSS changes needed; proceed to the human verification checkpoint.

Delete the temporary contrast script after use — do not commit it.
  </action>
  <verify>
    <automated>python3 -c "
def rl(h):
    r,g,b=int(h[1:3],16)/255,int(h[3:5],16)/255,int(h[5:7],16)/255
    r=r/12.92 if r<=0.04045 else ((r+0.055)/1.055)**2.4
    g=g/12.92 if g<=0.04045 else ((g+0.055)/1.055)**2.4
    b=b/12.92 if b<=0.04045 else ((b+0.055)/1.055)**2.4
    return 0.2126*r+0.7152*g+0.0722*b
def cr(f,b):
    l1,l2=rl(f),rl(b);return (max(l1,l2)+0.05)/(min(l1,l2)+0.05)
pairs=[('#f4f4f5','#09090b',4.5),('#f4f4f5','#18181b',4.5),('#a1a1aa','#09090b',4.5),('#a1a1aa','#18181b',4.5),('#71717a','#09090b',3.0),('#10b981','#09090b',3.0),('#f87171','#450a0a',4.5),('#fbbf24','#451a03',4.5),('#34d399','#022c22',4.5),('#a1a1aa','#27272a',4.5)]
ok=True
for f,b,m in pairs:
    r=cr(f,b);s='PASS' if r>=m else 'FAIL';print(f'{f} on {b}: {r:.1f}:1 ({s}, need {m}:1)')
    if r<m: ok=False
print('ALL PASS' if ok else 'SOME FAIL')
"</automated>
  </verify>
  <done>All text/background token pairs achieve WCAG AA contrast ratios — 4.5:1+ for normal text and 3:1+ for UI components — verified via automated contrast calculation script. Any failures have been corrected in the :root token values.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of Phase 11 foundation</name>
  <files>app/static/src/input.css, app/templates/base.html, tailwind.config.js</files>
  <action>
Human verifies the complete Phase 11 foundation in the browser.

What was built: zinc/emerald/teal design token system, self-hosted Inter Variable and JetBrains Mono Variable fonts, dark-mode browser signals (color-scheme meta + CSS), autofill override, @tailwindcss/forms plugin, WCAG AA verified contrast.

Steps to verify:
1. Start the Flask dev server: `python run.py` (or `flask run`)
2. Open http://127.0.0.1:5000 in the browser

Font verification (FOUND-02, FOUND-03):
3. On the input page, right-click the "SentinelX" header text, Inspect, Computed tab, look for font-family. It should show "Inter Variable" (not -apple-system or Segoe UI).
4. Right-click the textarea placeholder text, Inspect, Computed tab, font-family should show "JetBrains Mono Variable" (not Fira Code or Consolas).
5. Navigate to results page (paste any IP like "8.8.8.8" and submit). Right-click an IOC value, Inspect, font-family should show "JetBrains Mono Variable".
6. Open DevTools Network tab, Reload, Filter by "Font", Confirm InterVariable.woff2 and JetBrainsMonoVariable.woff2 both load with status 200.

Dark mode verification (FOUND-04):
7. Scroll the results page to verify the browser scrollbar is dark (not a bright light scrollbar).
8. If there is a select element on the settings page, verify it renders with a dark background.

Color palette verification (FOUND-01):
9. The page background should be very dark (zinc-950, #09090b), NOT the blue-tinted dark (#0d1117) from before.
10. Cards should have a slightly lighter dark surface (zinc-900, #18181b).
11. Borders should be very subtle white-opacity lines.

Autofill verification (FOUND-06):
12. Go to Settings page, type something in the API key field, submit, go back.
13. If the browser offers to autofill the field, verify it does NOT flash yellow.

Typography scale verification (FOUND-08):
14. Inspect any heading, verify font-weight is 600.
15. Inspect body text, verify font-weight is 400 (or default).
  </action>
  <verify>Human visual inspection in browser — type "approved" or describe issues found</verify>
  <done>Human has verified: fonts load correctly, dark-mode signals work, zinc palette is applied, no autofill yellow flash, typography weights are correct</done>
</task>

</tasks>

<verification>
1. Automated Python script confirms all token pairs pass WCAG AA contrast thresholds
2. Human verifies Inter Variable loads on UI chrome text
3. Human verifies JetBrains Mono Variable loads on IOC values
4. Human verifies dark scrollbar and native controls
5. Human verifies no autofill yellow flash
6. Human verifies zinc palette (not blue-gray) on backgrounds
7. Human confirms fonts in Network tab (status 200)
</verification>

<success_criteria>
- All 10+ token pairs pass WCAG AA (4.5:1 normal text, 3:1 UI components)
- Inter Variable renders on UI text
- JetBrains Mono Variable renders on IOC values
- Dark scrollbar on all pages
- No autofill yellow flash on settings page
- Human approval received
</success_criteria>

<output>
After completion, create `.planning/phases/11-foundation-design-tokens-base-css/11-03-SUMMARY.md`
</output>
